<aside
  class="assistant-panel glass-card"
  *ngIf="assistantVisible()"
  [class.collapsed]="assistantCollapsed()"
  cdkDrag
>
  <div class="assistant-header" cdkDragHandle>
    <div class="assistant-title">
      <span class="assistant-icon">
        <i class="pi pi-bolt"></i>
      </span>
      <div>
        <h3>AI Assistant</h3>
      </div>
    </div>
    <div class="assistant-controls">
      <button
        type="button"
        class="assistant-history"
        [disabled]="historyLoading()"
        (click)="loadHistory()"
      >
        {{ historyLoaded() ? 'History loaded' : historyLoading() ? 'Loading…' : 'View history' }}
      </button>
      <button type="button" class="assistant-control" (click)="toggleAssistantCollapsed()">
        <i class="pi" [class.pi-minus]="!assistantCollapsed()" [class.pi-plus]="assistantCollapsed()"></i>
      </button>
      <button type="button" class="assistant-control" (click)="hideAssistant()">
        <i class="pi pi-times"></i>
      </button>
    </div>
  </div>
  <div class="assistant-body">
        <div class="assistant-message">
          <span class="assistant-role">Assistant</span>
          <div class="assistant-content" [innerHTML]="formatAssistantMessage(assistantGreeting())"></div>
        </div>
        <div
          class="assistant-message"
          *ngFor="let message of assistantMessages()"
          [class.user]="message.role === 'user'"
        >
          <span class="assistant-role">{{ message.role === 'user' ? 'You' : 'Assistant' }}</span>
          <div class="assistant-content" [innerHTML]="formatAssistantMessage(message.displayContent ?? message.content)"></div>
        </div>
        <div class="assistant-message" *ngIf="assistantError()">
          <span class="assistant-role">Assistant</span>
          <div class="assistant-content">{{ assistantError() }}</div>
        </div>
        <div class="assistant-message" *ngIf="assistantInfo()">
          <span class="assistant-role">Assistant</span>
          <div class="assistant-content">{{ assistantInfo() }}</div>
        </div>

        <section class="assistant-actions" *ngIf="assistantActions().length">
          <div class="assistant-actions-title">Suggested actions</div>
          <article class="assistant-action-item" *ngFor="let action of assistantActions()">
            <div class="assistant-action-content">
              <h4>{{ action.title }}</h4>
              <p>{{ action.description }}</p>
              <div class="assistant-action-meta">
                <span>{{ action.ownerScope }}</span>
                <span>{{ action.dueWindow }}</span>
              </div>
            </div>
            <button type="button" class="assistant-action-btn" (click)="openAssistantAction(action)">
              {{ assistantActionLabel(action) }}
            </button>
          </article>
        </section>
      </div>
  <div class="assistant-input">
    <input
      type="text"
      placeholder="Ask AI Assistant…"
      [disabled]="assistantSending()"
      [ngModel]="assistantInput()"
      (ngModelChange)="assistantInput.set($event)"
      (keydown)="onAssistantInputKeydown($event)"
    />
    <button type="button" class="assistant-send" [disabled]="assistantSending()" (click)="sendAssistantMessage()">
      <i class="pi pi-send"></i>
    </button>
  </div>

  <section class="assistant-undo-strip" *ngIf="assistantUndoVisible">
    <span>{{ assistantUndoMessage }}</span>
    <button type="button" [disabled]="assistantUndoBusy" (click)="undoAssistantAction()">Undo</button>
  </section>

  <div class="assistant-review-backdrop" *ngIf="assistantReviewDialogOpen">
    <div class="assistant-review-dialog">
      <h4>Review Assistant Action</h4>
      <p>This action is medium/high risk and needs review before execution.</p>
      <textarea
        rows="4"
        [disabled]="assistantReviewSubmitting"
        placeholder="Add review note (optional)"
        [ngModel]="assistantReviewNote"
        (ngModelChange)="assistantReviewNote = $event"
      ></textarea>
      <div class="assistant-review-actions">
        <button type="button" [disabled]="assistantReviewSubmitting" (click)="cancelAssistantReview()">Cancel</button>
        <button type="button" [disabled]="assistantReviewSubmitting" (click)="submitAssistantReview(false)">Reject</button>
        <button type="button" [disabled]="assistantReviewSubmitting" (click)="submitAssistantReview(true)">Approve & Execute</button>
      </div>
    </div>
  </div>
</aside>
