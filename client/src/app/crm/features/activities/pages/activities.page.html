<div class="page-background">
  <div class="animated-orb orb-1"></div>
  <div class="animated-orb orb-2"></div>
  <div class="animated-orb orb-3"></div>
  <div class="grid-pattern"></div>
</div>

<div class="page-container">
  <div class="page-content">
    <!-- PrimeNG Breadcrumb -->
    <app-breadcrumbs></app-breadcrumbs>

    <!-- Page Header -->
    <header class="page-header">
      <div class="header-left">
        <h1 class="page-title">
          <i class="pi pi-calendar gradient-icon"></i>
          <span class="title-gradient">Activities</span>
          <span class="title-light">Workspace</span>
          <span class="title-count">{{ total() }}</span>
        </h1>
      </div>
      <div class="header-right">
        <div class="view-toggle">
          <button pButton type="button" class="toggle-btn" [class.active]="currentView() === 'table'" (click)="setView('table')" title="Table View">
            <i class="pi pi-list"></i>
          </button>
          <button pButton type="button" class="toggle-btn" [class.active]="currentView() === 'calendar'" (click)="setView('calendar')" title="Calendar View">
            <i class="pi pi-calendar"></i>
          </button>
          <button pButton type="button" class="toggle-btn" [class.active]="currentView() === 'tasks'" (click)="setView('tasks')" title="Tasks View">
            <i class="pi pi-check-square"></i>
          </button>
        </div>
        <button pButton type="button" class="btn-icon" (click)="load()" title="Refresh">
          <i class="pi pi-refresh"></i>
        </button>
        <button pButton type="button" class="btn-primary" [disabled]="!canManage()" (click)="onCreate()">
          <i class="pi pi-plus"></i>
          <span>Add Activity</span>
        </button>
      </div>
    </header>

    <!-- KPI Strip -->
    <section class="kpi-strip">
      <div class="kpi-card">
        <div class="kpi-icon total">
          <i class="pi pi-inbox"></i>
        </div>
        <div class="kpi-data">
          <span class="kpi-value">{{ total() }}</span>
          <span class="kpi-label">Total</span>
        </div>
      </div>
      <div class="kpi-divider"></div>
      <button pButton type="button" class="kpi-card clickable" [class.active]="statusFilter === 'Upcoming'" (click)="onStatusChange('Upcoming')">
        <div class="kpi-icon upcoming">
          <i class="pi pi-clock"></i>
        </div>
        <div class="kpi-data">
          <span class="kpi-value">{{ openActivitiesCount() }}</span>
          <span class="kpi-label">Open</span>
        </div>
      </button>
      <button pButton type="button" class="kpi-card clickable" [class.active]="isDueTodayActive" (click)="toggleDueToday()">
        <div class="kpi-icon duetoday">
          <i class="pi pi-calendar-clock"></i>
        </div>
        <div class="kpi-data">
          <span class="kpi-value">{{ dueTodayCount() }}</span>
          <span class="kpi-label">Due Today</span>
        </div>
        <span class="kpi-badge info" *ngIf="dueTodayCount() > 0">!</span>
      </button>
      <button pButton type="button" class="kpi-card clickable" [class.active]="overdueOnly()" (click)="toggleOverdue()">
        <div class="kpi-icon overdue">
          <i class="pi pi-exclamation-circle"></i>
        </div>
        <div class="kpi-data">
          <span class="kpi-value">{{ overdueCount() }}</span>
          <span class="kpi-label">Overdue</span>
        </div>
        <span class="kpi-badge danger" *ngIf="overdueCount() > 0">!</span>
      </button>
      <div class="kpi-divider"></div>
      <button pButton type="button" class="kpi-card clickable" [class.active]="statusFilter === 'Completed'" (click)="onStatusChange('Completed')">
        <div class="kpi-icon completed">
          <i class="pi pi-check-circle"></i>
        </div>
        <div class="kpi-data">
          <span class="kpi-value">{{ completedCount() }}</span>
          <span class="kpi-label">Done</span>
        </div>
        <span class="kpi-badge success" *ngIf="completionRate() > 0">{{ completionRate() }}%</span>
      </button>
    </section>

    <!-- Toolbar -->
    <section class="toolbar-section">
      <div class="toolbar glass-card">
        <div class="toolbar-left">
          <div class="search-box">
            <i class="pi pi-search"></i>
            <input pInputText type="text" placeholder="Search activities..." [(ngModel)]="searchQuery" (ngModelChange)="onSearch($event)" />
          </div>
          <div class="filter-pills">
            <button pButton type="button" class="pill" [class.active]="typeFilter === 'all'" (click)="onTypeChange('all')">All</button>
            <button pButton type="button" class="pill" [class.active]="typeFilter === 'Call'" (click)="onTypeChange('Call')">
              <i class="pi pi-phone"></i> Calls
            </button>
            <button pButton type="button" class="pill" [class.active]="typeFilter === 'Email'" (click)="onTypeChange('Email')">
              <i class="pi pi-envelope"></i> Emails
            </button>
            <button pButton type="button" class="pill" [class.active]="typeFilter === 'Meeting'" (click)="onTypeChange('Meeting')">
              <i class="pi pi-users"></i> Meetings
            </button>
            <button pButton type="button" class="pill" [class.active]="typeFilter === 'Task'" (click)="onTypeChange('Task')">
              <i class="pi pi-check-square"></i> Tasks
            </button>
          </div>
        </div>
        <div class="toolbar-right">
          <p-select appendTo="body"
            [options]="groupByOptions"
            optionLabel="label"
            optionValue="value"
            [ngModel]="groupBy"
            (ngModelChange)="onGroupByChange($event)"
            placeholder="Group by"
            styleClass="filter-select"
          ></p-select>
          <p-select appendTo="body"
            [options]="ownerOptions()"
            optionLabel="label"
            optionValue="value"
            [ngModel]="activeOwnerFilter"
            (ngModelChange)="onOwnerFilterChange($event)"
            placeholder="All Owners"
            styleClass="filter-select"
            [disabled]="!canManage()"
          ></p-select>
          <button pButton type="button" class="pill toggle" [class.active]="myView()" (click)="toggleMine()">
            <i class="pi pi-user"></i> Mine
          </button>
        </div>
      </div>
    </section>

    <!-- Activities Table -->
    <section class="table-section" *ngIf="currentView() === 'table'">
      <div class="data-table-wrapper glass-card">
        <ng-container *ngIf="!loading(); else loadingState">
          <ng-container *ngIf="groupBy !== 'none'; else flatTableView">
            <ng-container *ngIf="groupBy === 'lead'; else opportunityGroupedView">
            <ng-container *ngIf="leadGroupedActivities().length; else emptyState">
              <div class="grouped-activities">
                <div class="grouped-activities__summary">
                  <span class="grouped-activities__label">Grouped by Lead</span>
                  <span class="grouped-activities__count">{{ groupedLeadActivityCount() }} lead{{ groupedLeadActivityCount() === 1 ? '' : 's' }}</span>
                </div>

                <div class="lead-group-card" *ngFor="let group of leadGroupedActivities()">
                  <div class="lead-group-card__header">
                    <div class="lead-group-card__identity">
                      <div class="lead-group-card__title-row">
                        <span class="lead-group-card__title">{{ group.leadName }}</span>
                        <a
                          class="lead-group-card__lead-link"
                          [routerLink]="['/app/leads', group.leadId, 'edit']"
                          (click)="$event.stopPropagation()"
                        >
                          <i class="pi pi-link"></i>
                          Open Lead
                        </a>
                      </div>
                      <div class="lead-group-card__meta">
                        <span>{{ group.items.length }} activit{{ group.items.length === 1 ? 'y' : 'ies' }}</span>
                        <span *ngIf="group.lastActivityAt">• Last activity {{ asLocalDate(group.lastActivityAt) | date:'MMM d, h:mm a' }}</span>
                      </div>
                    </div>
                    <div class="lead-group-card__stats">
                      <span class="group-chip neutral">Open {{ group.openCount }}</span>
                      <span class="group-chip success">Done {{ group.completedCount }}</span>
                      <span class="group-chip danger" *ngIf="group.overdueCount">Overdue {{ group.overdueCount }}</span>
                    </div>
                  </div>

                  <div class="lead-group-card__items">
                    <button
                      type="button"
                      class="lead-group-activity"
                      *ngFor="let row of group.items"
                      (click)="canManage() ? onEdit(row) : null"
                    >
                      <div class="lead-group-activity__left">
                        <span class="type-badge" [attr.data-type]="row.type">
                          <i class="pi"
                             [class.pi-phone]="row.type === 'Call'"
                             [class.pi-envelope]="row.type === 'Email'"
                             [class.pi-users]="row.type === 'Meeting'"
                             [class.pi-check-square]="row.type === 'Task'"></i>
                          {{ row.type }}
                        </span>
                        <span class="lead-group-activity__subject">{{ row.subject }}</span>
                      </div>
                      <div class="lead-group-activity__right">
                        <span class="status-chip"
                              [class.upcoming]="row.status === 'Upcoming'"
                              [class.completed]="row.status === 'Completed'"
                              [class.overdue]="row.status === 'Overdue'">
                          {{ row.status }}
                        </span>
                        <span class="lead-group-activity__date">{{ asLocalDate(row.completedDateUtc || row.dueDateUtc || row.createdAtUtc) | date: 'MMM d, h:mm a' }}</span>
                      </div>
                    </button>
                  </div>
                </div>
              </div>
            </ng-container>
            </ng-container>
            <ng-template #opportunityGroupedView>
              <ng-container *ngIf="opportunityGroupedActivities().length; else emptyState">
                <div class="grouped-activities">
                  <div class="grouped-activities__summary">
                    <span class="grouped-activities__label">Grouped by Opportunity</span>
                    <span class="grouped-activities__count">{{ groupedOpportunityActivityCount() }} opportunit{{ groupedOpportunityActivityCount() === 1 ? 'y' : 'ies' }}</span>
                  </div>

                  <div class="lead-group-card" *ngFor="let group of opportunityGroupedActivities()">
                    <div class="lead-group-card__header">
                      <div class="lead-group-card__identity">
                        <div class="lead-group-card__title-row">
                          <span class="lead-group-card__title">{{ group.opportunityName }}</span>
                          <a
                            class="lead-group-card__lead-link"
                            [routerLink]="['/app/opportunities', group.opportunityId, 'edit']"
                            (click)="$event.stopPropagation()"
                          >
                            <i class="pi pi-link"></i>
                            Open Opportunity
                          </a>
                        </div>
                        <div class="lead-group-card__meta">
                          <span>{{ group.items.length }} activit{{ group.items.length === 1 ? 'y' : 'ies' }}</span>
                          <span *ngIf="group.lastActivityAt">• Last activity {{ asLocalDate(group.lastActivityAt) | date:'MMM d, h:mm a' }}</span>
                        </div>
                      </div>
                      <div class="lead-group-card__stats">
                        <span class="group-chip neutral">Open {{ group.openCount }}</span>
                        <span class="group-chip success">Done {{ group.completedCount }}</span>
                        <span class="group-chip danger" *ngIf="group.overdueCount">Overdue {{ group.overdueCount }}</span>
                      </div>
                    </div>

                    <div class="lead-group-card__items">
                      <button
                        type="button"
                        class="lead-group-activity"
                        *ngFor="let row of group.items"
                        (click)="canManage() ? onEdit(row) : null"
                      >
                        <div class="lead-group-activity__left">
                          <span class="type-badge" [attr.data-type]="row.type">
                            <i class="pi"
                               [class.pi-phone]="row.type === 'Call'"
                               [class.pi-envelope]="row.type === 'Email'"
                               [class.pi-users]="row.type === 'Meeting'"
                               [class.pi-check-square]="row.type === 'Task'"></i>
                            {{ row.type }}
                          </span>
                          <span class="lead-group-activity__subject">{{ row.subject }}</span>
                        </div>
                        <div class="lead-group-activity__right">
                          <span class="status-chip"
                                [class.upcoming]="row.status === 'Upcoming'"
                                [class.completed]="row.status === 'Completed'"
                                [class.overdue]="row.status === 'Overdue'">
                            {{ row.status }}
                          </span>
                          <span class="lead-group-activity__date">{{ asLocalDate(row.completedDateUtc || row.dueDateUtc || row.createdAtUtc) | date: 'MMM d, h:mm a' }}</span>
                        </div>
                      </button>
                    </div>
                  </div>
                </div>
              </ng-container>
            </ng-template>
          </ng-container>

          <ng-template #flatTableView>
          <ng-container *ngIf="filteredActivities().length; else emptyState">
            <div class="table-responsive">
              <p-table class="data-table" [value]="filteredActivities()">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Subject</th>
                    <th>Type</th>
                    <th>Related To</th>
                    <th>Priority</th>
                    <th>Due Date</th>
                    <th>Status</th>
                    <th>Owner</th>
                    <th class="actions-col">Actions</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-row>
                  <tr class="table-row" (click)="canManage() ? onEdit(row) : null">
                    <td>
                      <span class="subject-text">{{ row.subject }}</span>
                    </td>
                    <td>
                      <span class="type-badge" [attr.data-type]="row.type">
                        <i class="pi" 
                           [class.pi-phone]="row.type === 'Call'"
                           [class.pi-envelope]="row.type === 'Email'"
                           [class.pi-users]="row.type === 'Meeting'"
                           [class.pi-check-square]="row.type === 'Task'"></i>
                        {{ row.type }}
                      </span>
                    </td>
                    <td>
                      <div class="related-info">
                        <span class="related-type">{{ relationLabel(row.relatedEntityType) }}</span>
                        <span class="related-name">{{ row.relatedEntityName || '—' }}</span>
                        <a
                          *ngIf="relatedLink(row) as link"
                          class="related-link"
                          [routerLink]="link"
                          (click)="$event.stopPropagation()"
                        >
                          <i class="pi pi-link"></i>
                          View
                        </a>
                      </div>
                    </td>
                    <td>
                      <span class="priority-chip" 
                            [class.high]="row.priority === 'High'"
                            [class.normal]="row.priority === 'Normal' || !row.priority"
                            [class.low]="row.priority === 'Low'">
                        {{ row.priority || 'Normal' }}
                      </span>
                    </td>
                    <td>
                      <span class="date-text">{{ asLocalDate(row.dueDateUtc) | date: 'MMM d, h:mm a' }}</span>
                    </td>
                    <td>
                      <span class="status-chip"
                            [class.upcoming]="row.status === 'Upcoming'"
                            [class.completed]="row.status === 'Completed'"
                            [class.overdue]="row.status === 'Overdue'">
                        {{ row.status }}
                      </span>
                    </td>
                    <td>
                      <span class="owner-text">{{ row.ownerName || 'Unassigned' }}</span>
                    </td>
                    <td class="actions-col">
                      <div class="row-actions">
                        <button
                          pButton
                          type="button"
                          class="action-btn p-button-text p-button-rounded p-button-sm p-button-success"
                          icon="pi pi-check"
                          [disabled]="!canMarkComplete(row)"
                          (click)="$event.stopPropagation(); markCompleted(row)"
                          title="Mark completed"
                        ></button>
                        <button
                          pButton
                          type="button"
                          class="action-btn p-button-text p-button-rounded p-button-sm p-button-info"
                          icon="pi pi-pencil"
                          [disabled]="!canManage()"
                          (click)="$event.stopPropagation(); onEdit(row)"
                          title="Edit"
                        ></button>
                        <button
                          pButton
                          type="button"
                          class="action-btn p-button-text p-button-rounded p-button-sm p-button-danger"
                          icon="pi pi-trash"
                          [disabled]="!canManage()"
                          (click)="$event.stopPropagation(); onDelete(row)"
                          title="Delete"
                        ></button>
                      </div>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination-bar">
              <span class="pagination-info">
                Showing {{ (pageIndex * rows) + 1 }}–{{ Math.min((pageIndex + 1) * rows, total()) }} of {{ total() }}
              </span>
              <p-paginator
                [rows]="rows"
                [totalRecords]="total()"
                [first]="pageIndex * rows"
                (onPageChange)="onPageChange($event)"
                [showFirstLastIcon]="false"
                [showPageLinks]="true"
                [pageLinkSize]="5"
              ></p-paginator>
            </div>
          </ng-container>
          </ng-template>
        </ng-container>

        <ng-template #loadingState>
          <div class="loading-skeleton">
            <div class="skeleton-row" *ngFor="let _ of [1,2,3,4,5]">
              <div class="skeleton"></div>
            </div>
          </div>
        </ng-template>

        <ng-template #emptyState>
          <div class="empty-state">
            <div class="empty-icon">
              <i class="pi pi-calendar"></i>
            </div>
            <h3 class="empty-title">No activities found</h3>
            <p class="empty-text">Create your first activity to start tracking calls, emails, and meetings.</p>
            <button pButton type="button" class="btn-primary" [disabled]="!canManage()" (click)="onCreate()">
              <i class="pi pi-plus"></i>
              New Activity
            </button>
          </div>
        </ng-template>
      </div>
    </section>

    <!-- Calendar + Tasks -->
    <section class="calendar-section" *ngIf="currentView() === 'calendar'">
      <div class="calendar-shell glass-card">
        <header class="calendar-header">
          <div>
            <p class="eyebrow">Schedule</p>
            <h2>{{ calendarMonthLabel() }}</h2>
            <p class="muted">{{ selectedDateLabel() }}</p>
          </div>
          <div class="calendar-actions">
            <button pButton type="button" class="btn-icon" (click)="previousMonth()" title="Previous month">
              <i class="pi pi-angle-left"></i>
            </button>
            <button pButton type="button" class="btn-icon" (click)="goToToday()" title="Today">
              <i class="pi pi-calendar"></i>
            </button>
            <button pButton type="button" class="btn-icon" (click)="nextMonth()" title="Next month">
              <i class="pi pi-angle-right"></i>
            </button>
          </div>
        </header>
        <div class="calendar-grid">
          <div class="calendar-weekday" *ngFor="let day of weekdayLabels">{{ day }}</div>
          <button
            pButton
            type="button"
            class="calendar-day"
            *ngFor="let day of calendarDays()"
            [class.is-outside]="!day.isCurrentMonth"
            [class.is-today]="day.isToday"
            [class.is-selected]="day.isSelected"
            (click)="selectDate(day.date)"
          >
            <span class="day-number">{{ day.date.getDate() }}</span>
            <span class="day-count" *ngIf="day.items.length">{{ day.items.length }}</span>
          </button>
        </div>
      </div>

      <aside class="calendar-panel">
        <div class="panel-card">
          <header>
            <h3>Tasks for {{ selectedDateLabel() }}</h3>
            <span class="pill">{{ selectedDayTasks().length }}</span>
          </header>
          <div class="task-list" *ngIf="selectedDayTasks().length; else noTasks">
            <div class="task-item" *ngFor="let task of selectedDayTasks()">
              <div>
                <strong>{{ task.subject }}</strong>
                <small>{{ task.status }}</small>
              </div>
              <span class="task-type">{{ task.type }}</span>
            </div>
          </div>
          <ng-template #noTasks>
            <p class="empty-text">No tasks scheduled for this day.</p>
          </ng-template>
        </div>

        <div class="panel-card">
          <header>
            <h3>Open tasks</h3>
            <span class="pill">{{ openTasks().length }}</span>
          </header>
          <div class="task-list" *ngIf="openTasksPreview().length; else noOpenTasks">
            <div class="task-item" *ngFor="let task of openTasksPreview()">
              <div>
                <strong>{{ task.subject }}</strong>
                <small>{{ task.dueDateUtc ? (asLocalDate(task.dueDateUtc) | date: 'MMM d, h:mm a') : 'No due date' }}</small>
              </div>
              <span class="task-type">{{ task.type }}</span>
            </div>
          </div>
          <ng-template #noOpenTasks>
            <p class="empty-text">All caught up.</p>
          </ng-template>
        </div>
      </aside>
    </section>

    <section class="tasks-section" *ngIf="currentView() === 'tasks'">
        <div class="tasks-header glass-card">
          <div>
            <p class="eyebrow">Tasks</p>
            <h2>Execution queue</h2>
            <p class="muted">Focused list of open and completed tasks.</p>
          </div>
          <button pButton type="button" class="btn-primary" [disabled]="!canManage()" (click)="onCreate()">
            <i class="pi pi-plus"></i>
            Add Task
          </button>
        </div>

      <div class="tasks-grid">
        <article class="tasks-column">
          <header>
            <span>Due today</span>
            <strong>{{ tasksToday().length }}</strong>
          </header>
          <button pButton type="button" class="task-card" *ngFor="let task of tasksToday()" [disabled]="!canManage()" (click)="onEdit(task)">
            <div>
              <strong>{{ task.subject }}</strong>
              <small>{{ task.dueDateUtc ? (asLocalDate(task.dueDateUtc) | date: 'MMM d, h:mm a') : 'No due date' }}</small>
            </div>
            <span class="status-tag status-tag--today">Today</span>
          </button>
          <p class="empty-text" *ngIf="!tasksToday().length">No tasks due today.</p>
        </article>

        <article class="tasks-column">
          <header>
            <span>Overdue</span>
            <strong>{{ tasksOverdue().length }}</strong>
          </header>
          <button pButton type="button" class="task-card" *ngFor="let task of tasksOverdue()" [disabled]="!canManage()" (click)="onEdit(task)">
            <div>
              <strong>{{ task.subject }}</strong>
              <small>{{ task.dueDateUtc ? (asLocalDate(task.dueDateUtc) | date: 'MMM d, h:mm a') : 'No due date' }}</small>
            </div>
            <span class="status-tag status-tag--overdue">Overdue</span>
          </button>
          <p class="empty-text" *ngIf="!tasksOverdue().length">Nothing overdue.</p>
        </article>

        <article class="tasks-column">
          <header>
            <span>Upcoming</span>
            <strong>{{ tasksUpcoming().length }}</strong>
          </header>
          <button pButton type="button" class="task-card" *ngFor="let task of tasksUpcoming()" [disabled]="!canManage()" (click)="onEdit(task)">
            <div>
              <strong>{{ task.subject }}</strong>
              <small>{{ task.dueDateUtc ? (asLocalDate(task.dueDateUtc) | date: 'MMM d, h:mm a') : 'No due date' }}</small>
            </div>
            <span class="status-tag status-tag--upcoming">Upcoming</span>
          </button>
          <p class="empty-text" *ngIf="!tasksUpcoming().length">No upcoming tasks.</p>
        </article>

        <article class="tasks-column tasks-column--completed">
          <header>
            <span>Completed</span>
            <strong>{{ tasksCompleted().length }}</strong>
          </header>
          <button pButton type="button" class="task-card" *ngFor="let task of tasksCompleted()" [disabled]="!canManage()" (click)="onEdit(task)">
            <div>
              <strong>{{ task.subject }}</strong>
              <small>{{ task.completedDateUtc ? (asLocalDate(task.completedDateUtc) | date: 'MMM d, h:mm a') : 'Completed' }}</small>
            </div>
            <span class="status-tag status-tag--done">Done</span>
          </button>
          <p class="empty-text" *ngIf="!tasksCompleted().length">No completed tasks.</p>
        </article>
      </div>
    </section>
  </div>
</div>

<!-- Mobile FAB -->
<button pButton type="button" class="fab" [disabled]="!canManage()" (click)="onCreate()">
  <i class="pi pi-plus"></i>
</button>
