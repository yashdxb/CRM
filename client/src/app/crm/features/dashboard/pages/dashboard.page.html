<div class="page-background">
  <div class="animated-orb orb-1"></div>
  <div class="animated-orb orb-2"></div>
  <div class="animated-orb orb-3"></div>
  <div class="animated-orb orb-4"></div>
  <div class="grid-pattern"></div>
</div>

<div class="page-container dashboard">
  <div class="page-content">
    <!-- PrimeNG Breadcrumb -->
    <app-breadcrumbs></app-breadcrumbs>
    <div class="dashboard-layout">
      <div class="dashboard-main">

    <!-- Hero Section with Greeting -->
    <section class="hero-section">
      <div class="hero-content">
        <div class="hero-text">
          <span class="hero-greeting">{{ greeting }}</span>
          <h1 class="page-title">
            <span class="title-gradient">Command</span>
            <span class="title-light">Center</span>
          </h1>
          <p class="page-subtitle">Your CRM at a glance — track pipeline, monitor activities, and stay ahead of every deal.</p>
        </div>
        <div class="hero-stats">
          <div class="hero-stat-pill">
            <i class="pi pi-building"></i>
            <span><strong>{{ summary().totalCustomers || 0 }}</strong> accounts</span>
          </div>
          <div class="hero-stat-pill">
            <i class="pi pi-bolt"></i>
            <span><strong>{{ summary().tasksDueToday || 0 }}</strong> tasks today</span>
          </div>
          <div class="hero-stat-pill success" *ngIf="summary().overdueActivities === 0">
            <i class="pi pi-check-circle"></i>
            <span>All caught up!</span>
          </div>
          <div class="hero-stat-pill danger" *ngIf="(summary().overdueActivities || 0) > 0">
            <i class="pi pi-exclamation-triangle"></i>
            <span><strong>{{ summary().overdueActivities }}</strong> overdue</span>
          </div>
        </div>
      </div>
      <div class="hero-actions">
        <button pButton type="button" class="btn-gradient btn-lg" (click)="onQuickAdd()">
          <i class="pi pi-plus"></i>
          <span>Quick Add</span>
        </button>
        <button pButton type="button" class="btn-glass">
          <i class="pi pi-calendar"></i>
          <span>Schedule</span>
        </button>
        <button pButton type="button" class="btn-glass">
          <i class="pi pi-download"></i>
          <span>Export</span>
        </button>
        <button pButton type="button" class="btn-glass" (click)="openLayoutDialog()">
          <i class="pi pi-sliders-h"></i>
          <span>Customize layout</span>
        </button>
      </div>
    </section>

    <!-- Key Metrics Row -->
    <section class="metrics-dashboard">
      <div class="metrics-header">
        <h2 class="section-title">
          <i class="pi pi-chart-bar"></i>
          Performance Overview
        </h2>
        <div class="metrics-period">
          <button pButton type="button" class="period-btn active">Today</button>
          <button pButton type="button" class="period-btn">Week</button>
          <button pButton type="button" class="period-btn">Month</button>
        </div>
      </div>
      <div
        class="metrics-grid"
        cdkDropList
        [cdkDropListData]="kpiOrder()"
        (cdkDropListDropped)="onKpiDrop($event)"
        cdkDropListOrientation="horizontal"
      >
        <article class="metric-card featured" *ngIf="summary()">
          <div class="metric-glow primary"></div>
          <div class="metric-icon-large primary">
            <i class="pi pi-dollar"></i>
          </div>
          <div class="metric-body">
            <div class="metric-value-large">{{ totalPipelineValue() | currency:resolveCurrencyCode():'symbol':'1.0-0' }}</div>
            <div class="metric-label">Total Pipeline Value</div>
            <div class="metric-trend up">
              <i class="pi pi-trending-up"></i>
              <span>+18% this quarter</span>
            </div>
          </div>
        </article>

        <article class="metric-card" *ngFor="let metric of secondaryKpis(); let i = index" cdkDrag>
          <div class="metric-header">
            <button type="button" class="kpi-drag-handle" cdkDragHandle aria-label="Reorder KPI">
              <i class="pi pi-bars"></i>
            </button>
            <div class="metric-icon" [class]="metric.color" cdkDragHandle>
              <i class="pi" [class]="metric.icon"></i>
            </div>
            <div class="metric-trend" [class.up]="metric.trend > 0" [class.down]="metric.trend < 0">
              <i class="pi" [class.pi-arrow-up]="metric.trend > 0" [class.pi-arrow-down]="metric.trend < 0"></i>
              <span>{{ metric.trend > 0 ? '+' : '' }}{{ metric.trend }}%</span>
            </div>
          </div>
          <div class="metric-value">
            {{ metric.value | number:'1.0-1' }}
          </div>
          <div class="metric-label">{{ metric.label }}</div>
          <div class="metric-bar">
            <div class="metric-bar-fill" [class]="metric.color" [style.width.%]="metric.percentage"></div>
          </div>
        </article>
      </div>
    </section>

    <section class="ai-orchestration-section glass-card">
      <div class="ai-orchestration-header">
        <div class="ai-orchestration-title-group">
          <h2 class="section-title">
            <i class="pi pi-bolt"></i>
            AI Execution Orchestration
          </h2>
          <p class="ai-orchestration-subtitle">Prioritized by risk and immediacy for faster operator decisions.</p>
        </div>
        <div class="ai-orchestration-header-meta">
          <span class="card-badge">{{ assistantInsights().scope }} scope</span>
          <span class="ai-generated-at">Updated {{ assistantInsights().generatedAtUtc | date:'shortTime' }}</span>
        </div>
      </div>

      <div class="ai-kpi-grid">
        <article class="ai-kpi-card" *ngFor="let kpi of assistantKpis()">
          <div class="ai-kpi-head">
            <div class="ai-kpi-label">{{ kpi.label }}</div>
            <span class="ai-kpi-dot" [ngClass]="assistantSeverityClass(kpi.severity)"></span>
          </div>
          <div class="ai-kpi-value" [ngClass]="assistantSeverityClass(kpi.severity)">{{ kpi.value | number:'1.0-0' }}</div>
        </article>
      </div>

      <div class="ai-action-queue" *ngIf="assistantActions().length; else noAiActions">
        <article
          class="ai-action-item"
          *ngFor="let action of assistantActions(); let idx = index"
          [ngClass]="[
            assistantRiskClass(action.riskTier),
            assistantUrgencyClass(action.priority, action.urgency)
          ]"
        >
          <div class="ai-action-rank">{{ idx + 1 }}</div>
          <div class="ai-action-content">
            <div class="ai-action-title-row">
              <h3 class="card-title">{{ action.title }}</h3>
              <span class="ai-risk-pill" [ngClass]="assistantRiskClass(action.riskTier)">
                {{ action.riskTier || 'unknown' }} risk
              </span>
            </div>
            <p>{{ action.description }}</p>
            <div class="ai-action-meta">
              <span class="ai-urgency-pill" [ngClass]="assistantUrgencyClass(action.priority, action.urgency)">
                <i class="pi pi-bolt"></i>
                {{ assistantUrgencyLabel(action.priority, action.urgency) }}
              </span>
              <span class="ai-score-pill">
                <i class="pi pi-chart-line"></i>
                Score {{ action.score }}
              </span>
              <span><i class="pi pi-user"></i> {{ action.ownerScope }}</span>
              <span><i class="pi pi-clock"></i> {{ action.dueWindow }}</span>
            </div>
          </div>
          <button
            pButton
            type="button"
            class="ai-action-btn"
            [ngClass]="[
              (action.riskTier || '').toLowerCase() === 'low' ? 'btn-gradient' : 'btn-glass',
              assistantUrgencyClass(action.priority, action.urgency)
            ]"
            (click)="openAssistantAction(action)"
          >
            <i class="pi" [ngClass]="(action.riskTier || '').toLowerCase() === 'low' ? 'pi-play-circle' : 'pi-eye'"></i>
            {{ (action.riskTier || '').toLowerCase() === 'low' ? 'Execute' : 'Review' }}
          </button>
        </article>
      </div>
      <ng-template #noAiActions>
        <div class="empty-state-inline">No urgent AI actions right now.</div>
      </ng-template>

      <div class="assistant-undo-strip" *ngIf="assistantUndoVisible">
        <span>{{ assistantUndoMessage }}</span>
        <button pButton type="button" class="btn-glass" [disabled]="assistantUndoBusy" (click)="undoAssistantAction()">
          Undo
        </button>
      </div>
    </section>

    <p-dialog
      [(visible)]="assistantReviewDialogOpen"
      [modal]="true"
      [closable]="!assistantReviewSubmitting"
      [dismissableMask]="!assistantReviewSubmitting"
      header="Review Assistant Action"
      [style]="{ width: '520px', maxWidth: '92vw' }"
      (onHide)="cancelAssistantReview()"
    >
      <div class="assistant-review-content">
        <p>This action is marked medium/high risk and needs review before execution.</p>
        <textarea
          rows="4"
          [disabled]="assistantReviewSubmitting"
          placeholder="Add review note (optional)"
          [ngModel]="assistantReviewNote"
          (ngModelChange)="assistantReviewNote = $event"
        ></textarea>
      </div>
      <ng-template pTemplate="footer">
        <button pButton type="button" class="btn-glass" [disabled]="assistantReviewSubmitting" (click)="cancelAssistantReview()">
          Cancel
        </button>
        <button pButton type="button" class="btn-glass" [disabled]="assistantReviewSubmitting" (click)="submitAssistantReview(false)">
          Reject
        </button>
        <button pButton type="button" class="btn-gradient" [disabled]="assistantReviewSubmitting" (click)="submitAssistantReview(true)">
          Approve & Execute
        </button>
      </ng-template>
    </p-dialog>

    <!-- Main Grid: Command Center Cards -->
    <section
      class="dashboard-card-grid"
      cdkDropList
      [cdkDropListData]="layoutOrder"
      (cdkDropListDropped)="onCardDrop($event)"
      cdkDropListOrientation="mixed"
    >
        <article
          class="glass-card dashboard-card card-resizable"
          *ngFor="let cardId of layoutOrder"
          [ngSwitch]="cardId"
          [ngClass]="getCardSizeClass(cardId)"
          [class.my-tasks-card]="cardId === 'my-tasks'"
          cdkDrag
          (cdkDragStarted)="onCardDragStart($event)"
          (cdkDragEnded)="onCardDragEnd($event)"
          #dashboardCard
          [attr.data-card-id]="cardId"
          [ngStyle]="getCardDimensions(cardId)"
          data-min-width="280"
          [attr.data-min-height]="cardId === 'my-tasks' ? 360 : 220"
        >
        <!-- Pipeline Value Chart -->
        <ng-container *ngSwitchCase="'pipeline'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="pi pi-filter"></i>
              Pipeline by Stage
            </h3>
            <div class="card-actions">
              <span class="card-badge">{{ totalPipelineValue() | currency:resolveCurrencyCode():'symbol':'1.0-0' }}</span>
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body">
            <div class="chart-container medium">
              <p-chart type="bar" [data]="pipelineChartData" [options]="pipelineChartOptions" height="100%"></p-chart>
            </div>
            <div class="pipeline-stats">
              <div class="pipeline-stat" *ngFor="let stage of pipelineValue()">
                <span class="stat-label">{{ stage.stage }}</span>
                <span class="stat-value">{{ stage.count }} deals</span>
                <span class="stat-subvalue">{{ stage.value | currency:resolveCurrencyCode():'symbol':'1.0-0' }}</span>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Truth Metrics -->
        <ng-container *ngSwitchCase="'truth-metrics'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="pi pi-verified"></i>
              Truth Metrics
            </h3>
            <div class="card-actions">
              <span class="card-badge">{{ summary().avgTruthCoverage | percent:'1.0-0' }}</span>
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body">
            <div class="truth-metrics-grid">
              <div class="truth-metric">
                <span class="truth-label">Truth Coverage</span>
                <span class="truth-value">{{ summary().avgTruthCoverage | percent:'1.0-0' }}</span>
              </div>
              <div class="truth-metric">
                <span class="truth-label">Confidence</span>
                <span class="truth-value"
                      [class]="confidenceTone(summary().avgQualificationConfidence)">
                  {{ confidenceLabel(summary().avgQualificationConfidence) }}
                </span>
              </div>
              <div class="truth-metric">
                <span class="truth-label">Time-to-Truth</span>
                <span class="truth-value">{{ summary().avgTimeToTruthDays | number:'1.0-1' }}d</span>
              </div>
            </div>
            <div class="truth-subtext">
              Based on current lead qualification signals.
            </div>
          </div>
        </ng-container>

        <!-- Risk Register -->
        <ng-container *ngSwitchCase="'risk-register'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="pi pi-exclamation-triangle"></i>
              Risk Register
            </h3>
            <div class="card-actions">
              <span class="card-badge warn">{{ summary().riskRegisterCount }}</span>
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body">
            <div class="risk-flags" *ngIf="topRiskFlags().length; else emptyRiskFlags">
              <div class="risk-flag" *ngFor="let flag of topRiskFlags()">
                <span class="risk-label">{{ flag.label }}</span>
                <span class="risk-count">{{ flag.count }}</span>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Execution Guide -->
        <ng-container *ngSwitchCase="'execution-guide'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="pi pi-compass"></i>
              Execution Guide
            </h3>
            <div class="card-actions">
              <span class="card-badge">{{ executionGuideItems().length }}</span>
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body">
            <div class="execution-guide" *ngIf="executionGuideItems().length; else emptyExecutionGuide">
              <div class="execution-item" *ngFor="let item of executionGuideItems()">
                <div class="execution-label">{{ item.label }}</div>
                <div class="execution-count">{{ item.count }}</div>
              </div>
              <div class="execution-footnote">
                Focus on the top two items to keep your pipeline clean.
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Expansion Signals -->
        <ng-container *ngSwitchCase="'expansion-signals'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="pi pi-sparkles"></i>
              Expansion Signals
            </h3>
            <div class="card-actions">
              <span class="card-badge">{{ expansionSignalsCount() }}</span>
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body">
            <div class="expansion-signals" *ngIf="!expansionLoading(); else expansionLoadingTpl">
              <div class="expansion-item" *ngFor="let signal of expansionSignals()">
                <div class="expansion-info">
                  <div class="expansion-title">{{ signal.accountName }}</div>
                  <div class="expansion-meta">
                    {{ signal.opportunityName }} · {{ signal.signalCount }} signals ·
                    Last {{ signal.lastSignalAtUtc | date:'MMM d' }}
                  </div>
                  <div class="expansion-meta" *ngIf="signal.contractEndDateUtc">
                    Contract ends {{ signal.contractEndDateUtc | date:'MMM d, yyyy' }}
                  </div>
                </div>
                <div class="expansion-actions">
                  <button
                    pButton
                    type="button"
                    class="crm-button crm-button--primary"
                    label="Create expansion"
                    icon="pi pi-plus"
                    [disabled]="signal.hasExpansionOpportunity || isExpansionSubmitting(signal)"
                    (click)="createExpansionOpportunity(signal)"
                  ></button>
                  <span class="expansion-status" *ngIf="signal.hasExpansionOpportunity">Expansion created</span>
                </div>
              </div>
              <div class="empty-state" *ngIf="!expansionSignals().length">No expansion signals yet.</div>
            </div>
            <ng-template #expansionLoadingTpl>
              <div class="empty-state">Loading expansion signals...</div>
            </ng-template>
          </div>
        </ng-container>

        <!-- Confidence Forecast -->
        <ng-container *ngSwitchCase="'confidence-forecast'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="pi pi-chart-line"></i>
              Confidence Forecast
            </h3>
            <div class="card-actions">
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body">
            <div class="forecast-value">
              {{ summary().confidenceWeightedPipelineValue | currency:resolveCurrencyCode():'symbol':'1.0-0' }}
            </div>
            <div class="forecast-meta">
              <span>Weighted pipeline</span>
              <span class="forecast-delta" [class.negative]="weightedPipelineDelta() < 0">
                {{ weightedPipelineDelta() | currency:resolveCurrencyCode():'symbol':'1.0-0' }}
              </span>
            </div>
            <div class="forecast-footnote">
              Raw pipeline: {{ totalPipelineValue() | currency:resolveCurrencyCode():'symbol':'1.0-0' }}
            </div>
            <div class="forecast-aux">
              <div class="forecast-row">
                <span>Cost of Not Knowing</span>
                <span>{{ summary().costOfNotKnowingValue | currency:resolveCurrencyCode():'symbol':'1.0-0' }}</span>
              </div>
              <div class="forecast-row">
                <span>Low-confidence deals</span>
                <span>{{ summary().costOfNotKnowingDeals }}</span>
              </div>
              <div class="forecast-row">
                <span>Calibration score</span>
                <span>{{ summary().confidenceCalibrationScore | number:'1.0-0' }}%</span>
              </div>
              <div class="forecast-row" *ngIf="summary().confidenceCalibrationSample > 0">
                <span>Calibration sample</span>
                <span>{{ summary().confidenceCalibrationSample }}</span>
              </div>
            </div>
            <div class="cost-breakdown" *ngIf="summary().costOfNotKnowingBreakdown.length">
              <div class="cost-breakdown__header">
                <h4>Top Cost Drivers</h4>
                <button
                  *ngIf="summary().costOfNotKnowingBreakdown.length > 5"
                  type="button"
                  class="btn btn-ghost btn-sm"
                  (click)="openCostBreakdownDialog()"
                >
                  View all
                </button>
              </div>
              <div class="cost-deal" *ngFor="let deal of topCostBreakdown()">
                <div class="cost-deal__header">
                  <div>
                    <div class="cost-deal__name">{{ deal.opportunityName }}</div>
                    <div class="cost-deal__meta">{{ deal.accountName }} • {{ deal.stage }}</div>
                  </div>
                  <div class="cost-deal__value">
                    {{ deal.costOfNotKnowingValue | currency:resolveCurrencyCode():'symbol':'1.0-0' }}
                  </div>
                </div>
                <div class="cost-deal__factors">
                  <span class="cost-factor" *ngFor="let factor of deal.topFactors">
                    {{ factor.label }}: {{ factor.contribution | currency:resolveCurrencyCode():'symbol':'1.0-0' }}
                  </span>
                </div>
              </div>
            </div>
            <div class="cost-trend" *ngIf="costTrendChartData">
              <div class="cost-trend__header">
                <h4>Exposure Trend</h4>
                <span class="hint">Last 8 weeks</span>
              </div>
              <div class="chart-container small">
                <p-chart type="line" [data]="costTrendChartData" [options]="costTrendChartOptions" height="140px"></p-chart>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Forecast Scenarios -->
        <ng-container *ngSwitchCase="'forecast-scenarios'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="pi pi-sliders-h"></i>
              Forecast Scenarios
            </h3>
            <div class="card-actions">
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body">
            <ng-container *ngIf="summary().forecastScenarios.length; else noScenarios">
              <div class="forecast-scenarios">
                <div class="scenario-row" *ngFor="let scenario of summary().forecastScenarios">
                  <div class="scenario-label">
                    <span class="scenario-name">{{ scenario.label }}</span>
                    <span class="scenario-count">{{ scenario.dealCount }} deals</span>
                  </div>
                  <div class="scenario-value">
                    {{ scenario.value | currency:resolveCurrencyCode():'symbol':'1.0-0' }}
                  </div>
                  <div class="scenario-delta" [class.negative]="scenario.deltaFromBase < 0" [class.positive]="scenario.deltaFromBase > 0">
                    {{ scenario.deltaFromBase | currency:resolveCurrencyCode():'symbol':'1.0-0' }}
                  </div>
                </div>
              </div>
            </ng-container>
            <ng-template #noScenarios>
              <div class="empty-state">No scenarios available.</div>
            </ng-template>
          </div>
        </ng-container>

        <!-- My Forecast -->
        <ng-container *ngSwitchCase="'my-forecast'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="pi pi-bolt"></i>
              My Forecast
            </h3>
            <div class="card-actions">
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body">
            <div class="forecast-value">
              {{ summary().myConfidenceWeightedPipelineValue | currency:resolveCurrencyCode():'symbol':'1.0-0' }}
            </div>
            <div class="forecast-meta">
              <span>Weighted pipeline</span>
              <span class="forecast-delta" [class.negative]="summary().myConfidenceWeightedPipelineValue - summary().myPipelineValueTotal < 0">
                {{ (summary().myConfidenceWeightedPipelineValue - summary().myPipelineValueTotal) | currency:resolveCurrencyCode():'symbol':'1.0-0' }}
              </span>
            </div>
            <div class="forecast-footnote">
              Raw pipeline: {{ summary().myPipelineValueTotal | currency:resolveCurrencyCode():'symbol':'1.0-0' }}
            </div>
            <div class="forecast-aux" *ngIf="myQuotaTarget() as quota; else noQuota">
              <div class="forecast-row">
                <span>Quota</span>
                <span>{{ quota | currency:resolveCurrencyCode():'symbol':'1.0-0' }}</span>
              </div>
              <div class="forecast-row">
                <span>Progress</span>
                <span>{{ myQuotaProgress() }}%</span>
              </div>
            </div>
            <ng-template #noQuota>
              <div class="forecast-footnote">Quota: Not set</div>
            </ng-template>
          </div>
        </ng-container>

        <!-- Recent Accounts -->
        <ng-container *ngSwitchCase="'accounts'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="pi pi-building"></i>
              Recent Accounts
            </h3>
            <div class="card-actions">
              <button pButton type="button" class="btn-glass btn-sm">
                View All <i class="pi pi-arrow-right"></i>
              </button>
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body" *ngIf="recentAccounts().length; else emptyAccounts">
            <div class="accounts-list">
              <div class="account-row" *ngFor="let account of recentAccounts(); let i = index">
                <div class="account-rank">{{ i + 1 }}</div>
                <div class="account-avatar"
                     [class.lead]="account.status === 'Lead'"
                     [class.prospect]="account.status === 'Prospect'"
                     [class.customer]="account.status === 'Customer'">
                  {{ account.name.charAt(0) }}
                </div>
                <div class="account-info">
                  <div class="account-name">{{ account.name }}</div>
                  <div class="account-meta">
                    <span>{{ account.company }}</span>
                    <span class="separator">•</span>
                    <span>{{ account.owner }}</span>
                  </div>
                </div>
                <div class="account-status">
                  <span class="status-dot"
                        [class.lead]="account.status === 'Lead'"
                        [class.prospect]="account.status === 'Prospect'"
                        [class.customer]="account.status === 'Customer'"></span>
                  <span class="status-text">{{ account.status }}</span>
                </div>
                <button pButton type="button" class="btn-icon-sm" icon="pi pi-ellipsis-h"></button>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Cards merged into Priority Stream -->

        <!-- Manager Pipeline Health -->
        <ng-container *ngSwitchCase="'manager-health'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="pi pi-shield"></i>
              Pipeline Health
            </h3>
            <div class="card-actions">
              <span class="card-badge warn" *ngIf="managerReviewQueue().length">
                {{ managerReviewQueue().length }} needs review
              </span>
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body manager-health" *ngIf="managerReviewQueue().length; else emptyManagerHealth">
            <div class="manager-health__stats">
              <div class="health-pill" *ngFor="let stat of managerHealthStats()" [ngClass]="stat.tone">
                <span class="health-pill__value">{{ stat.value }}</span>
                <span class="health-pill__label">{{ stat.label }}</span>
              </div>
            </div>
            <div class="manager-health__truth" *ngIf="managerTruthGaps().length; else noTruthGaps">
              <div class="truth-heading">Top Truth Gaps</div>
              <div class="truth-list">
                <span class="truth-chip" *ngFor="let gap of managerTruthGaps()">
                  {{ gap.label }} · {{ gap.count }}
                </span>
              </div>
            </div>
            <ng-template #noTruthGaps>
              <div class="manager-health__truth manager-health__truth--empty">
                <div class="truth-heading">Top Truth Gaps</div>
                <span class="truth-empty">No gaps flagged</span>
              </div>
            </ng-template>
            <div class="manager-health__queue">
              <div class="manager-deal" *ngFor="let deal of managerReviewQueue()">
                <div class="manager-deal__info">
                  <div class="manager-deal__name">{{ deal.name }}</div>
                  <div class="manager-deal__meta">
                    <span>{{ deal.accountName }}</span>
                    <span class="separator">•</span>
                    <span>{{ deal.stage }}</span>
                    <span class="separator">•</span>
                    <span>{{ deal.ownerName }}</span>
                  </div>
                  <div class="manager-deal__reason">
                    <i class="pi pi-flag"></i>
                    {{ deal.reason }}
                  </div>
                </div>
                <div class="manager-deal__side">
                  <div class="manager-deal__amount">{{ deal.amount | currency:resolveCurrencyCode():'symbol':'1.0-0' }}</div>
                  <div class="manager-deal__metrics">
                    <span>Truth: {{ formatTruthCoverage(deal.truthCoverage) }}</span>
                    <span>TtT: {{ formatTimeToTruth(deal.timeToTruthDays) }}</span>
                  </div>
                  <div class="manager-deal__dates">
                    <span *ngIf="deal.nextStepDueAtUtc">Next: {{ asLocalDate(deal.nextStepDueAtUtc) | date: 'MMM d' }}</span>
                    <span *ngIf="deal.expectedCloseDate">Close: {{ asLocalDate(deal.expectedCloseDate) | date: 'MMM d' }}</span>
                  </div>
                  <button pButton type="button" class="btn-glass btn-sm coach-btn" (click)="openCoaching(deal)">
                    Coach
                  </button>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Activity Breakdown Donut -->
        <ng-container *ngSwitchCase="'activity-mix'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="pi pi-chart-pie"></i>
              Activity Mix
            </h3>
            <div class="card-actions">
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body">
            <div class="donut-container">
              <p-chart type="doughnut" [data]="activityDonutData" [options]="activityDonutOptions" height="200px"></p-chart>
            </div>
            <div class="activity-breakdown-list">
              <div class="breakdown-item" *ngFor="let activity of activityBreakdown()">
                <div class="breakdown-icon" [class]="getActivityColor(activity.type)">
                  <i class="pi" [class]="getActivityIcon(activity.type)"></i>
                </div>
                <span class="breakdown-label">{{ activity.type }}s</span>
                <span class="breakdown-count">{{ activity.count }}</span>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Conversion Trend -->
        <ng-container *ngSwitchCase="'conversion'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="pi pi-percentage"></i>
              Conversion Trend
            </h3>
            <div class="card-actions">
              <span class="trend-badge up">
                <i class="pi pi-arrow-up"></i>
                +12%
              </span>
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body">
            <div class="chart-container small">
              <p-chart type="line" [data]="conversionChartData" [options]="conversionChartOptions" height="160px"></p-chart>
            </div>
            <div class="conversion-summary">
              <div class="summary-stat">
                      <span class="stat-value success">{{ summary().winRate }}%</span>
                <span class="stat-label">Win Rate</span>
              </div>
              <div class="summary-stat">
                    <span class="stat-value">{{ summary().avgSalesCycle }}d</span>
                <span class="stat-label">Avg Cycle</span>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Top Performers -->
        <ng-container *ngSwitchCase="'top-performers'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="pi pi-trophy"></i>
              Top Performers
            </h3>
            <div class="card-actions">
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body">
            <div class="performers-list">
              <div class="performer-row" *ngFor="let performer of topPerformers(); let i = index">
                <div class="performer-rank" [class.gold]="i === 0" [class.silver]="i === 1" [class.bronze]="i === 2">
                  {{ i + 1 }}
                </div>
                <div class="performer-avatar">
                  {{ performer.name.charAt(0) }}
                </div>
                <div class="performer-info">
                  <div class="performer-name">{{ performer.name }}</div>
                  <div class="performer-stats">
                    <span>{{ performer.deals }} deals</span>
                    <span class="separator">•</span>
                    <span class="revenue">{{ performer.revenue | currency:resolveCurrencyCode():'symbol':'1.0-0' }}</span>
                  </div>
                </div>
                <div class="performer-badge" *ngIf="i === 0">
                  <i class="pi pi-star-fill"></i>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- My Tasks -->
        <ng-container *ngSwitchCase="'my-tasks'">
          <div class="card-header priority-header">
            <div class="priority-header-left">
              <button class="priority-filter">
                <span class="priority-filter-label">Tasks:</span>
                <span class="priority-filter-value">Assigned to Me</span>
                <i class="pi pi-chevron-down"></i>
              </button>
            </div>
            <div class="priority-header-center">
              <h3 class="priority-header-title">My Tasks</h3>
              <span class="priority-header-subtitle">Priority Stream</span>
            </div>
            <div class="card-actions">
              <span class="card-badge" *ngIf="priorityStreamItems().length">{{ priorityStreamItems().length }} items</span>
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body">
            <div class="priority-summary">
              <button
                type="button"
                class="priority-summary-card overdue"
                [class.active]="priorityFilter() === 'overdue'"
                (click)="setPriorityFilter('overdue')"
              >
                <i class="pi pi-exclamation-circle"></i>
                <span>Overdue</span>
                <strong>{{ prioritySummary().overdue }}</strong>
              </button>
              <button
                type="button"
                class="priority-summary-card today"
                [class.active]="priorityFilter() === 'today'"
                (click)="setPriorityFilter('today')"
              >
                <i class="pi pi-calendar"></i>
                <span>Due Today</span>
                <strong>{{ prioritySummary().today }}</strong>
              </button>
              <button
                type="button"
                class="priority-summary-card warn"
                [class.active]="priorityFilter() === 'decisions'"
                (click)="setPriorityFilter('decisions')"
              >
                <i class="pi pi-inbox"></i>
                <span>Decisions</span>
                <strong>{{ prioritySummary().decisions }}</strong>
              </button>
              <button
                type="button"
                class="priority-summary-card warn"
                [class.active]="priorityFilter() === 'at-risk'"
                (click)="setPriorityFilter('at-risk')"
              >
                <i class="pi pi-flag"></i>
                <span>At-Risk Deals</span>
                <strong>{{ prioritySummary().atRisk }}</strong>
              </button>
              <button
                type="button"
                class="priority-summary-card info"
                [class.active]="priorityFilter() === 'no-next-step'"
                (click)="setPriorityFilter('no-next-step')"
              >
                <i class="pi pi-flag-fill"></i>
                <span>No Next Step</span>
                <strong>{{ prioritySummary().noNextStep }}</strong>
              </button>
            </div>
            <div class="priority-tabs">
              <button
                type="button"
                class="priority-tab"
                [class.active]="priorityFilter() === 'overdue'"
                (click)="setPriorityFilter('overdue')"
              >
                Overdue ({{ prioritySummary().overdue }})
              </button>
              <button
                type="button"
                class="priority-tab"
                [class.active]="priorityFilter() === 'today'"
                (click)="setPriorityFilter('today')"
              >
                Due Today ({{ prioritySummary().today }})
              </button>
              <button
                type="button"
                class="priority-tab"
                [class.active]="priorityFilter() === 'decisions'"
                (click)="setPriorityFilter('decisions')"
              >
                Decisions ({{ prioritySummary().decisions }})
              </button>
              <button
                type="button"
                class="priority-tab"
                [class.active]="priorityFilter() === 'new-leads'"
                (click)="setPriorityFilter('new-leads')"
              >
                New Leads ({{ prioritySummary().newLeads }})
              </button>
              <button
                type="button"
                class="priority-tab"
                [class.active]="priorityFilter() === 'at-risk'"
                (click)="setPriorityFilter('at-risk')"
              >
                At-Risk Deals ({{ prioritySummary().atRisk }})
              </button>
              <button
                type="button"
                class="priority-tab"
                [class.active]="priorityFilter() === 'no-next-step'"
                (click)="setPriorityFilter('no-next-step')"
              >
                No Next Step ({{ prioritySummary().noNextStep }})
              </button>
              <button
                type="button"
                class="priority-tab"
                [class.active]="priorityFilter() === 'all'"
                (click)="setPriorityFilter('all')"
              >
                All ({{ priorityStreamItems().length }})
              </button>
            </div>
            <div class="priority-list" *ngIf="filteredPriorityStreamItems().length; else emptyMyTasks">
              <div class="priority-item" *ngFor="let item of filteredPriorityStreamItems()">
                <div class="priority-main">
                  <div class="priority-marker" [class.overdue]="item.type === 'deal' || item.dueClass === 'due-overdue'">
                    <i class="pi" [ngClass]="{
                      'pi-exclamation-circle': item.type === 'deal' || item.dueClass === 'due-overdue',
                      'pi-check-square': item.type === 'task' && item.dueClass !== 'due-overdue',
                      'pi-user-plus': item.type === 'lead',
                      'pi-inbox': item.type === 'decision'
                    }"></i>
                  </div>
                  <div class="priority-details">
                    <div class="priority-title">{{ item.title }}</div>
                    <div class="priority-subtitle">{{ item.subtitle }}</div>
                    <div class="priority-meta">
                      <span *ngFor="let meta of item.meta">{{ meta }}</span>
                    </div>
                    <div class="priority-meta">
                      <span class="task-pill" [ngClass]="item.dueClass">{{ item.dueColumn }}</span>
                      <span class="task-pill status-pill" [class.overdue]="item.type === 'deal'">{{ item.status }}</span>
                    </div>
                  </div>
                </div>
                <div class="priority-actions">
                  <ng-container *ngIf="item.type !== 'decision'; else decisionAction">
                    <button type="button" class="priority-icon-btn" aria-label="Call">
                      <i class="pi pi-phone"></i>
                    </button>
                    <button type="button" class="priority-icon-btn" aria-label="Email">
                      <i class="pi pi-envelope"></i>
                    </button>
                    <button type="button" class="priority-complete-btn" (click)="onPriorityComplete(item)">Complete</button>
                  </ng-container>
                  <ng-template #decisionAction>
                    <button type="button" class="priority-complete-btn" (click)="onPriorityComplete(item)">Review</button>
                  </ng-template>
                </div>
              </div>
            </div>
          </div>
          <div
            class="resize-handle handle-s"
            (mousedown)="startResize($event, dashboardCard, 's')"
          ></div>
        </ng-container>

        <!-- Activity Timeline -->
        <ng-container *ngSwitchCase="'timeline'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="pi pi-clock"></i>
              Activity Timeline
            </h3>
            <div class="card-actions">
              <div class="timeline-filter">
                <button pButton type="button" class="filter-btn active">All</button>
                <button pButton type="button" class="filter-btn">Calls</button>
                <button pButton type="button" class="filter-btn">Tasks</button>
              </div>
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body" *ngIf="upcomingActivities().length; else emptyActivities">
            <div class="timeline">
              <div class="timeline-item" *ngFor="let activity of upcomingActivities(); let last = last"
                   [class.overdue]="activity.status === 'Overdue'">
                <div class="timeline-marker"
                     [class.call]="activity.type === 'Call'"
                     [class.email]="activity.type === 'Email'"
                     [class.meeting]="activity.type === 'Meeting'"
                     [class.task]="activity.type === 'Task'">
                  <i class="pi"
                     [class.pi-phone]="activity.type === 'Call'"
                     [class.pi-envelope]="activity.type === 'Email'"
                     [class.pi-video]="activity.type === 'Meeting'"
                     [class.pi-check-square]="activity.type === 'Task'"></i>
                </div>
                <div class="timeline-connector" *ngIf="!last"></div>
                <div class="timeline-content">
                  <div class="timeline-header">
                    <span class="timeline-type">{{ activity.type }}</span>
                    <span class="timeline-time" [class.overdue]="activity.status === 'Overdue'">
                      {{ asLocalDate(activity.dueDateUtc) | date: 'MMM d, h:mm a' }}
                    </span>
                  </div>
                  <div class="timeline-subject">{{ activity.subject }}</div>
                  <div class="timeline-entity" *ngIf="activity.relatedEntityName">
                    <i class="pi pi-link"></i>
                    {{ activity.relatedEntityName }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- Quick Stats -->
        <ng-container *ngSwitchCase="'health'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="pi pi-heart"></i>
              Business Health
            </h3>
            <div class="card-actions">
              <ng-container *ngTemplateOutlet="cardControls; context: { $implicit: cardId }"></ng-container>
            </div>
          </div>
          <div class="card-body">
            <div class="health-meter">
              <svg viewBox="0 0 120 120" class="circular-progress">
                <circle cx="60" cy="60" r="54" class="progress-bg"></circle>
                <circle cx="60" cy="60" r="54" class="progress-fill"
                        [style.stroke-dasharray]="getHealthProgress()"></circle>
              </svg>
              <div class="health-value">
                <span class="health-number">{{ activityStats().completion }}</span>
                <span class="health-unit">%</span>
              </div>
            </div>
            <div class="health-label">Tasks On Track</div>
            <div class="health-breakdown">
              <div class="breakdown-row">
                <span class="breakdown-dot success"></span>
                <span class="breakdown-text">Upcoming</span>
                <span class="breakdown-value">{{ activityStats().upcoming }}</span>
              </div>
              <div class="breakdown-row">
                <span class="breakdown-dot danger"></span>
                <span class="breakdown-text">Overdue</span>
                <span class="breakdown-value">{{ activityStats().overdue }}</span>
              </div>
            </div>
            <div class="health-metrics">
              <div class="health-metric">
                <i class="pi pi-heart-fill"></i>
                <div class="metric-content">
                    <span class="metric-value">{{ summary().customerLifetimeValue | currency:resolveCurrencyCode():'symbol':'1.0-0' }}</span>
                  <span class="metric-label">Avg CLV</span>
                </div>
              </div>
              <div class="health-metric">
                <i class="pi pi-sync"></i>
                <div class="metric-content">
                    <span class="metric-value">{{ summary().churnRate }}%</span>
                  <span class="metric-label">Churn Rate</span>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
        <!-- Resizing disabled: keep cards at consistent sizes, allow only drag ordering. -->
      </article>
    </section>

    <!-- Charts Row -->
    <section
      class="charts-row"
      cdkDropList
      [cdkDropListData]="chartOrder"
      (cdkDropListDropped)="onChartDrop($event)"
      cdkDropListOrientation="horizontal"
    >
      <ng-container *ngFor="let chartId of chartOrder">
        <article
          *ngIf="isChartVisible(chartId)"
          class="glass-card chart-card chart-card--resizable card-resizable"
          cdkDrag
          #chartCard
          [attr.data-card-id]="chartId"
          [ngClass]="[getChartSizeClass(chartId), chartId === 'revenue' ? 'large' : '']"
          [ngStyle]="getCardDimensions(chartId)"
          [attr.data-min-width]="chartId === 'revenue' ? 320 : 280"
          [attr.data-min-height]="chartId === 'revenue' ? 320 : 280"
        >
          <ng-container [ngSwitch]="chartId">
            <ng-container *ngSwitchCase="'revenue'">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="pi pi-chart-line"></i>
                  Revenue Trend
                </h3>
                <div class="card-actions">
                  <div class="chart-legend">
                    <span class="legend-item primary">
                      <span class="legend-dot"></span>
                      Revenue
                    </span>
                  </div>
                  <ng-container *ngTemplateOutlet="chartControls; context: { $implicit: chartId }"></ng-container>
                </div>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <p-chart type="line" [data]="revenueChartData" [options]="revenueChartOptions" height="100%"></p-chart>
                </div>
              </div>
            </ng-container>
            <ng-container *ngSwitchCase="'growth'">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="pi pi-users"></i>
                  Customer Growth
                </h3>
                <div class="card-actions">
                  <ng-container *ngTemplateOutlet="chartControls; context: { $implicit: chartId }"></ng-container>
                </div>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <p-chart type="bar" [data]="customerGrowthData" [options]="customerGrowthOptions" height="100%"></p-chart>
                </div>
              </div>
            </ng-container>
          </ng-container>
        </article>
      </ng-container>
    </section>
  </div>
</div>

      </div>
    </div>

<ng-template #emptyMyTasks>
  <div class="empty-state">
    <div class="empty-icon">
      <i class="pi pi-check-square"></i>
    </div>
    <h4>No priority items</h4>
    <p>Tasks, new leads, and at‑risk deals will appear here</p>
  </div>
</ng-template>

<ng-template #emptyAccounts>
  <div class="empty-state">
    <div class="empty-icon">
      <i class="pi pi-building"></i>
    </div>
    <h4>No recent accounts</h4>
    <p>New accounts will appear here</p>
  </div>
</ng-template>


<ng-template #emptyManagerHealth>
  <div class="empty-state">
    <div class="empty-icon">
      <i class="pi pi-briefcase"></i>
    </div>
    <h4>Pipeline looks clean</h4>
    <p>No deals require manager review right now</p>
  </div>
</ng-template>

<ng-template #emptyActivities>
  <div class="empty-state">
    <div class="empty-icon">
      <i class="pi pi-calendar"></i>
    </div>
    <h4>All clear!</h4>
    <p>No upcoming activities scheduled</p>
  </div>
</ng-template>

<ng-template #emptyRiskFlags>
  <div class="empty-state">
    <div class="empty-icon">
      <i class="pi pi-shield"></i>
    </div>
    <h4>No risk flags</h4>
    <p>Pipeline risk signals will appear here</p>
  </div>
</ng-template>

<ng-template #emptyExecutionGuide>
  <div class="empty-state">
    <div class="empty-icon">
      <i class="pi pi-compass"></i>
    </div>
    <h4>No execution prompts</h4>
    <p>Execution guidance will appear here</p>
  </div>
</ng-template>

<ng-template #cardControls let-cardId>
  <div class="card-controls">
    <button
      pButton
      type="button"
      class="btn-icon-sm card-control"
      icon="pi pi-times"
      (click)="hideCard(cardId)"
      aria-label="Hide card"
    ></button>
    <button
      pButton
      type="button"
      class="btn-icon-sm card-control drag-handle"
      icon="pi pi-bars"
      cdkDragHandle
      aria-label="Reorder card"
    ></button>
  </div>
</ng-template>

<ng-template #chartControls let-chartId>
  <div class="card-controls">
    <button
      pButton
      type="button"
      class="btn-icon-sm card-control"
      icon="pi pi-times"
      (click)="hideChart(chartId)"
      aria-label="Hide chart"
    ></button>
    <button
      pButton
      type="button"
      class="btn-icon-sm card-control drag-handle"
      icon="pi pi-bars"
      cdkDragHandle
      aria-label="Reorder chart"
    ></button>
  </div>
</ng-template>

<p-dialog
  header="Cost of Not Knowing - Deal Breakdown"
  [(visible)]="costBreakdownDialogOpen"
  [modal]="true"
  [dismissableMask]="true"
  [draggable]="false"
  [resizable]="false"
  appendTo="body"
  [style]="{ width: 'min(720px, 95vw)' }"
  [contentStyle]="{ maxHeight: '70vh', overflow: 'auto' }"
>
  <div class="cost-breakdown-dialog">
    <div class="dialog-controls">
      <label for="cost-sort">Sort by</label>
      <select id="cost-sort" class="dialog-select" [(ngModel)]="costBreakdownSortKey">
        <option value="exposure">Exposure</option>
        <option value="amount">Deal amount</option>
        <option value="stage">Stage</option>
        <option value="name">Opportunity</option>
      </select>
      <button type="button" class="btn btn-ghost btn-sm" (click)="toggleCostBreakdownSortDirection()">
        {{ costBreakdownSortDirection === 'asc' ? 'Ascending' : 'Descending' }}
      </button>
    </div>

    <div class="cost-breakdown-list" *ngIf="summary().costOfNotKnowingBreakdown.length; else noCostBreakdown">
      <div class="cost-breakdown-row" *ngFor="let deal of costBreakdownSorted()">
        <div class="cost-breakdown-main">
          <div class="cost-breakdown-name">{{ deal.opportunityName }}</div>
          <div class="cost-breakdown-meta">{{ deal.accountName }} • {{ deal.stage }}</div>
          <div class="cost-breakdown-factors">
            <span class="cost-factor" *ngFor="let factor of deal.topFactors">
              {{ factor.label }}: {{ factor.contribution | currency:resolveCurrencyCode():'symbol':'1.0-0' }}
            </span>
          </div>
        </div>
        <div class="cost-breakdown-values">
          <div class="cost-breakdown-amount">
            {{ deal.amount | currency:resolveCurrencyCode():'symbol':'1.0-0' }}
          </div>
          <div class="cost-breakdown-exposure">
            {{ deal.costOfNotKnowingValue | currency:resolveCurrencyCode():'symbol':'1.0-0' }}
          </div>
        </div>
      </div>
    </div>

    <ng-template #noCostBreakdown>
      <div class="empty-state">
        <div class="empty-icon">
          <i class="pi pi-shield"></i>
        </div>
        <h4>No exposure breakdown</h4>
        <p>Cost of Not Knowing details will appear once there are active opportunities.</p>
      </div>
    </ng-template>
  </div>
  <ng-template pTemplate="footer">
    <div class="layout-actions">
      <button pButton type="button" class="btn-glass" (click)="closeCostBreakdownDialog()">Close</button>
    </div>
  </ng-template>
</p-dialog>


<p-dialog
  header="Customize Command Center"
  [(visible)]="layoutDialogOpen"
  [modal]="true"
  [dismissableMask]="true"
  [draggable]="true"
  [resizable]="true"
  [maximizable]="true"
  appendTo="body"
  [style]="{ width: 'min(960px, 92vw)' }"
  [contentStyle]="{ maxHeight: '70vh', overflow: 'auto' }"
  [styleClass]="'layout-dialog'"
  >
  <p>Drag cards to reorder your Command Center view.</p>
  <p-orderList
    [value]="layoutDraft"
    [dragdrop]="true"
    [listStyle]="{ height: '320px' }"
    [metaKeySelection]="false"
  >
    <ng-template pTemplate="item" let-card>
      <div class="layout-item">
        <i class="pi" [class]="card.icon"></i>
        <span>{{ card.label }}</span>
      </div>
    </ng-template>
  </p-orderList>
  <div class="layout-chart-section">
    <h4>Command Center cards ({{ activePackName() }})</h4>
    <div class="layout-chart-list">
      <label class="layout-chart-item" *ngFor="let card of selectableCards()">
        <input
          type="checkbox"
          [ngModel]="isCardVisible(card.id)"
          (ngModelChange)="onCardVisibilityChange(card.id, $event)"
        />
        <i class="pi" [class]="card.icon"></i>
        <span>{{ card.label }}</span>
      </label>
    </div>
  </div>
  <div class="layout-chart-section" *ngIf="selectableCharts().length > 0">
    <h4>Chart cards</h4>
    <div class="layout-chart-list">
      <label class="layout-chart-item" *ngFor="let chart of selectableCharts()">
        <input
          type="checkbox"
          [ngModel]="isChartVisible(chart.id)"
          (ngModelChange)="onChartVisibilityChange(chart.id, $event)"
        />
        <i class="pi" [class]="chart.icon"></i>
        <span>{{ chart.label }}</span>
      </label>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <div class="layout-actions">
      <button pButton type="button" class="btn-glass" (click)="resetLayout()">Reset to role default</button>
      <button pButton type="button" class="btn-gradient" (click)="saveLayout()">Save layout</button>
    </div>
  </ng-template>
</p-dialog>

<p-dialog
  header="Coach Deal"
  [(visible)]="coachingDialogOpen"
  [modal]="true"
  [dismissableMask]="true"
  [draggable]="false"
  [resizable]="false"
  appendTo="body"
  [style]="{ width: 'min(560px, 92vw)' }"
  [contentStyle]="{ overflow: 'visible' }"
>
  <div class="coaching-dialog">
    <label class="coaching-label" for="coach-comment">Manager comment</label>
    <textarea
      id="coach-comment"
      class="coaching-textarea"
      [(ngModel)]="coachingComment"
      rows="4"
      placeholder="Give clear direction and the next action you expect."
    ></textarea>

    <div class="coaching-row">
      <div class="coaching-field">
        <label class="coaching-label" for="coach-due">Due date</label>
        <input id="coach-due" type="datetime-local" class="coaching-input" [(ngModel)]="coachingDueLocal" />
      </div>
      <div class="coaching-field coaching-field--sm">
        <label class="coaching-label" for="coach-priority">Priority</label>
        <select id="coach-priority" class="coaching-input" [(ngModel)]="coachingPriority">
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>
      </div>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <div class="coaching-actions">
      <button pButton type="button" class="btn-glass" (click)="closeCoaching()" [disabled]="coachingSubmitting">Cancel</button>
      <button pButton type="button" class="btn-gradient" (click)="submitCoaching()" [disabled]="coachingSubmitting || !coachingComment.trim()">
        {{ coachingSubmitting ? 'Sending...' : 'Create task' }}
      </button>
    </div>
  </ng-template>
</p-dialog>
