<section class="page-background">
  <div class="animated-orb orb-1"></div>
  <div class="animated-orb orb-2"></div>
  <div class="animated-orb orb-3"></div>

  <app-breadcrumbs></app-breadcrumbs>

  <header class="page-hero">
    <div class="hero-content">
      <span class="hero-eyebrow">
        <i class="pi pi-th-large"></i>
        Dashboard packs
      </span>
      <h1 class="hero-title">
        <span class="title-gradient">Role</span>
        <span class="title-light">+ Custom Dashboard Packs</span>
      </h1>
      <p class="hero-subtitle">
        Manage role-level defaults and custom packs with one liquid-glass table for KPI cards and chart widgets.
      </p>
    </div>
  </header>

  <div class="summary-strip">
    <div class="summary-pill">
      <span class="pill-label">Mode</span>
      <strong>{{ mode() === 'role-level' ? 'Role Level' : 'Custom Pack' }}</strong>
    </div>
    <div class="summary-pill">
      <span class="pill-label">KPI Cards</span>
      <strong>{{ selectedKpiCount() }}</strong>
    </div>
    <div class="summary-pill">
      <span class="pill-label">Chart Widgets</span>
      <strong>{{ selectedChartCount() }}</strong>
    </div>
  </div>

  <div class="glass-card pack-card">
    <div class="pack-header">
      <div class="pack-title">
        <h2>Dashboard pack designer</h2>
        <p>Define pack name, include/exclude cards, and control display order.</p>
      </div>
      <div class="pack-actions">
        <button
          pButton
          type="button"
          class="mode-btn"
          [class.is-active]="mode() === 'role-level'"
          (click)="setMode('role-level')"
        >
          Role Level
        </button>
        <button
          pButton
          type="button"
          class="mode-btn"
          [class.is-active]="mode() === 'custom'"
          (click)="setMode('custom')"
        >
          Custom Pack
        </button>
      </div>
    </div>

    <div class="pack-meta-row" *ngIf="mode() === 'role-level'; else customPackMeta">
      <p-select
        appendTo="body"
        [options]="availableLevels()"
        optionLabel="label"
        optionValue="value"
        [ngModel]="selectedLevel()"
        (ngModelChange)="onLevelChange($event)"
        [disabled]="loadingRoles()"
        placeholder="Select H1/H2/H3"
        styleClass="level-select"
      ></p-select>

      <input
        type="text"
        pInputText
        class="pack-name-input"
        [ngModel]="levelPackName()"
        (ngModelChange)="levelPackName.set($event)"
        [disabled]="!selectedLevel()"
        placeholder="Role-level pack name"
      />

      <button
        pButton
        type="button"
        class="btn-gradient"
        [disabled]="savingPack() || !selectedLevel()"
        (click)="savePack()"
      >
        Save Role-Level Pack
      </button>
    </div>

    <ng-template #customPackMeta>
      <div class="pack-meta-row">
        <p-select
          appendTo="body"
          [options]="customPackOptions()"
          optionLabel="label"
          optionValue="value"
          [ngModel]="selectedCustomPackId()"
          (ngModelChange)="onCustomPackChange($event)"
          [disabled]="loadingTemplates()"
          placeholder="Select custom pack"
          styleClass="level-select"
        ></p-select>

        <input
          type="text"
          pInputText
          class="pack-name-input"
          [ngModel]="customPackName()"
          (ngModelChange)="customPackName.set($event)"
          placeholder="Custom pack name"
        />

        <button pButton type="button" class="btn-outline" (click)="createNewCustomPack()">
          New
        </button>

        <button pButton type="button" class="btn-gradient" [disabled]="savingPack()" (click)="savePack()">
          Save Custom Pack
        </button>
      </div>
    </ng-template>

    <div class="pack-body" *ngIf="!loadingPack(); else loadingState">
      <div class="pack-subtitle">Cards and widgets table (display order)</div>
      <div class="kpi-table-wrap">
        <table class="kpi-table" aria-label="Dashboard cards and widgets order table">
          <thead>
            <tr>
              <th class="col-toggle">Include</th>
              <th class="col-order">Order</th>
              <th class="col-type">Type</th>
              <th>Name</th>
              <th class="col-id">Id</th>
              <th class="col-suggested">Suggested Usage</th>
              <th class="col-move">Move</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of tableRows()" [class.row-disabled]="!row.checked">
              <td class="col-toggle">
                <p-checkbox
                  [binary]="true"
                  [ngModel]="row.checked"
                  (ngModelChange)="toggleItem(row.id, $event)"
                ></p-checkbox>
              </td>
              <td class="col-order">
                <span class="order-badge" *ngIf="row.order; else noOrder">{{ row.order }}</span>
                <ng-template #noOrder>
                  <span class="order-empty">-</span>
                </ng-template>
              </td>
              <td class="col-type">
                <span class="type-pill" [class.type-pill--chart]="row.type === 'chart'">
                  {{ row.type === 'kpi' ? 'KPI' : 'Chart' }}
                </span>
              </td>
              <td>
                <div class="row-meta">
                  <div class="card-icon"><i class="pi" [class]="row.icon"></i></div>
                  <span class="card-title">{{ row.label }}</span>
                </div>
              </td>
              <td class="col-id">{{ row.id }}</td>
              <td class="col-suggested">
                <span class="suggested-usage">{{ row.suggestedUsage }}</span>
              </td>
              <td class="col-move">
                <button
                  pButton
                  type="button"
                  icon="pi pi-angle-up"
                  class="action-btn p-button-text p-button-rounded p-button-sm p-button-secondary"
                  [disabled]="!row.checked || !row.canMoveUp"
                  (click)="moveItem(row.id, -1)"
                  title="Move up"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-angle-down"
                  class="action-btn p-button-text p-button-rounded p-button-sm p-button-secondary"
                  [disabled]="!row.checked || !row.canMoveDown"
                  (click)="moveItem(row.id, 1)"
                  title="Move down"
                ></button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <ng-template #loadingState>
      <div class="loading-state">Loading pack...</div>
    </ng-template>
  </div>
</section>
