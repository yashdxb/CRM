<div class="page-background">
  <div class="animated-orb orb-1"></div>
  <div class="animated-orb orb-2"></div>
  <div class="animated-orb orb-3"></div>
</div>

<div class="page-container">
  <div class="page-content">
    <app-breadcrumbs></app-breadcrumbs>

    <header class="page-hero">
      <div class="hero-content">
        <span class="hero-eyebrow">
          <i class="pi pi-shield"></i>
          Audit Log
        </span>
        <h1 class="hero-title">
          <span class="title-gradient">Security</span>
          <span class="title-light">& Activity Trail</span>
        </h1>
        <p class="hero-subtitle">
          Track critical changes across CRM records with time, user, and context.
        </p>
      </div>
      <div class="hero-actions">
        <button pButton type="button" class="crm-button crm-button--ghost" (click)="onSearch()">
          Refresh
        </button>
        <button pButton type="button" class="crm-button crm-button--primary" (click)="resetFilters()">
          Reset filters
        </button>
      </div>
    </header>

    <div class="glass-card filter-panel">
      <div class="filter-grid">
        <div class="filter-field">
          <label>Search</label>
          <input
            pInputText
            placeholder="Entity id, field, value, or notes"
            [ngModel]="search()"
            (ngModelChange)="search.set($event)"
            class="w-full"
          />
        </div>
        <div class="filter-field">
          <label>Entity</label>
          <p-select
            [options]="entityOptions"
            optionLabel="label"
            optionValue="value"
            [ngModel]="entityType()"
            (ngModelChange)="entityType.set($event || null)"
            placeholder="All entities"
            appendTo="body"
            styleClass="w-full"
          ></p-select>
        </div>
        <div class="filter-field">
          <label>Action</label>
          <p-select
            [options]="actionOptions"
            optionLabel="label"
            optionValue="value"
            [ngModel]="action()"
            (ngModelChange)="action.set($event || null)"
            placeholder="All actions"
            appendTo="body"
            styleClass="w-full"
          ></p-select>
        </div>
        <div class="filter-field">
          <label>User</label>
          <p-select
            [options]="userOptions"
            optionLabel="label"
            optionValue="value"
            [ngModel]="userId()"
            (ngModelChange)="userId.set($event || null)"
            placeholder="All users"
            appendTo="body"
            styleClass="w-full"
          ></p-select>
        </div>
        <div class="filter-field">
          <label>From</label>
          <p-datepicker
            [ngModel]="fromDate()"
            (ngModelChange)="fromDate.set($event || null)"
            dateFormat="yy-mm-dd"
            [showIcon]="true"
            appendTo="body"
            styleClass="w-full"
          ></p-datepicker>
        </div>
        <div class="filter-field">
          <label>To</label>
          <p-datepicker
            [ngModel]="toDate()"
            (ngModelChange)="toDate.set($event || null)"
            dateFormat="yy-mm-dd"
            [showIcon]="true"
            appendTo="body"
            styleClass="w-full"
          ></p-datepicker>
        </div>
        <div class="filter-actions">
          <button pButton type="button" class="crm-button crm-button--primary" (click)="onSearch()">
            Apply filters
          </button>
        </div>
      </div>
    </div>

    <div class="glass-card table-panel">
      <p-table
        [value]="items()"
        [loading]="loading()"
        [rowHover]="true"
        dataKey="id"
        styleClass="audit-table"
      >
        <ng-template pTemplate="header">
          <tr>
            <th class="col-time">Time</th>
            <th class="col-entity">Entity</th>
            <th class="col-action">Action</th>
            <th class="col-change">Change</th>
            <th class="col-user">User</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td class="col-time">
              <div class="time-cell">{{ item.createdAtUtc | date:'medium' }}</div>
            </td>
            <td class="col-entity">
              <div class="entity-cell">
                <span class="entity-type">{{ item.entityType }}</span>
                <span class="entity-id" *ngIf="item.entityId">{{ item.entityId }}</span>
              </div>
            </td>
            <td class="col-action">
              <p-tag [value]="item.action" [severity]="auditTagSeverity(item.action)"></p-tag>
            </td>
            <td class="col-change">
              <div class="change-cell" pTooltip="{{ changeDetail(item) }}" tooltipPosition="top">
                {{ changeSummary(item) }}
              </div>
              <div class="change-notes" *ngIf="item.notes">{{ item.notes }}</div>
            </td>
            <td class="col-user">
              <div class="user-cell">
                <span class="user-name">{{ item.changedByName || 'System' }}</span>
                <span class="user-email" *ngIf="item.changedByUserId">{{ item.changedByUserId }}</span>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5">
              <div class="empty-state">
                <i class="pi pi-clipboard"></i>
                <div>
                  <div class="empty-title">No audit activity yet</div>
                  <div class="empty-subtitle">Try adjusting filters or check back later.</div>
                </div>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>

      <div class="table-footer">
        <div class="footer-summary">
          Showing {{ items().length }} of {{ total() }} events
        </div>
        <p-paginator
          [rows]="pageSize()"
          [totalRecords]="total()"
          [first]="(page() - 1) * pageSize()"
          [rowsPerPageOptions]="[10, 20, 50]"
          (onPageChange)="onPageChange($event)"
        ></p-paginator>
      </div>
    </div>
  </div>
</div>
