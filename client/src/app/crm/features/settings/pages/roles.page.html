<!-- ═══════════════════════════════════════════════════════════════════════════
     ROLES PAGE - Premium Light UI
     ═══════════════════════════════════════════════════════════════════════════ -->
<div class="page-container">
  <!-- PrimeNG Breadcrumb -->
  <app-breadcrumbs></app-breadcrumbs>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       HERO SECTION
       ═══════════════════════════════════════════════════════════════════════════ -->
  <section class="hero-section">
    <div class="hero-content">
      <div class="hero-badge">
        <span class="badge-dot"></span>
        <span>Access Control</span>
      </div>
      
      <h1 class="hero-title">
        <span class="title-gradient">Role</span>
        <span class="title-light">Management</span>
      </h1>
      
      <p class="hero-description">
        
      </p>

      <div class="hero-stats">
        <div class="hero-stat">
          <div class="stat-value">{{ roles().length }}</div>
          <div class="stat-label">Total Roles</div>
          <div class="stat-bar">
            <div class="stat-bar-fill" style="width: 100%"></div>
          </div>
        </div>
        <div class="hero-stat">
          <div class="stat-value">{{ systemRolesCount() }}</div>
          <div class="stat-label">System</div>
          <div class="stat-bar">
            <div class="stat-bar-fill stat-bar-fill--warning" [style.width.%]="roles().length ? (systemRolesCount() / roles().length) * 100 : 0"></div>
          </div>
        </div>
        <div class="hero-stat">
          <div class="stat-value">{{ customRolesCount() }}</div>
          <div class="stat-label">Custom</div>
          <div class="stat-bar">
            <div class="stat-bar-fill stat-bar-fill--success" [style.width.%]="roles().length ? (customRolesCount() / roles().length) * 100 : 0"></div>
          </div>
        </div>
        <div class="hero-stat">
          <div class="stat-value">{{ permissionCatalog().length }}</div>
          <div class="stat-label">Permissions</div>
          <div class="stat-bar">
            <div class="stat-bar-fill stat-bar-fill--info" style="width: 100%"></div>
          </div>
        </div>
      </div>

      <div class="hero-actions">
        <button pButton type="button" class="btn btn-primary" [disabled]="roleSaving() || !canManageAdmin()" routerLink="/app/settings/roles/new">
          <i class="pi pi-plus"></i>
          <span>New Role</span>
        </button>
        <button pButton type="button" class="btn btn-secondary" [disabled]="!canManageAdmin()" routerLink="/app/settings/security-levels">
          <i class="pi pi-lock"></i>
          <span>Manage Security Levels</span>
        </button>
        <button pButton type="button" class="btn btn-secondary" routerLink="/app/settings/users">
          <i class="pi pi-users"></i>
          <span>Manage Users</span>
        </button>
        <button pButton type="button" class="btn btn-ghost" (click)="loadRoles()">
          <i class="pi pi-refresh"></i>
          <span>Refresh</span>
        </button>
      </div>
    </div>

    <div class="hero-visual">
      <div class="visual-card visual-card--primary">
        <div class="card-icon">
          <i class="pi pi-shield"></i>
        </div>
        <div class="card-content">
          <span class="card-label">Access Profiles</span>
          <strong class="card-value">{{ roles().length }}</strong>
          <span class="card-trend">
            <i class="pi pi-lock"></i> Auditable permissions
          </span>
        </div>
      </div>

      <div class="visual-card visual-card--secondary">
        <div class="card-icon">
          <i class="pi pi-lock"></i>
        </div>
        <div class="card-content">
          <span class="card-label">Default Security Level</span>
          <strong class="card-value">{{ defaultSecurityLevelName() }}</strong>
          <span class="card-trend">
            <i class="pi pi-check-circle"></i> Tenant-defined access tier
          </span>
        </div>
      </div>
    </div>
  </section>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       DATA SECTION
       ═══════════════════════════════════════════════════════════════════════════ -->
  <section class="data-section">
    <div class="data-card workspace-card">
      <p-tabs [value]="activeWorkspaceTab()" (valueChange)="onWorkspaceTabChange($event)">
        <p-tablist>
          <p-tab value="directory">
            <i class="pi pi-sitemap"></i>
            <span>Directory</span>
          </p-tab>
          <p-tab value="presets">
            <i class="pi pi-th-large"></i>
            <span>Presets</span>
          </p-tab>
          <p-tab value="drift">
            <i class="pi pi-sliders-h"></i>
            <span>Drift</span>
          </p-tab>
        </p-tablist>
        <p-tabpanels>
          <p-tabpanel value="directory">
            <div class="data-header">
              <div class="header-title">
                <h2>Role Directory</h2>
                <span class="record-count">{{ roles().length }} roles configured</span>
              </div>
              <div class="view-toggle view-toggle--segmented" data-testid="roles-directory-view-toggle">
                <button
                  pButton
                  type="button"
                  class="toggle-btn"
                  [class.active]="!showHierarchy()"
                  [attr.aria-pressed]="!showHierarchy()"
                  data-testid="roles-view-list"
                  (click)="toggleView('list')"
                >
                  List
                </button>
                <button
                  pButton
                  type="button"
                  class="toggle-btn"
                  [class.active]="showHierarchy()"
                  [attr.aria-pressed]="showHierarchy()"
                  data-testid="roles-view-hierarchy"
                  (click)="toggleView('hierarchy')"
                >
                  Hierarchy
                </button>
              </div>
              <div class="header-actions">
                <button pButton type="button" class="action-btn action-btn--primary" [disabled]="roleSaving() || !canManageAdmin()" routerLink="/app/settings/roles/new">
                  <i class="pi pi-plus"></i>
                  <span>Add Role</span>
                </button>
                <button pButton type="button" class="action-btn" (click)="loadRoles()" [disabled]="loadingRoles()">
                  <i class="pi pi-refresh"></i>
                  <span>Reload</span>
                </button>
              </div>
            </div>

            <div class="loading-state" *ngIf="loadingRoles()">
              <div class="skeleton-row" *ngFor="let _ of [0, 1, 2, 3, 4]">
                <div class="skeleton skeleton-avatar"></div>
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text skeleton-short"></div>
                <div class="skeleton skeleton-badge"></div>
                <div class="skeleton skeleton-actions"></div>
              </div>
            </div>

            <div class="empty-state" *ngIf="!loadingRoles() && roles().length === 0">
              <div class="empty-icon">
                <i class="pi pi-shield"></i>
              </div>
              <h3>No roles configured</h3>
              <p>Create your first role to start managing access control</p>
              <button pButton type="button" class="btn btn-primary" routerLink="/app/settings/roles/new">
                <i class="pi pi-plus"></i>
                Create Role
              </button>
            </div>

            <div class="table-wrapper table-wrapper--roles" *ngIf="!loadingRoles() && roles().length > 0 && !showHierarchy()">
              <p-table
                class="data-table roles-directory-table"
                [value]="roles()"
                [tableStyle]="{ 'min-width': '72rem' }"
                responsiveLayout="scroll"
                [scrollable]="true"
                [scrollHeight]="rolesTableScrollHeight()"
                [paginator]="true"
                [rows]="rolesPageSize()"
                [first]="rolesFirst()"
                [rowsPerPageOptions]="rolesPageSizeOptions"
                [showCurrentPageReport]="true"
                currentPageReportTemplate="Showing {first} to {last} of {totalRecords} roles"
                (onPage)="handleRolesPage($event)"
              >
                <ng-template pTemplate="header">
                  <tr>
                    <th class="th-role">Role</th>
                    <th>Hierarchy</th>
                    <th>Security Level</th>
                    <th>Permissions</th>
                    <th>Type</th>
                    <th class="th-actions">Actions</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-role>
                  <tr class="table-row" [class.row-system]="role.isSystem">
                    <td>
                      <div class="td-role">
                        <div class="role-icon" [ngClass]="getRoleIconStyle(role)">
                          <i [class]="getRoleIcon(role)"></i>
                        </div>
                        <div class="role-info">
                          <span class="role-name">{{ role.name }}</span>
                          <span class="role-description">{{ role.description || 'No description provided' }}</span>
                        </div>
                      </div>
                    </td>
                    <td>
                      <span class="status-badge status-badge--info">
                        {{ role.hierarchyLevel ? ('H' + role.hierarchyLevel) : 'H1' }}
                      </span>
                    </td>
                    <td>
                      <ng-container *ngIf="securityLevelForRole(role) as level; else unassignedSecurityLevel">
                        <span class="status-badge status-badge--security">
                          {{ level.name }}
                          <span class="status-badge__sub">R{{ level.rank }}</span>
                        </span>
                      </ng-container>
                      <ng-template #unassignedSecurityLevel>
                        <span class="status-badge">Unassigned</span>
                      </ng-template>
                    </td>
                    <td>
                      <div class="permission-pills">
                        <span class="permission-pill" *ngFor="let permission of role.permissions.slice(0, 3)">
                          {{ permissionLabel(permission) }}
                        </span>
                        <span class="permission-pill permission-pill--more" *ngIf="role.permissions.length > 3">
                          +{{ role.permissions.length - 3 }} more
                        </span>
                      </div>
                    </td>
                    <td>
                      <span class="status-badge" [class.status-badge--warning]="role.isSystem" [class.status-badge--success]="!role.isSystem">
                        {{ role.isSystem ? 'System' : 'Custom' }}
                      </span>
                    </td>
                    <td class="td-actions">
                      <div class="action-buttons">
                        <button
                          pButton
                          type="button"
                          class="action-icon"
                          pTooltip="Edit role"
                          tooltipPosition="top"
                          [disabled]="!canManageAdmin()"
                          [routerLink]="['/app/settings/roles', role.id, 'edit']"
                        >
                          <i class="pi pi-pencil"></i>
                        </button>
                        <button
                          pButton
                          type="button"
                          class="action-icon action-icon--danger"
                          pTooltip="Delete role"
                          tooltipPosition="top"
                          [disabled]="role.isSystem || roleSaving() || !canManageAdmin()"
                          (click)="deleteRole(role)"
                        >
                          <i class="pi pi-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>

            <div class="orgchart-wrapper" *ngIf="!loadingRoles() && roles().length > 0 && showHierarchy()">
              <p-organizationChart [value]="orgChartNodes()" selectionMode="single">
                <ng-template pTemplate="person" let-node>
                  <div class="org-node">
                    <div class="org-title">
                      <span class="org-name">{{ node.data?.name }}</span>
                      <span class="org-badges">
                        <span class="org-badge">H{{ node.data?.hierarchyLevel || '—' }}</span>
                      </span>
                    </div>
                    <div class="org-meta">
                      <span class="org-desc">{{ node.data?.description || 'No description' }}</span>
                    </div>
                  </div>
                </ng-template>
              </p-organizationChart>
            </div>
          </p-tabpanel>

          <p-tabpanel value="presets">
            <div class="security-levels-section">
              <div class="security-levels-header">
                <div class="security-levels-title">
                  <h3>Role Presets</h3>
                  <span class="record-count">Intent packs and hierarchy presets for fast role creation</span>
                </div>
                <div class="security-levels-actions">
                  <button pButton type="button" class="btn btn-ghost" [disabled]="loadingIntentPacks()" (click)="loadIntentPacks()">
                    <i class="pi pi-refresh"></i>
                    <span>Reload intents</span>
                  </button>
                  <button pButton type="button" class="btn btn-ghost" [disabled]="loadingPermissionPackPresets()" (click)="loadPermissionPackPresets()">
                    <i class="pi pi-refresh"></i>
                    <span>Reload presets</span>
                  </button>
                  <button pButton type="button" class="btn btn-primary" routerLink="/app/settings/roles/new" [disabled]="!canManageAdmin()">
                    <i class="pi pi-plus"></i>
                    <span>New Role</span>
                  </button>
                </div>
              </div>

              <div class="table-wrapper">
                <p-table [value]="intentPacks()" styleClass="data-table security-level-table" responsiveLayout="scroll">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Intent Pack</th>
                      <th>Description</th>
                      <th>Permissions</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-pack>
                    <tr>
                      <td>{{ pack.label }}</td>
                      <td>{{ pack.description }}</td>
                      <td><span class="status-badge status-badge--info">{{ pack.permissions.length }} permissions</span></td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>

              <div class="table-wrapper">
                <p-table [value]="permissionPackPresets()" styleClass="data-table security-level-table" responsiveLayout="scroll">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Preset</th>
                      <th>Description</th>
                      <th>Hierarchy</th>
                      <th>Permissions</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-preset>
                    <tr>
                      <td>{{ preset.label }}</td>
                      <td>{{ preset.description }}</td>
                      <td><span class="status-badge status-badge--security">H{{ preset.hierarchyLevel }}</span></td>
                      <td><span class="status-badge status-badge--info">{{ preset.permissions.length }} permissions</span></td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </div>
          </p-tabpanel>

          <p-tabpanel value="drift">
            <div class="security-levels-section">
              <div class="security-levels-header">
                <div class="security-levels-title">
                  <h3>Role Drift Monitor</h3>
                  <span class="record-count">{{ driftedRolesCount() }} roles differ from their base permissions</span>
                </div>
                <div class="security-levels-actions">
                  <button pButton type="button" class="btn btn-ghost" (click)="loadRoles()" [disabled]="loadingRoles()">
                    <i class="pi pi-refresh"></i>
                    <span>Refresh drift</span>
                  </button>
                </div>
              </div>

              <div class="table-wrapper">
                <p-table [value]="driftRows()" styleClass="data-table security-level-table" responsiveLayout="scroll">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Role</th>
                      <th>Added</th>
                      <th>Removed</th>
                      <th>Status</th>
                      <th>Notes</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-row>
                    <tr>
                      <td>{{ row.role.name }}</td>
                      <td><span class="status-badge status-badge--success">{{ row.addedCount }}</span></td>
                      <td><span class="status-badge status-badge--warning">{{ row.removedCount }}</span></td>
                      <td>
                        <p-tag [severity]="driftTone(row.addedCount, row.removedCount)" [value]="row.hasDrift ? 'Drifted' : 'Aligned'"></p-tag>
                      </td>
                      <td>{{ row.role.driftNotes || '—' }}</td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </div>
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>
    </div>
  </section>

</div>
