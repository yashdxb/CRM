<div class="page-container">
  <div class="bg-orbs">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
  </div>

  <app-breadcrumbs></app-breadcrumbs>

  <section class="hero-section">
    <div class="hero-content">
      <div class="hero-badge">
        <span class="badge-dot"></span>
        <span>Qualification</span>
      </div>

      <h1 class="hero-title">
        <span class="title-gradient">Qualification</span>
        <span class="title-light">Policy</span>
      </h1>

      <p class="hero-description">
        Define default conversion thresholds, manager approval guardrails, and signal modifiers that shape lead quality.
      </p>

      <div class="hero-actions">
        <button pButton type="button" class="btn btn-secondary" routerLink="/app/settings">
          <i class="pi pi-arrow-left"></i>
          <span>Back to Settings</span>
        </button>
        <button pButton type="button" class="btn btn-secondary" routerLink="/app/settings/qualification-thresholds">
          <i class="pi pi-sliders-h"></i>
          <span>Contextual Threshold Rules</span>
        </button>
        <button pButton type="button" class="btn btn-ghost" [disabled]="loading()" (click)="loadSettings()">
          <i class="pi pi-refresh"></i>
          <span>Reload</span>
        </button>
      </div>
    </div>

    <div class="hero-visual">
      <div class="visual-card visual-card--primary">
        <div class="card-icon">
          <i class="pi pi-shield"></i>
        </div>
        <div class="card-content">
          <span class="card-label">Default Threshold</span>
          <strong class="card-value">{{ qualificationPolicy().defaultThreshold }}</strong>
          <span class="card-trend">
            <i class="pi pi-lock"></i>
            Block below {{ qualificationPolicy().blockBelow }}
          </span>
        </div>
        <div class="card-glow"></div>
      </div>

      <div class="visual-card visual-card--secondary">
        <div class="card-icon">
          <i class="pi pi-chart-line"></i>
        </div>
        <div class="card-content">
          <span class="card-label">Modifiers</span>
          <strong class="card-value">{{ qualificationPolicy().modifiers.length }}</strong>
          <span class="card-trend">
            <i class="pi pi-bolt"></i>
            Dynamic adjustments
          </span>
        </div>
        <div class="card-glow"></div>
      </div>
    </div>
  </section>

  <section class="data-section">
    <div class="settings-layout">
      <div class="data-card">
        <div class="data-header">
          <div class="header-title">
            <h2>Qualification Policy</h2>
            <span class="record-count">Protect conversion quality with rules and overrides</span>
          </div>
          <div class="header-actions">
            <span class="status-badge status-badge--success" *ngIf="!loading()">
              <i class="pi pi-check"></i> Ready
            </span>
          </div>
        </div>

        <div class="loading-state" *ngIf="loading()">
          <div class="skeleton-row" *ngFor="let _ of [0, 1, 2]">
            <div class="skeleton skeleton-text"></div>
            <div class="skeleton skeleton-input"></div>
          </div>
        </div>

        <form class="settings-form" *ngIf="!loading()" [formGroup]="settingsForm" (ngSubmit)="saveSettings()">
          <p-accordion
            class="policy-accordion-shell"
            [multiple]="true"
            [value]="policyAccordionValue()"
            (valueChange)="onPolicyAccordionValueChange($event)"
          >
          <p-accordion-panel value="thresholds">
            <p-accordion-header>
              <div class="policy-accordion-header">
                <div class="policy-accordion-title">
                  <i class="pi pi-sliders-h"></i>
                  <span>Thresholds & Guardrails</span>
                </div>
                <span class="policy-accordion-badge">Default {{ qualificationPolicy().defaultThreshold }}</span>
              </div>
            </p-accordion-header>
            <p-accordion-content>
          <section class="form-card">
            <h3 class="section-title section-title--info">
              <i class="pi pi-sliders-h"></i>
              Thresholds & Guardrails
            </h3>
            <p class="section-description">Define base conversion thresholds and approval guardrails</p>

            <div class="form-grid form-grid--2col">
              <div class="field">
                <label>Default Threshold</label>
                <p-inputNumber
                  [ngModel]="qualificationPolicy().defaultThreshold"
                  (ngModelChange)="setPolicyField('defaultThreshold', $event)"
                  [min]="0"
                  [max]="100"
                  [ngModelOptions]="{ standalone: true }"
                  styleClass="w-full"
                ></p-inputNumber>
                <small class="field-hint">Baseline score required to convert</small>
              </div>

              <div class="field">
                <label>Manager Approval Below</label>
                <p-inputNumber
                  [ngModel]="qualificationPolicy().managerApprovalBelow"
                  (ngModelChange)="setPolicyField('managerApprovalBelow', $event)"
                  [min]="0"
                  [max]="100"
                  [ngModelOptions]="{ standalone: true }"
                  styleClass="w-full"
                ></p-inputNumber>
                <small class="field-hint">Require manager approval under this score</small>
              </div>

              <div class="field">
                <label>Block Below</label>
                <p-inputNumber
                  [ngModel]="qualificationPolicy().blockBelow"
                  (ngModelChange)="setPolicyField('blockBelow', $event)"
                  [min]="0"
                  [max]="100"
                  [ngModelOptions]="{ standalone: true }"
                  styleClass="w-full"
                ></p-inputNumber>
                <small class="field-hint">Hard stop unless overrides are enabled</small>
              </div>

              <div class="field">
                <label>Overrides</label>
                <div class="toggle-row">
                  <label class="checkbox-field">
                    <p-checkbox
                      [binary]="true"
                      [ngModel]="qualificationPolicy().allowOverrides"
                      (ngModelChange)="setPolicyField('allowOverrides', $event)"
                      [ngModelOptions]="{ standalone: true }"
                    ></p-checkbox>
                    <span>Allow overrides</span>
                  </label>
                  <label class="checkbox-field">
                    <p-checkbox
                      [binary]="true"
                      [ngModel]="qualificationPolicy().requireOverrideReason"
                      (ngModelChange)="setPolicyField('requireOverrideReason', $event)"
                      [ngModelOptions]="{ standalone: true }"
                    ></p-checkbox>
                    <span>Require override reason</span>
                  </label>
                </div>
              </div>

              <div class="field">
                <label>Lead List Display</label>
                <div class="toggle-row">
                  <label class="checkbox-field">
                    <p-checkbox
                      [binary]="true"
                      [ngModel]="qualificationPolicy().showCqvsInLeadList"
                      (ngModelChange)="setPolicyField('showCqvsInLeadList', $event)"
                      [ngModelOptions]="{ standalone: true }"
                    ></p-checkbox>
                    <span>Enable CQVS coach panel in Leads list</span>
                  </label>
                </div>
                <small class="field-hint">Adds a compact “Coach” inspector for CQVS breakdown, weakest factor, and next evidence.</small>
              </div>
            </div>
          </section>
            </p-accordion-content>
          </p-accordion-panel>

          <p-accordion-panel value="evidence-enforcement">
            <p-accordion-header>
              <div class="policy-accordion-header">
                <div class="policy-accordion-title">
                  <i class="pi pi-check-square"></i>
                  <span>Evidence Enforcement</span>
                </div>
                <span class="policy-accordion-badge" [class.is-off]="!qualificationPolicy().requireEvidenceBeforeQualified">
                  {{ qualificationPolicy().requireEvidenceBeforeQualified ? (qualificationPolicy().minimumEvidenceCoveragePercent + '% min') : 'Disabled' }}
                </span>
              </div>
            </p-accordion-header>
            <p-accordion-content>
          <section class="form-card">
            <h3 class="section-title section-title--info">
              <i class="pi pi-check-square"></i>
              Evidence Enforcement
            </h3>
            <p class="section-description">
              Define the minimum evidence coverage required before a lead can move to Qualified.
            </p>

            <div class="form-grid form-grid--2col">
              <div class="field">
                <label>Qualification evidence gate</label>
                <div class="toggle-row">
                  <label class="checkbox-field">
                    <p-checkbox
                      [binary]="true"
                      [ngModel]="qualificationPolicy().requireEvidenceBeforeQualified"
                      (ngModelChange)="setPolicyField('requireEvidenceBeforeQualified', $event)"
                      [ngModelOptions]="{ standalone: true }"
                    ></p-checkbox>
                    <span>Require evidence before setting lead to Qualified</span>
                  </label>
                </div>
                <small class="field-hint">Uses truth/evidence coverage, not factor selections alone.</small>
              </div>

              <div class="field">
                <label>Minimum evidence coverage (%)</label>
                <p-inputNumber
                  [ngModel]="qualificationPolicy().minimumEvidenceCoveragePercent"
                  (ngModelChange)="setPolicyField('minimumEvidenceCoveragePercent', $event)"
                  [min]="0"
                  [max]="100"
                  [ngModelOptions]="{ standalone: true }"
                  [disabled]="!qualificationPolicy().requireEvidenceBeforeQualified"
                  styleClass="w-full"
                ></p-inputNumber>
                <small class="field-hint">
                  Recommended: 50% (roughly 3 of 6 evidence fields) before qualification.
                </small>
              </div>
            </div>
          </section>
            </p-accordion-content>
          </p-accordion-panel>

          <p-accordion-panel value="factor-evidence">
            <p-accordion-header>
              <div class="policy-accordion-header">
                <div class="policy-accordion-title">
                  <i class="pi pi-sitemap"></i>
                  <span>Factor Evidence Mapping</span>
                </div>
                <span class="policy-accordion-badge">
                  {{ requiredFactorEvidenceCount() }}/{{ qualificationFactorOptions.length }} required
                </span>
              </div>
            </p-accordion-header>
            <p-accordion-content>
          <section class="form-card">
            <h3 class="section-title section-title--info">
              <i class="pi pi-sitemap"></i>
              Factor Evidence Mapping
            </h3>
            <p class="section-description">
              Define which evidence sources are shown for each qualification factor and whether factor-level evidence is expected.
            </p>

            <div class="policy-block">
              <div class="factor-evidence-toolbar">
                <div class="factor-evidence-toolbar__summary">
                  <span class="factor-evidence-toolbar__stat">
                    <i class="pi pi-shield"></i>
                    {{ requiredFactorEvidenceCount() }} factors require evidence
                  </span>
                  <span class="factor-evidence-toolbar__stat factor-evidence-toolbar__stat--muted">
                    <i class="pi pi-list"></i>
                    {{ qualificationPolicy().evidenceSources.length }} evidence sources available
                  </span>
                </div>
                <p class="hint">Configure source choices per factor so reps only see relevant options in the lead form.</p>
              </div>

              <div class="factor-evidence-grid">
                <article class="factor-evidence-card" *ngFor="let factor of qualificationFactorOptions">
                  <div class="factor-evidence-card__header">
                    <div class="factor-evidence-card__title">
                      <span class="factor-evidence-card__icon" [attr.data-factor]="factor.key">
                        <i class="pi pi-sparkles"></i>
                      </span>
                      <div class="factor-evidence-card__title-text">
                        <strong>{{ factor.label }}</strong>
                        <small>Evidence source options shown in Lead Qualification</small>
                      </div>
                    </div>

                    <label class="checkbox-field factor-evidence-card__toggle">
                      <p-checkbox
                        [binary]="true"
                        [ngModel]="factorEvidenceRuleFor(factor.key).requireEvidence"
                        (ngModelChange)="updateFactorEvidenceRequire(factor.key, $event)"
                        [ngModelOptions]="{ standalone: true }"
                      ></p-checkbox>
                      <span>Require evidence</span>
                    </label>
                  </div>

                  <div class="factor-evidence-card__body">
                    <label class="factor-evidence-card__label">Allowed evidence sources</label>
                    <p-multiSelect
                      [options]="qualificationPolicy().evidenceSources"
                      [ngModel]="factorEvidenceRuleFor(factor.key).allowedEvidenceSources"
                      (ngModelChange)="updateFactorEvidenceSources(factor.key, $event)"
                      [ngModelOptions]="{ standalone: true }"
                      [filter]="true"
                      [showClear]="true"
                      [display]="'chip'"
                      defaultLabel="Select sources"
                      appendTo="body"
                      styleClass="w-full"
                    ></p-multiSelect>
                    <div class="factor-evidence-card__meta">
                      <span class="factor-evidence-card__count">
                        {{ factorEvidenceRuleFor(factor.key).allowedEvidenceSources.length }} selected
                      </span>
                      <span class="factor-evidence-card__state" [class.is-required]="factorEvidenceRuleFor(factor.key).requireEvidence">
                        {{ factorEvidenceRuleFor(factor.key).requireEvidence ? 'Gate enforced' : 'Optional evidence' }}
                      </span>
                    </div>
                  </div>
                </article>
              </div>
              <p class="hint">Tip: keep sources narrow per factor to reduce rep confusion in the Lead Qualification tab.</p>
            </div>
          </section>
            </p-accordion-content>
          </p-accordion-panel>

          <p-accordion-panel value="modifiers">
            <p-accordion-header>
              <div class="policy-accordion-header">
                <div class="policy-accordion-title">
                  <i class="pi pi-bolt"></i>
                  <span>Modifiers</span>
                </div>
                <span class="policy-accordion-badge">{{ qualificationPolicy().modifiers.length }} rules</span>
              </div>
            </p-accordion-header>
            <p-accordion-content>
          <section class="form-card">
            <h3 class="section-title section-title--info">
              <i class="pi pi-bolt"></i>
              Modifiers
            </h3>
            <p class="section-description">Signals that adjust the effective threshold dynamically</p>

            <div class="policy-block">
              <div class="policy-header">
                <h4>Qualification Modifiers</h4>
                <button type="button" class="btn btn-secondary" (click)="addModifierRule()">
                  <i class="pi pi-plus"></i>
                  Add modifier
                </button>
              </div>
              <div class="policy-list" *ngIf="qualificationPolicy().modifiers.length; else noModifiers">
                <div class="policy-row policy-row--modifier" *ngFor="let modifier of qualificationPolicy().modifiers; let i = index">
                  <p-select
                    appendTo="body"
                    [options]="modifierKeyOptions"
                    optionLabel="label"
                    optionValue="value"
                    [ngModel]="modifier.key"
                    (ngModelChange)="updateModifierRule(i, { key: $event })"
                    [ngModelOptions]="{ standalone: true }"
                    placeholder="Modifier"
                    styleClass="w-full"
                  ></p-select>
                  <p-inputNumber
                    [ngModel]="modifier.delta"
                    (ngModelChange)="updateModifierRule(i, { delta: $event })"
                    [min]="-50"
                    [max]="50"
                    [ngModelOptions]="{ standalone: true }"
                    styleClass="w-full"
                  ></p-inputNumber>
                  <button type="button" class="btn btn-ghost" (click)="removeModifierRule(i)">
                    <i class="pi pi-times"></i>
                  </button>
                </div>
              </div>
              <ng-template #noModifiers>
                <p class="hint">No modifiers defined. Add signals to adjust the threshold dynamically.</p>
              </ng-template>
            </div>
          </section>
            </p-accordion-content>
          </p-accordion-panel>

          <p-accordion-panel value="exposure-weights">
            <p-accordion-header>
              <div class="policy-accordion-header">
                <div class="policy-accordion-title">
                  <i class="pi pi-exclamation-circle"></i>
                  <span>Exposure Weights</span>
                </div>
                <span class="policy-accordion-badge" [class.is-warn]="exposureWeightTotal() !== 100">
                  Total {{ exposureWeightTotal() }}%
                </span>
              </div>
            </p-accordion-header>
            <p-accordion-content>
          <section class="form-card">
            <h3 class="section-title section-title--info">
              <i class="pi pi-exclamation-circle"></i>
              Exposure Weights
            </h3>
            <p class="section-description">
              Control how much each qualification factor contributes to Cost of Not Knowing exposure.
            </p>

            <div class="policy-block">
              <div class="policy-header">
                <h4>Qualification Factors</h4>
                <span class="hint">Total: {{ exposureWeightTotal() }}%</span>
              </div>
              <div class="policy-list">
                <div class="policy-row policy-row--modifier" *ngFor="let factor of exposureWeightOptions">
                  <div class="factor-label">{{ factor.label }}</div>
                  <p-inputNumber
                    [ngModel]="exposureWeightFor(factor.key)"
                    (ngModelChange)="updateExposureWeight(factor.key, $event)"
                    [min]="0"
                    [max]="100"
                    [ngModelOptions]="{ standalone: true }"
                    styleClass="w-full"
                  ></p-inputNumber>
                  <span class="factor-suffix">%</span>
                </div>
              </div>
              <p class="hint" *ngIf="exposureWeightTotal() !== 100">
                We recommend weights totaling 100% for consistent Cost of Not Knowing scoring.
              </p>
            </div>
          </section>
            </p-accordion-content>
          </p-accordion-panel>

          <p-accordion-panel value="lead-data-weights">
            <p-accordion-header>
              <div class="policy-accordion-header">
                <div class="policy-accordion-title">
                  <i class="pi pi-chart-line"></i>
                  <span>Lead Data Quality Weights</span>
                </div>
                <span class="policy-accordion-badge" [class.is-warn]="leadDataWeightTotal() !== 100">
                  Total {{ leadDataWeightTotal() }}%
                </span>
              </div>
            </p-accordion-header>
            <p-accordion-content>
          <section class="form-card">
            <h3 class="section-title section-title--info">
              <i class="pi pi-chart-line"></i>
              Lead Data Quality Weights
            </h3>
            <p class="section-description">
              Configure how lead basic fields contribute to Lead Data Quality Score (0-100).
            </p>

            <div class="policy-block">
              <div class="policy-header">
                <h4>Lead Data Fields</h4>
                <span class="hint">Total: {{ leadDataWeightTotal() }}%</span>
              </div>
              <div class="policy-list">
                <div class="policy-row policy-row--modifier" *ngFor="let field of leadDataWeightOptions">
                  <div class="factor-label">{{ field.label }}</div>
                  <p-inputNumber
                    [ngModel]="leadDataWeightFor(field.key)"
                    (ngModelChange)="updateLeadDataWeight(field.key, $event)"
                    [min]="0"
                    [max]="100"
                    [ngModelOptions]="{ standalone: true }"
                    styleClass="w-full"
                  ></p-inputNumber>
                  <span class="factor-suffix">%</span>
                </div>
              </div>
              <p class="hint" *ngIf="leadDataWeightTotal() !== 100">
                We recommend weights totaling 100% for consistent Lead Data Quality scoring.
              </p>
            </div>
          </section>
            </p-accordion-content>
          </p-accordion-panel>

          <p-accordion-panel value="evidence-sources">
            <p-accordion-header>
              <div class="policy-accordion-header">
                <div class="policy-accordion-title">
                  <i class="pi pi-list-check"></i>
                  <span>Evidence Sources</span>
                </div>
                <span class="policy-accordion-badge">{{ qualificationPolicy().evidenceSources.length }} sources</span>
              </div>
            </p-accordion-header>
            <p-accordion-content>
          <section class="form-card">
            <h3 class="section-title section-title--info">
              <i class="pi pi-list-check"></i>
              Evidence Sources
            </h3>
            <p class="section-description">
              Configure the evidence source list shown in Lead Qualification. Use clear source names that reps can pick quickly.
            </p>

            <div class="policy-block">
              <div class="policy-header">
                <h4>Evidence Source Catalog</h4>
                <button type="button" class="btn btn-secondary" (click)="addEvidenceSource()">
                  <i class="pi pi-plus"></i>
                  Add source
                </button>
              </div>
              <div class="policy-list" *ngIf="qualificationPolicy().evidenceSources.length; else noEvidenceSources">
                <div class="policy-row policy-row--modifier" *ngFor="let source of qualificationPolicy().evidenceSources; let i = index">
                  <input
                    pInputText
                    [ngModel]="source"
                    (ngModelChange)="updateEvidenceSource(i, $event)"
                    [ngModelOptions]="{ standalone: true }"
                    class="w-full"
                    [readonly]="source.toLowerCase() === 'no evidence yet'"
                  />
                  <span class="factor-suffix" *ngIf="source.toLowerCase() === 'no evidence yet'">Required</span>
                  <button
                    *ngIf="source.toLowerCase() !== 'no evidence yet'"
                    type="button"
                    class="btn btn-ghost"
                    (click)="removeEvidenceSource(i)"
                  >
                    <i class="pi pi-times"></i>
                  </button>
                </div>
              </div>
              <ng-template #noEvidenceSources>
                <p class="hint">No sources configured. Add at least one evidence source.</p>
              </ng-template>
            </div>
          </section>
            </p-accordion-content>
          </p-accordion-panel>
          </p-accordion>

          <div class="form-actions">
            <button type="button" class="btn btn-ghost" (click)="loadSettings()" [disabled]="loading()">
              <i class="pi pi-refresh"></i>
              Reset
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="saving() || !canManageAdmin()">
              <i class="pi pi-save" *ngIf="!saving()"></i>
              <i class="pi pi-spinner pi-spin" *ngIf="saving()"></i>
              {{ saving() ? 'Saving...' : 'Save Qualification Policy' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </section>
</div>
