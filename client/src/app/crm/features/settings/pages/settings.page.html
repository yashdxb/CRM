<section class="page-background">
  <!-- Animated Background Orbs -->
  <div class="animated-orb orb-1"></div>
  <div class="animated-orb orb-2"></div>
  <div class="animated-orb orb-3"></div>

  <!-- PrimeNG Breadcrumb -->
  <app-breadcrumbs></app-breadcrumbs>


  <!-- Hero Section -->
  <header class="page-hero">
    <div class="hero-content">
      <span class="hero-eyebrow">
        <i class="pi pi-cog"></i>
        Workspace controls
      </span>
      <h1 class="hero-title">Team & Access Management</h1>
      <p class="hero-subtitle">
        Manage teammates, control permissions, and keep sensitive data scoped to the right sellers
      </p>
    </div>
    <div class="hero-actions">
      <label class="toggle-wrapper">
        <span>Show inactive</span>
        <p-toggleSwitch [ngModel]="includeInactive()" (ngModelChange)="toggleIncludeInactive($event)"></p-toggleSwitch>
      </label>
      <button pButton type="button" class="btn-gradient" [disabled]="!canManageAdmin()" [routerLink]="canManageAdmin() ? ['/app/settings/invite'] : null">
        <i class="pi pi-user-plus"></i>
        <span>Invite user</span>
      </button>
      <button pButton type="button" class="btn-glass" [disabled]="!canManageAdmin()" [routerLink]="canManageAdmin() ? ['/app/settings/workspace'] : null">
        <i class="pi pi-sliders-h"></i>
        <span>Workspace settings</span>
      </button>
      <button pButton type="button" class="btn-glass" routerLink="/app/settings/roles">
        <i class="pi pi-shield"></i>
        <span>Manage roles</span>
      </button>
      <button pButton type="button" class="btn-glass" [disabled]="!canManageLeads()" [routerLink]="canManageLeads() ? ['/app/settings/lead-assignment'] : null">
        <i class="pi pi-sitemap"></i>
        <span>Lead assignment</span>
      </button>
      <button pButton type="button" class="btn-glass" routerLink="/app/settings/notifications">
        <i class="pi pi-bell"></i>
        <span>Notifications</span>
      </button>
      <button pButton type="button" class="btn-glass" *ngIf="canManageTenants()" (click)="goToTenants()">
        <i class="pi pi-building"></i>
        <span>Tenant configuration</span>
      </button>
    </div>
  </header>

  <!-- Metrics Dashboard -->
  <div class="metrics-grid">
    <div class="metric-card">
      <div class="metric-icon cyan">
        <i class="pi pi-users"></i>
      </div>
      <div class="metric-content">
        <span class="metric-value">{{ totalUsers() }}</span>
        <span class="metric-label">Total Users</span>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-icon purple">
        <i class="pi pi-check-circle"></i>
      </div>
      <div class="metric-content">
        <span class="metric-value">{{ activeUsersCount() }}</span>
        <span class="metric-label">Active</span>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-icon orange">
        <i class="pi pi-ban"></i>
      </div>
      <div class="metric-content">
        <span class="metric-value">{{ inactiveUsersCount() }}</span>
        <span class="metric-label">Inactive</span>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-icon primary">
        <i class="pi pi-id-card"></i>
      </div>
      <div class="metric-content">
        <span class="metric-value">{{ roles().length }}</span>
        <span class="metric-label">Roles</span>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="settings-layout">
    <!-- Users Table Panel -->
    <div class="glass-card users-panel">
      <div class="card-header">
        <div class="header-left">
          <span class="card-eyebrow">Team directory</span>
          <h2 class="card-title">{{ filteredUsers().length }} teammates</h2>
        </div>
        <p class="card-subtitle">Manage permissions and access for your CRM team</p>
      </div>

      <ng-container *ngIf="!loadingUsers(); else usersLoading">
        <div class="table-toolbar">
          <div class="toolbar-search">
            <i class="pi pi-search"></i>
            <input
              pInputText
              type="search"
              [ngModel]="searchTerm()"
              (ngModelChange)="onSearchChange($event)"
              placeholder="Search by name or email"
            />
          </div>
          <div class="toolbar-filters">
            <p-select appendTo="body"
              [options]="roleFilterOptions()"
              optionLabel="label"
              optionValue="value"
              [ngModel]="roleFilter()"
              (ngModelChange)="onRoleFilterChange($event)"
              placeholder="All roles"
              styleClass="filter-select"
            ></p-select>
            <p-select appendTo="body"
              [options]="statusFilterOptions"
              optionLabel="label"
              optionValue="value"
              [ngModel]="statusFilter()"
              (ngModelChange)="onStatusFilterChange($event)"
              placeholder="All statuses"
              styleClass="filter-select"
            ></p-select>
            <button pButton type="button" class="btn-glass small" (click)="resetFilters()">Reset</button>
          </div>
        </div>

        <div class="table-wrapper">
          <p-table class="data-table" [value]="filteredUsers()">
            <ng-template pTemplate="header">
              <tr>
                <th>User</th>
                <th>Roles</th>
                <th>Last Login</th>
                <th>Status</th>
                <th class="text-right">Actions</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-user>
              <tr class="user-row" (click)="startEdit(user)">
                <td>
                  <div class="user-cell">
                    <div
                      class="user-avatar"
                      [ngClass]="getAvatarClasses(user)"
                    >
                      {{ user.fullName.slice(0, 1) }}
                      <span class="presence-dot" [ngClass]="isOnline(user) ? 'online' : 'offline'"></span>
                    </div>
                    <div class="user-info">
                      <span class="user-name">{{ user.fullName }}</span>
                      <span class="user-email">{{ user.email }}</span>
                      <span class="user-presence" [ngClass]="isOnline(user) ? 'is-online' : 'is-offline'">
                        <span class="presence-icon"></span>
                        {{ isOnline(user) ? 'Online now' : 'Offline' }}
                      </span>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="role-badges">
                    <span class="role-badge" *ngFor="let role of user.roles">{{ role }}</span>
                  </div>
                </td>
                <td>
                  <ng-container *ngIf="user.lastLoginAtUtc; else neverLogged">
                    <span class="login-date">
                      {{ formatLoginTime(user) }}
                    </span>
                    <span class="login-duration">
                      {{ formatLoginDuration(user, isOnline(user)) }}
                    </span>
                  </ng-container>
                  <ng-template #neverLogged>
                    <span class="login-never">Never logged in</span>
                  </ng-template>
                  <span class="login-location" [ngClass]="user.lastLoginLocation ? '' : 'location-muted'">
                    <i class="pi pi-map-marker"></i>
                    {{ user.lastLoginLocation || (user.lastLoginIp ? ('IP ' + user.lastLoginIp) : 'Location unavailable') }}
                  </span>
                </td>
                <td>
                  <span class="status-badge" [ngClass]="user.isActive ? 'badge-success' : 'badge-warning'">
                    {{ user.isActive ? 'Active' : 'Inactive' }}
                  </span>
                </td>
                <td class="text-right">
                  <div class="action-buttons">
                    <button pButton type="button" class="crm-button crm-button--ghost crm-button--sm" icon="pi pi-pencil" title="Edit user" aria-label="Edit user" [disabled]="!canManageAdmin()" (click)="$event.stopPropagation(); startEdit(user)"></button>
                    <button pButton type="button" class="crm-button crm-button--ghost crm-button--sm" [icon]="user.isActive ? 'pi pi-eye-slash' : 'pi pi-eye'" [title]="user.isActive ? 'Deactivate' : 'Activate'" [attr.aria-label]="user.isActive ? 'Deactivate user' : 'Activate user'" [disabled]="!canManageAdmin()" (click)="$event.stopPropagation(); toggleUserStatus(user)"></button>
                    <button pButton type="button" class="crm-button crm-button--ghost crm-button--sm" icon="pi pi-key" title="Reset password" aria-label="Reset password" [disabled]="!canManageAdmin()" (click)="$event.stopPropagation(); resetPassword(user)"></button>
                    <button pButton type="button" class="crm-button crm-button--ghost crm-button--sm" icon="pi pi-trash" title="Remove user" aria-label="Remove user" [disabled]="!canManageAdmin()" (click)="$event.stopPropagation(); deleteUser(user)"></button>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </ng-container>

      <ng-template #usersLoading>
        <div class="loading-skeleton">
          <div class="skeleton-row" *ngFor="let _ of [0, 1, 2, 3, 4]"></div>
        </div>
      </ng-template>
    </div>

  </div>

</section>
