<section class="page-background">
  <div class="animated-orb orb-1"></div>
  <div class="animated-orb orb-2"></div>
  <div class="animated-orb orb-3"></div>

  <app-breadcrumbs></app-breadcrumbs>

  <header class="page-hero">
    <div class="hero-content">
      <span class="hero-eyebrow">
        <i class="pi pi-cog"></i>
        Settings
      </span>
      <h1 class="hero-title">
        <span class="title-gradient">People</span>
        <span class="title-light">& Access</span>
      </h1>
      <p class="hero-subtitle">
        Manage users and roles with clean, controlled access governance.
      </p>
    </div>
  </header>

  <div class="settings-layout">
    <div class="glass-card users-panel">
      <div class="card-header">
        <div class="header-left">
          <span class="card-eyebrow">Access governance</span>
          <h1 class="non-hero-title" *ngIf="activeView() === 'permissions'">
            <span class="title-gradient">Permission</span>
            <span class="title-light">Management</span>
          </h1>
          <h1 class="non-hero-title" *ngIf="activeView() === 'roles'">
            <span class="title-gradient">Role</span>
            <span class="title-light">Management</span>
          </h1>
          <h1 class="non-hero-title" *ngIf="activeView() === 'users'">
            <span class="title-gradient">User</span>
            <span class="title-light">Management</span>
          </h1>
          <h1 class="non-hero-title" *ngIf="activeView() === 'security-level'">
            <span class="title-gradient">Security Level</span>
            <span class="title-light">Management</span>
          </h1>
          <h1 class="non-hero-title" *ngIf="activeView() === 'dashboard-packs'">
            <span class="title-gradient">Dashboard Pack</span>
            <span class="title-light">Management</span>
          </h1>
          <p class="card-subtitle">People &amp; Access</p>
        </div>
        <div class="header-actions">
          <button
            pButton
            type="button"
            class="btn-gradient"
            [disabled]="!canManageAdmin()"
            [routerLink]="
              canManageAdmin()
                ? (activeView() === 'users'
                    ? ['/app/settings/invite']
                    : activeView() === 'roles'
                      ? ['/app/settings/roles/new']
                    : activeView() === 'permissions'
                      ? ['/app/settings/permissions']
                    : activeView() === 'security-level'
                      ? ['/app/settings/security-levels']
                      : ['/app/settings/dashboard-packs'])
                : null
            "
          >
            <i [class]="activeView() === 'users' ? 'pi pi-user-plus' : activeView() === 'roles' ? 'pi pi-plus-circle' : activeView() === 'permissions' ? 'pi pi-lock' : activeView() === 'security-level' ? 'pi pi-shield' : 'pi pi-th-large'"></i>
            <span>{{ activeView() === 'users' ? 'Invite user' : activeView() === 'roles' ? 'New role' : activeView() === 'permissions' ? 'Manage sets' : activeView() === 'security-level' ? 'Manage levels' : 'Manage packs' }}</span>
          </button>
        </div>
      </div>

      <div class="people-command-bar">
        <div class="command-metrics">
          <span class="metric-pill">
            <i class="pi pi-users"></i>
            {{ totalUsers() }} Users
          </span>
          <span class="metric-pill">
            <i class="pi pi-shield"></i>
            {{ roles().length }} Roles
          </span>
          <span class="metric-pill metric-pill--success">
            <i class="pi pi-check-circle"></i>
            {{ activeUsersCount() }} Active
          </span>
        </div>
        <div class="command-actions">
          <button pButton type="button" class="btn-glass small" (click)="activeView() === 'users' ? loadUsers() : activeView() === 'roles' ? loadRoles() : null">
            <i class="pi pi-refresh"></i>
            <span>Refresh</span>
          </button>
        </div>
      </div>

      <div class="people-subtabs" role="tablist" aria-label="People and access sub views">
        <button
          pButton
          type="button"
          class="subview-chip"
          *ngFor="let item of activeSubmenuItems()"
          [ngClass]="{ 'is-active': isSubmenuActive(item) }"
          [attr.aria-selected]="isSubmenuActive(item)"
          (click)="selectSubmenu(item)"
        >
          <i [class]="item.icon"></i>
          <span>{{ item.label }}</span>
        </button>
      </div>

      <div class="view-stage">
        <ng-container *ngIf="activeView() === 'users'; else nonUsersView">
          <ng-container *ngIf="!loadingUsers(); else usersLoading">
            <div class="table-toolbar">
              <div class="toolbar-search">
                <i class="pi pi-search"></i>
                <input
                  pInputText
                  type="search"
                  [ngModel]="searchTerm()"
                  (ngModelChange)="onSearchChange($event)"
                  placeholder="Search by name or email"
                />
              </div>
              <div class="toolbar-filters">
                <p-select appendTo="body"
                  [options]="roleFilterOptions()"
                  optionLabel="label"
                  optionValue="value"
                  [ngModel]="roleFilter()"
                  (ngModelChange)="onRoleFilterChange($event)"
                  placeholder="All roles"
                  styleClass="filter-select"
                ></p-select>
                <p-select appendTo="body"
                  [options]="statusFilterOptions"
                  optionLabel="label"
                  optionValue="value"
                  [ngModel]="statusFilter()"
                  (ngModelChange)="onStatusFilterChange($event)"
                  placeholder="All statuses"
                  styleClass="filter-select"
                ></p-select>
                <label class="toggle-wrapper compact">
                  <span>Show inactive</span>
                  <p-toggleSwitch [ngModel]="includeInactive()" (ngModelChange)="toggleIncludeInactive($event)"></p-toggleSwitch>
                </label>
                <button pButton type="button" class="btn-glass small" (click)="resetFilters()">Reset</button>
              </div>
            </div>

            <div class="table-wrapper">
              <p-table
                class="data-table"
                [value]="filteredUsers()"
                [paginator]="true"
                [rows]="pageSize()"
                [rowsPerPageOptions]="pageSizeOptions"
                [totalRecords]="totalUsers()"
                [first]="(page() - 1) * pageSize()"
                (onPage)="handlePage($event)"
              >
                <ng-template pTemplate="header">
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Last login</th>
                    <th>Online time</th>
                    <th class="text-right">Actions</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-user>
                  <tr class="user-row" (click)="startEdit(user)">
                    <td>
                      <div class="user-cell">
                        <div
                          class="user-avatar"
                          [ngClass]="getAvatarClasses(user)"
                        >
                          {{ user.fullName.slice(0, 1) }}
                          <span class="presence-dot" [ngClass]="isOnline(user) ? 'online' : 'offline'"></span>
                        </div>
                        <div class="user-info">
                          <span class="user-name">{{ user.fullName }}</span>
                          <span class="user-presence" [ngClass]="isOnline(user) ? 'is-online' : 'is-offline'">
                            <span class="presence-icon"></span>
                            {{ isOnline(user) ? 'Online now' : 'Offline' }}
                          </span>
                        </div>
                      </div>
                    </td>
                    <td>
                      <span class="user-email">{{ user.email }}</span>
                    </td>
                    <td>
                      <span class="role-pill" *ngIf="user.roles?.length; else unassignedRole">
                        {{ user.roles[0] }}
                      </span>
                      <ng-template #unassignedRole>
                        <span class="role-pill muted">Unassigned</span>
                      </ng-template>
                    </td>
                    <td>
                      <span class="status-badge" [ngClass]="user.isActive ? 'badge-success' : 'badge-warning'">
                        {{ user.isActive ? 'Active' : 'Inactive' }}
                      </span>
                    </td>
                    <td>
                      <ng-container *ngIf="user.lastLoginAtUtc; else inviteOrNever">
                        <span class="login-date">
                          {{ formatLoginTime(user) }}
                        </span>
                        <span class="login-duration">
                          {{ formatLoginDuration(user, isOnline(user)) }}
                        </span>
                      </ng-container>
                      <ng-template #inviteOrNever>
                        <ng-container *ngIf="user.lastInviteSentAtUtc; else neverLogged">
                          <span class="login-date">
                            Invite sent {{ formatInviteSentTime(user) }}
                          </span>
                          <span class="login-duration">
                            {{ formatInviteSentDuration(user) }}
                          </span>
                        </ng-container>
                      </ng-template>
                      <ng-template #neverLogged>
                        <span class="login-never">Never logged in</span>
                      </ng-template>
                    </td>
                    <td>
                      <span class="login-duration">
                        {{ formatOnlineHours(user, isOnline(user)) }}
                      </span>
                    </td>
                    <td class="text-right">
                      <div class="action-buttons">
                        <button pButton type="button" class="crm-button crm-button--ghost crm-button--sm" icon="pi pi-pencil" title="Edit user" aria-label="Edit user" [disabled]="!canManageAdmin()" (click)="$event.stopPropagation(); startEdit(user)"></button>
                        <button pButton type="button" class="crm-button crm-button--ghost crm-button--sm" [icon]="user.isActive ? 'pi pi-eye-slash' : 'pi pi-eye'" [title]="user.isActive ? 'Deactivate' : 'Activate'" [attr.aria-label]="user.isActive ? 'Deactivate user' : 'Activate user'" [disabled]="!canManageAdmin()" (click)="$event.stopPropagation(); toggleUserStatus(user)"></button>
                        <button
                          pButton
                          type="button"
                          class="crm-button crm-button--ghost crm-button--sm"
                          icon="pi pi-send"
                          title="Resend invite"
                          aria-label="Resend invite"
                          [disabled]="!canManageAdmin() || !canResendInvite(user)"
                          (click)="$event.stopPropagation(); resendInvite(user)"
                        ></button>
                        <button pButton type="button" class="crm-button crm-button--ghost crm-button--sm" icon="pi pi-key" title="Reset password" aria-label="Reset password" [disabled]="!canManageAdmin()" (click)="$event.stopPropagation(); resetPassword(user)"></button>
                        <button pButton type="button" class="crm-button crm-button--ghost crm-button--sm" icon="pi pi-trash" title="Remove user" aria-label="Remove user" [disabled]="!canManageAdmin()" (click)="$event.stopPropagation(); deleteUser(user)"></button>
                      </div>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </ng-container>

          <ng-template #usersLoading>
            <div class="loading-skeleton">
              <div class="skeleton-row" *ngFor="let _ of [0, 1, 2, 3, 4]"></div>
            </div>
          </ng-template>
        </ng-container>

        <ng-template #nonUsersView>
          <div class="people-access-embed" *ngIf="activeView() === 'roles'">
            <app-roles-page></app-roles-page>
          </div>
          <div class="people-access-embed" *ngIf="activeView() === 'permissions'">
            <app-permissions-page></app-permissions-page>
          </div>
          <div class="people-access-embed" *ngIf="activeView() === 'security-level'">
            <app-security-levels-page></app-security-levels-page>
          </div>
          <div class="people-access-embed" *ngIf="activeView() === 'dashboard-packs'">
            <app-dashboard-packs-page></app-dashboard-packs-page>
          </div>
        </ng-template>
      </div>
    </div>

  </div>

</section>
