<section class="role-form-page">
  <div class="form-header">
    <div class="header-content">
      <app-breadcrumbs></app-breadcrumbs>

      <button type="button" class="back-link" routerLink="/app/settings/roles">
        <i class="pi pi-arrow-left"></i>
        Back to Roles
      </button>

      <div class="header-row">
        <div class="header-title">
          <h1>
            <span class="title-gradient">{{ isEditMode() ? 'Edit' : 'Create' }}</span>
            <span class="title-light">Role</span>
          </h1>
          <p>Define what your team can see and do with a clean, consistent permission model.</p>
        </div>
        <div class="header-meta">
          <span class="status-pill" [ngClass]="isSystemRole() ? 'status-pill--system' : 'status-pill--custom'">
            {{ isSystemRole() ? 'System role' : 'Custom role' }}
          </span>
          <span class="meta-chip">
            <i class="pi pi-shield"></i>
            {{ selectedPermissionCount() }} permissions
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="form-body">
    <div class="form-layout">
      <form class="role-form" [formGroup]="roleForm" (ngSubmit)="saveRole()">
        <section class="form-card">
          <h3 class="section-title">
            <i class="pi pi-id-card"></i>
            Role Details
          </h3>
          <div class="form-grid">
            <div class="field">
              <label for="roleName">Role Name <span class="required">*</span></label>
              <input
                pInputText
                id="roleName"
                formControlName="name"
                placeholder="e.g. Sales Manager"
                [readonly]="isSystemRole()"
                class="w-full"
              />
              <small class="field-hint" *ngIf="isSystemRole()">System roles cannot be renamed.</small>
            </div>
            <div class="field">
              <label for="roleDesc">Description</label>
              <input
                pInputText
                id="roleDesc"
                formControlName="description"
                placeholder="Brief description of this role's purpose"
                class="w-full"
              />
            </div>
            <div class="field">
              <label for="roleLevel">Role Level (L1 = lowest)</label>
              <p-inputNumber
                inputId="roleLevel"
                formControlName="level"
                [min]="1"
                [max]="9"
                [showButtons]="true"
                placeholder="e.g. 1"
                styleClass="w-full"
                inputStyleClass="w-full"
              ></p-inputNumber>
              <small class="field-hint">Higher levels load higher dashboard packs by default.</small>
            </div>
          </div>
          <div class="role-pack-link">
            <i class="pi pi-th-large"></i>
            <span>Manage default dashboard pack for this level</span>
            <a routerLink="/app/settings/dashboard-packs">Open dashboard packs</a>
          </div>
        </section>

        <section class="form-card permissions-card">
          <div class="permissions-header">
            <h3 class="section-title">
              <i class="pi pi-shield"></i>
              Screen Permissions
            </h3>
            <div class="permission-meta">
              <span class="badge">{{ selectedPermissionCount() }} selected</span>
              <span class="badge muted">{{ screenPermissions().length }} screens</span>
            </div>
          </div>

          <p class="section-description">
            Configure access by screen. Toggle individual CRUD actions or use the All checkbox to grant full access.
          </p>

          <ng-container *ngIf="!loadingPermissions(); else permissionsLoading">
            <div class="permissions-table-wrapper">
              <p-table
                [value]="screenPermissions()"
                styleClass="permissions-table"
                [scrollable]="true"
              >
                <ng-template pTemplate="header">
                  <tr>
                    <th class="col-screen">Screen</th>
                    <th class="col-crud">
                      <div class="crud-header">
                        <span class="crud-label" pTooltip="Create new records">
                          <i class="pi pi-plus-circle"></i>
                          Create
                        </span>
                      </div>
                    </th>
                    <th class="col-crud">
                      <div class="crud-header">
                        <span class="crud-label" pTooltip="View and read records">
                          <i class="pi pi-eye"></i>
                          Read
                        </span>
                      </div>
                    </th>
                    <th class="col-crud">
                      <div class="crud-header">
                        <span class="crud-label" pTooltip="Edit existing records">
                          <i class="pi pi-pencil"></i>
                          Update
                        </span>
                      </div>
                    </th>
                    <th class="col-crud">
                      <div class="crud-header">
                        <span class="crud-label" pTooltip="Remove records">
                          <i class="pi pi-trash"></i>
                          Delete
                        </span>
                      </div>
                    </th>
                    <th class="col-all">
                      <div class="crud-header">
                        <span class="crud-label" pTooltip="Toggle all permissions">
                          <i class="pi pi-check-circle"></i>
                          All
                        </span>
                      </div>
                    </th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-screen>
                  <tr
                    [class.row-selected]="isAllSelectedForScreen(screen)"
                    [class.row-partial]="isSomeSelectedForScreen(screen)"
                  >
                    <td class="col-screen">
                      <div class="screen-info">
                        <div class="screen-icon">
                          <i class="pi" [ngClass]="screen.icon"></i>
                        </div>
                        <div class="screen-meta">
                          <span class="screen-name">{{ screen.screenName }}</span>
                          <span class="screen-desc">{{ screen.description }}</span>
                        </div>
                      </div>
                    </td>
                    <td class="col-crud">
                      <div class="crud-cell" [class.disabled]="!screen.permissions.create">
                        <p-checkbox
                          *ngIf="screen.permissions.create"
                          [binary]="true"
                          [ngModel]="isPermissionSelected(screen.permissions.create)"
                          [ngModelOptions]="{standalone: true}"
                          (onChange)="togglePermission(screen.permissions.create)"
                          [disabled]="roleSaving()"
                          styleClass="crud-checkbox"
                        ></p-checkbox>
                        <span *ngIf="!screen.permissions.create" class="na-indicator">—</span>
                      </div>
                    </td>
                    <td class="col-crud">
                      <div class="crud-cell" [class.disabled]="!screen.permissions.read">
                        <p-checkbox
                          *ngIf="screen.permissions.read"
                          [binary]="true"
                          [ngModel]="isPermissionSelected(screen.permissions.read)"
                          [ngModelOptions]="{standalone: true}"
                          (onChange)="togglePermission(screen.permissions.read)"
                          [disabled]="roleSaving()"
                          styleClass="crud-checkbox"
                        ></p-checkbox>
                        <span *ngIf="!screen.permissions.read" class="na-indicator">—</span>
                      </div>
                    </td>
                    <td class="col-crud">
                      <div class="crud-cell" [class.disabled]="!screen.permissions.update">
                        <p-checkbox
                          *ngIf="screen.permissions.update"
                          [binary]="true"
                          [ngModel]="isPermissionSelected(screen.permissions.update)"
                          [ngModelOptions]="{standalone: true}"
                          (onChange)="togglePermission(screen.permissions.update)"
                          [disabled]="roleSaving()"
                          styleClass="crud-checkbox"
                        ></p-checkbox>
                        <span *ngIf="!screen.permissions.update" class="na-indicator">—</span>
                      </div>
                    </td>
                    <td class="col-crud">
                      <div class="crud-cell" [class.disabled]="!screen.permissions.delete">
                        <p-checkbox
                          *ngIf="screen.permissions.delete"
                          [binary]="true"
                          [ngModel]="isPermissionSelected(screen.permissions.delete)"
                          [ngModelOptions]="{standalone: true}"
                          (onChange)="togglePermission(screen.permissions.delete)"
                          [disabled]="roleSaving()"
                          styleClass="crud-checkbox"
                        ></p-checkbox>
                        <span *ngIf="!screen.permissions.delete" class="na-indicator">—</span>
                      </div>
                    </td>
                    <td class="col-all">
                      <div class="crud-cell all-cell">
                        <p-checkbox
                          [binary]="true"
                          [ngModel]="isAllSelectedForScreen(screen)"
                          [ngModelOptions]="{standalone: true}"
                          (onChange)="toggleAllForScreen(screen, $event.checked)"
                          [disabled]="roleSaving()"
                          styleClass="crud-checkbox all-checkbox"
                        ></p-checkbox>
                      </div>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </ng-container>

          <ng-template #permissionsLoading>
            <div class="loading-blocks">
              <p-skeleton height="52px" *ngFor="let _ of [0, 1, 2, 3, 4]"></p-skeleton>
            </div>
          </ng-template>
        </section>

        <div class="form-actions">
          <button
            type="button"
            pButton
            label="Cancel"
            [disabled]="roleSaving()"
            routerLink="/app/settings/roles"
            class="crm-button--ghost"
          ></button>
          <button
            type="submit"
            pButton
            [label]="isEditMode() ? 'Update Role' : 'Create Role'"
            [loading]="roleSaving()"
            [disabled]="!canManageAdmin() || roleForm.invalid"
            class="crm-button--primary"
          ></button>
        </div>
      </form>

      <aside class="summary-card">
        <div class="summary-header">
          <h3 class="section-title">
            <i class="pi pi-chart-bar"></i>
            Role Summary
          </h3>
        </div>
        <div class="summary-body">
          <div class="summary-block">
            <span class="label">Role name</span>
            <span class="value">{{ roleForm.value.name || 'Untitled role' }}</span>
          </div>
          <div class="summary-block" *ngIf="roleForm.value.description">
            <span class="label">Description</span>
            <span class="value">{{ roleForm.value.description }}</span>
          </div>

          <div class="summary-metrics">
            <div class="metric-card">
              <span class="metric-value">{{ selectedPermissionCount() }}</span>
              <span class="metric-label">Permissions</span>
            </div>
            <div class="metric-card">
              <span class="metric-value">{{ screenPermissions().length }}</span>
              <span class="metric-label">Screens</span>
            </div>
          </div>

          <div class="summary-note">
            <i class="pi pi-lightbulb"></i>
            <span>Keep roles focused. Fewer permissions mean cleaner access control and better security.</span>
          </div>
        </div>
      </aside>
    </div>
  </div>
</section>
