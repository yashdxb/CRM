<section class="role-form-page">
  <div class="form-header">
    <div class="header-content">
      <app-breadcrumbs></app-breadcrumbs>

      <button pButton type="button" class="back-link" routerLink="/app/settings/roles">
        <i class="pi pi-arrow-left"></i>
        Back to Roles
      </button>

      <div class="header-row">
        <div class="header-title">
          <h1>
            <span class="title-gradient">{{ isEditMode() ? 'Edit' : 'Create' }}</span>
            <span class="title-light">Role</span>
          </h1>
          <p>Define what your team can see and do with a clean, consistent permission model.</p>
        </div>
        <div class="header-meta">
          <span class="status-pill" [ngClass]="isSystemRole() ? 'status-pill--system' : 'status-pill--custom'">
            {{ isSystemRole() ? 'System role' : 'Custom role' }}
          </span>
          <span class="meta-chip">
            <i class="pi pi-shield"></i>
            {{ selectedPermissionCount() }} permissions
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="form-body">
      <form class="role-form role-form--compact" [formGroup]="roleForm" (ngSubmit)="saveRole()">
        <section class="form-section">
          <h3 class="section-title">
            <i class="pi pi-id-card"></i>
            Role Details
          </h3>
          <div class="form-grid">
            <div class="field">
              <label for="roleName">Role Name <span class="required">*</span></label>
              <input
                pInputText
                id="roleName"
                formControlName="name"
                placeholder="e.g. Sales Manager"
                [readonly]="isSystemRole()"
                class="w-full"
              />
              <small class="field-hint field-hint--guidance" *ngIf="isSystemRole()">System roles cannot be renamed.</small>
            </div>
            <div class="field">
              <label for="roleDesc">Description</label>
              <input
                pInputText
                id="roleDesc"
                formControlName="description"
                placeholder="Brief description of this role's purpose"
                class="w-full"
              />
            </div>
            <div class="field">
              <label>Hierarchy Level (computed)</label>
              <input
                pInputText
                [value]="hierarchyPreviewLabel()"
                readonly
                class="w-full"
              />
              <small class="field-hint field-hint--guidance">Derived from parent role (no manual level input).</small>
            </div>
            <div class="field">
              <label for="visibilityScope">Visibility Scope</label>
              <p-select
                inputId="visibilityScope"
                formControlName="visibilityScope"
                [options]="visibilityOptions"
                optionLabel="label"
                optionValue="value"
                appendTo="body"
                styleClass="w-full"
              >
                <ng-template pTemplate="item" let-option>
                  <div class="select-option">
                    <span>{{ option.label }}</span>
                    <span class="select-meta">{{ option.hint }}</span>
                  </div>
                </ng-template>
              </p-select>
              <small class="field-hint field-hint--guidance">Controls reporting rollups and default visibility for this role.</small>
            </div>
            <div class="field">
              <label for="securityLevel">Security Level</label>
              <p-select
                inputId="securityLevel"
                formControlName="securityLevelId"
                [options]="securityOptions()"
                optionLabel="label"
                optionValue="value"
                appendTo="body"
                styleClass="w-full"
                [disabled]="loadingSecurityLevels()"
              >
                <ng-template pTemplate="item" let-option>
                  <div class="select-option">
                    <span>{{ option.label }}</span>
                    <span class="select-meta">{{ option.hint }}</span>
                  </div>
                </ng-template>
              </p-select>
              <small class="field-hint field-hint--guidance">Controls high-risk actions (approvals, overrides, admin changes).</small>
              <small class="field-hint field-hint--guidance">
                Manage levels in
                <a routerLink="/app/settings/roles">Roles â€º Security Level Definitions</a>.
              </small>
            </div>
            <div class="field">
              <label for="roleParent">Parent Role</label>
              <p-select
                inputId="roleParent"
                formControlName="parentRoleId"
                [options]="parentRoleOptions()"
                optionLabel="label"
                optionValue="value"
                placeholder="Top-level role"
                appendTo="body"
                styleClass="w-full"
              >
                <ng-template pTemplate="item" let-option>
                  <div class="select-option">
                    <span>{{ option.label }}</span>
                    <span class="select-meta">{{ option.meta }}</span>
                  </div>
                </ng-template>
              </p-select>
              <small class="field-hint field-hint--guidance">Hierarchy: {{ hierarchyPreviewLabel() }}</small>
            </div>
          </div>
          <div class="role-pack-link">
            <i class="pi pi-th-large"></i>
            <span>Manage default dashboard pack for this hierarchy level</span>
            <a routerLink="/app/settings/dashboard-packs">Open dashboard packs</a>
          </div>
        </section>

        <section class="form-section permissions-section">
          <div class="permissions-header">
            <h3 class="section-title">
              <i class="pi pi-shield"></i>
              Permissions
            </h3>
            <div class="permission-meta">
              <span class="badge">{{ selectedPermissionCount() }} selected</span>
            </div>
          </div>

          <ng-container *ngIf="!loadingPermissions(); else permissionsLoading">
            <p-tabs [value]="activePermissionTab()" (valueChange)="onPermissionTabChange($event)" class="permission-tabs">
              <p-tablist>
                <p-tab value="all-permissions">All Permissions</p-tab>
                <p-tab value="presets">Presets</p-tab>
                <p-tab value="drift">Drift</p-tab>
                <p-tab value="effective-access">Effective Access</p-tab>
              </p-tablist>
              <p-tabpanels>
                <p-tabpanel value="all-permissions">
                  <p class="section-description">
                    Review and edit granular permissions by capability.
                  </p>
                  <p-tabs [value]="activePermissionActionTab()" (valueChange)="onPermissionActionTabChange($event)" class="permission-action-tabs">
                    <p-tablist>
                      <p-tab value="create-manage">Create &amp; Manage ({{ allPermissionActionTabs().createManage }})</p-tab>
                      <p-tab value="view-analyze">View &amp; Analyze ({{ allPermissionActionTabs().viewAnalyze }})</p-tab>
                      <p-tab value="governance">Governance ({{ allPermissionActionTabs().governance }})</p-tab>
                    </p-tablist>
                    <p-tabpanels>
                      <p-tabpanel value="create-manage">
                        <div class="capability-grid">
                          <div class="capability-card" *ngFor="let group of filteredCapabilityGroups()">
                            <div class="capability-header">
                              <h4>{{ group.capability }}</h4>
                              <span class="badge muted">{{ group.permissions.length }} permissions</span>
                            </div>
                            <div class="capability-list">
                              <div class="capability-row" *ngFor="let permission of group.permissions">
                                <div class="capability-meta">
                                  <span class="capability-label">{{ permission.label }}</span>
                                  <span class="capability-desc">{{ permission.description }}</span>
                                </div>
                                <p-checkbox
                                  [binary]="true"
                                  [ngModel]="isPermissionSelected(permission.key)"
                                  [ngModelOptions]="{standalone: true}"
                                  (onChange)="togglePermission(permission.key)"
                                  [disabled]="roleSaving()"
                                ></p-checkbox>
                              </div>
                            </div>
                          </div>
                        </div>
                        <p class="empty-state" *ngIf="filteredCapabilityGroups().length === 0">No permissions in this category.</p>
                      </p-tabpanel>
                      <p-tabpanel value="view-analyze">
                        <div class="capability-grid">
                          <div class="capability-card" *ngFor="let group of filteredCapabilityGroups()">
                            <div class="capability-header">
                              <h4>{{ group.capability }}</h4>
                              <span class="badge muted">{{ group.permissions.length }} permissions</span>
                            </div>
                            <div class="capability-list">
                              <div class="capability-row" *ngFor="let permission of group.permissions">
                                <div class="capability-meta">
                                  <span class="capability-label">{{ permission.label }}</span>
                                  <span class="capability-desc">{{ permission.description }}</span>
                                </div>
                                <p-checkbox
                                  [binary]="true"
                                  [ngModel]="isPermissionSelected(permission.key)"
                                  [ngModelOptions]="{standalone: true}"
                                  (onChange)="togglePermission(permission.key)"
                                  [disabled]="roleSaving()"
                                ></p-checkbox>
                              </div>
                            </div>
                          </div>
                        </div>
                        <p class="empty-state" *ngIf="filteredCapabilityGroups().length === 0">No permissions in this category.</p>
                      </p-tabpanel>
                      <p-tabpanel value="governance">
                        <div class="capability-grid">
                          <div class="capability-card" *ngFor="let group of filteredCapabilityGroups()">
                            <div class="capability-header">
                              <h4>{{ group.capability }}</h4>
                              <span class="badge muted">{{ group.permissions.length }} permissions</span>
                            </div>
                            <div class="capability-list">
                              <div class="capability-row" *ngFor="let permission of group.permissions">
                                <div class="capability-meta">
                                  <span class="capability-label">{{ permission.label }}</span>
                                  <span class="capability-desc">{{ permission.description }}</span>
                                </div>
                                <p-checkbox
                                  [binary]="true"
                                  [ngModel]="isPermissionSelected(permission.key)"
                                  [ngModelOptions]="{standalone: true}"
                                  (onChange)="togglePermission(permission.key)"
                                  [disabled]="roleSaving()"
                                ></p-checkbox>
                              </div>
                            </div>
                          </div>
                        </div>
                        <p class="empty-state" *ngIf="filteredCapabilityGroups().length === 0">No permissions in this category.</p>
                      </p-tabpanel>
                    </p-tabpanels>
                  </p-tabs>
                </p-tabpanel>

                <p-tabpanel value="presets">
                  <p class="section-description">
                    Apply intent packs or hierarchy presets as a baseline.
                  </p>
                  <div class="intent-grid">
                    <div class="intent-card">
                      <h4>Role intent packs</h4>
                      <p>Pick a baseline role intent and apply its permissions.</p>
                      <div class="intent-list" *ngIf="intentPacks().length; else noIntentPacks">
                        <div class="intent-row" *ngFor="let pack of intentPacks()">
                          <div>
                            <strong>{{ pack.label }}</strong>
                            <p>{{ pack.description }}</p>
                          </div>
                          <button pButton type="button" class="btn btn-secondary" (click)="applyIntentPack(pack)" [disabled]="roleSaving()">
                            Apply
                          </button>
                        </div>
                      </div>
                      <ng-template #noIntentPacks>
                        <p class="empty-state">No intent packs available.</p>
                      </ng-template>
                    </div>

                    <div class="intent-card">
                      <h4>Hierarchy permission presets</h4>
                      <p>Use H1/H2/H3 permission packs as a starting point.</p>
                      <div class="intent-list" *ngIf="permissionPackPresets().length; else noPackPresets">
                        <div class="intent-row" *ngFor="let pack of permissionPackPresets()">
                          <div>
                            <strong>{{ pack.label }}</strong>
                            <p>{{ pack.description }}</p>
                          </div>
                          <button pButton type="button" class="btn btn-secondary" (click)="applyPermissionPack(pack)" [disabled]="roleSaving()">
                            Apply
                          </button>
                        </div>
                      </div>
                      <ng-template #noPackPresets>
                        <p class="empty-state">No permission packs available.</p>
                      </ng-template>
                    </div>
                  </div>
                </p-tabpanel>

                <p-tabpanel value="drift">
                  <p class="section-description">
                    Review current changes vs base pack, then accept or reset.
                  </p>
                  <div class="intent-card drift-card">
                    <h4>Role drift</h4>
                    <p>Track changes from the base pack and keep an audit trail.</p>
                    <div class="drift-list">
                      <div class="drift-column">
                        <span class="drift-title">Added</span>
                        <span *ngIf="driftSummary().added.length === 0" class="empty-state">No additions</span>
                        <span class="drift-pill" *ngFor="let key of driftSummary().added">{{ permissionLabel(key) }}</span>
                      </div>
                      <div class="drift-column">
                        <span class="drift-title">Removed</span>
                        <span *ngIf="driftSummary().removed.length === 0" class="empty-state">No removals</span>
                        <span class="drift-pill removed" *ngFor="let key of driftSummary().removed">{{ permissionLabel(key) }}</span>
                      </div>
                    </div>
                    <div class="drift-actions">
                      <button pButton type="button" class="btn btn-ghost" (click)="resetToDefault()" [disabled]="roleSaving()">
                        Reset to Default
                      </button>
                      <button pButton type="button" class="btn btn-primary" (click)="acceptDrift()" [disabled]="roleSaving()">
                        Accept Drift
                      </button>
                    </div>
                    <div class="drift-notes">
                      <label for="driftNotes">Drift notes</label>
                      <textarea
                        id="driftNotes"
                        rows="3"
                        pInputTextarea
                        [(ngModel)]="driftNotes"
                        [ngModelOptions]="{standalone: true}"
                        placeholder="Explain why this role differs from the base pack."
                      ></textarea>
                    </div>
                  </div>
                </p-tabpanel>

                <p-tabpanel value="effective-access">
                  <p class="section-description">
                    Verify final permission scope before saving this role.
                  </p>
                  <div class="intent-card">
                    <h4>Direct permissions</h4>
                    <p>Permissions currently selected on this role.</p>
                    <div class="inherited-pills">
                      <span class="permission-pill" *ngFor="let label of effectivePermissionLabels()">
                        {{ label }}
                      </span>
                      <span class="empty-state" *ngIf="effectivePermissionLabels().length === 0">No permissions selected</span>
                    </div>
                  </div>
                  <div class="intent-card">
                    <h4>Inherited permissions</h4>
                    <p>Permissions inherited from parent role hierarchy.</p>
                    <div class="inherited-pills">
                      <span class="permission-pill" *ngFor="let key of inheritedPermissions()">
                        {{ permissionLabel(key) }}
                      </span>
                      <span class="empty-state" *ngIf="inheritedPermissions().length === 0">No inherited permissions</span>
                    </div>
                  </div>
                </p-tabpanel>
                </p-tabpanels>
              </p-tabs>
          </ng-container>

          <ng-template #permissionsLoading>
            <div class="loading-blocks">
              <p-skeleton height="52px" *ngFor="let _ of [0, 1, 2, 3, 4]"></p-skeleton>
            </div>
          </ng-template>
        </section>

        <section class="form-section inherited-section" *ngIf="inheritedPermissions().length">
          <div class="permissions-header">
            <h3 class="section-title">
              <i class="pi pi-sitemap"></i>
              Inherited Permissions
            </h3>
            <div class="permission-meta">
              <span class="badge muted">{{ inheritedPermissions().length }} inherited</span>
            </div>
          </div>
          <p class="section-description">
            These permissions are inherited from parent roles and cannot be edited here.
          </p>
          <div class="inherited-pills">
            <span class="permission-pill" *ngFor="let key of inheritedPermissions()">
              {{ permissionLabel(key) }}
            </span>
          </div>
        </section>

        <div class="form-actions">
          <button
            type="button"
            pButton
            label="Cancel"
            [disabled]="roleSaving()"
            routerLink="/app/settings/roles"
            class="crm-button--ghost"
          ></button>
          <button
            type="submit"
            pButton
            [label]="isEditMode() ? 'Update Role' : 'Create Role'"
            [loading]="roleSaving()"
            [disabled]="!canManageAdmin() || roleForm.invalid"
            class="crm-button--primary"
          ></button>
        </div>
      </form>
  </div>
</section>
