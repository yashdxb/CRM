
    <div class="contact-form-page">
      <app-breadcrumbs></app-breadcrumbs>
      <header class="page-header">
        <div class="header-content">
          <button pButton type="button" class="back-link p-button-text" routerLink="/app/contacts">
            <i class="pi pi-arrow-left"></i>
            <span>Back to contacts</span>
          </button>
          <div class="header-title">
            <h1 class="hero-title">
              <span class="title-gradient">{{ isEditMode() ? 'Edit' : 'Create New' }}</span>
              <span class="title-light">Contact</span>
            </h1>
            <p>{{ isEditMode() ? 'Update stakeholder details' : 'Add a new person to your account team' }}</p>
          </div>
        </div>
      </header>

      <main class="form-container">
        <form class="contact-form" (ngSubmit)="onSave()">
          <section class="related-summary-strip" *ngIf="isEditMode()">
            <div class="summary-chip" *ngIf="linkedAccount(); else accountSummaryEmpty">
              <span class="chip-label">Account</span>
              <span class="chip-value">{{ linkedAccount()?.name }}</span>
              <span class="chip-meta">
                Owner {{ linkedAccount()?.owner || '—' }} · Created
                {{ linkedAccount()?.createdAt | date: 'MMM d, yyyy' }}
              </span>
            </div>
            <ng-template #accountSummaryEmpty>
              <div class="summary-chip">
                <span class="chip-label">Account</span>
                <span class="chip-value">None</span>
                <span class="chip-meta">No account linked yet.</span>
              </div>
            </ng-template>
            <div class="summary-chip">
              <span class="chip-label">Opportunities</span>
              <span class="chip-value">{{ opportunityCount() }}</span>
              <span class="chip-meta" *ngIf="latestOpportunityCreatedAt()">
                Last added {{ latestOpportunityCreatedAt() | date: 'MMM d, yyyy' }}
              </span>
            </div>
          </section>
          <section class="form-section">
            <h2 class="section-title">
              <i class="pi pi-user"></i>
              Contact details
            </h2>
            <div class="form-grid">
              <div class="field">
                <label>First name <span class="required">*</span></label>
                <input pInputText name="firstName" [(ngModel)]="form.firstName" required placeholder="First name" class="w-full" />
              </div>
              <div class="field">
                <label>Last name <span class="required">*</span></label>
                <input pInputText name="lastName" [(ngModel)]="form.lastName" required placeholder="Last name" class="w-full" />
              </div>
              <div class="field">
                <label>Email</label>
                <input pInputText name="email" [(ngModel)]="form.email" type="email" placeholder="name@company.com" class="w-full" />
              </div>
              <div class="field">
                <label>Job title</label>
                <input pInputText name="jobTitle" [(ngModel)]="form.jobTitle" placeholder="Role or title" class="w-full" />
              </div>
              <div class="field">
                <label>Buying role</label>
                <p-select
                  [options]="buyingRoleOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="buyingRole"
                  [(ngModel)]="form.buyingRole"
                  placeholder="Select buying role"
                  styleClass="w-full"
                ></p-select>
              </div>
              <div class="field">
                <label>Phone</label>
                <input pInputText name="phone" [(ngModel)]="form.phone" placeholder="+1 555-0101" class="w-full" />
              </div>
              <div class="field">
                <label>Mobile</label>
                <input pInputText name="mobile" [(ngModel)]="form.mobile" placeholder="+1 555-0102" class="w-full" />
              </div>
            </div>
          </section>

          <section class="form-section">
            <h2 class="section-title">
              <i class="pi pi-building"></i>
              Account context
            </h2>
            <div class="form-grid">
              <div class="field">
                <label>Account</label>
                <p-select
                  [options]="accountOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="accountId"
                  [(ngModel)]="form.accountId"
                  placeholder="Link to account"
                  styleClass="w-full"
                ></p-select>
              </div>
              <div class="field">
                <label>Lifecycle</label>
                <p-select
                  [options]="lifecycleOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="lifecycleStage"
                  [(ngModel)]="form.lifecycleStage"
                  placeholder="Select lifecycle"
                  styleClass="w-full"
                ></p-select>
              </div>
              <div class="field">
                <label>Activity score</label>
                <p-inputNumber name="activityScore" [(ngModel)]="form.activityScore" [min]="0" [max]="100" class="w-full"></p-inputNumber>
              </div>
              <div class="field">
                <label>LinkedIn</label>
                <input pInputText name="linkedInProfile" [(ngModel)]="form.linkedInProfile" placeholder="https://linkedin.com/in/..." class="w-full" />
              </div>
            </div>
          </section>

          <footer class="form-actions">
            <button type="button" pButton label="Cancel" class="crm-button crm-button--ghost" (click)="router.navigate(['/app/contacts'])"></button>
            <button
              type="submit"
              pButton
              [label]="isEditMode() ? 'Update contact' : 'Create contact'"
              class="crm-button crm-button--primary"
              [disabled]="!form.firstName || !form.lastName || saving()"
            ></button>
          </footer>
        </form>
      </main>

      <section class="form-container detail-container" *ngIf="isEditMode()">
        <section class="form-section">
          <h2 class="section-title">
            <i class="pi pi-address-book"></i>
            Contact workspace
          </h2>

          <p-tabs value="timeline">
            <p-tablist>
              <p-tab value="timeline">Timeline</p-tab>
              <p-tab value="notes">Notes</p-tab>
              <p-tab value="related">Related records</p-tab>
              <p-tab value="attachments">Attachments</p-tab>
            </p-tablist>
            <p-tabpanels>
              <p-tabpanel value="timeline">
              <div class="timeline" *ngIf="!timelineLoading(); else timelineLoadingTpl">
                <div class="timeline-item" *ngFor="let activity of activities()">
                  <div class="timeline-type">
                    <span class="type-dot" [attr.data-type]="activity.type">{{ activity.type }}</span>
                  </div>
                  <div class="timeline-body">
                    <div class="timeline-title">{{ activity.subject }}</div>
                    <div class="timeline-meta">
                      <span>{{ activity.createdAtUtc | date: 'MMM d, yyyy · h:mm a' }}</span>
                      <span *ngIf="activity.ownerName">• {{ activity.ownerName }}</span>
                    </div>
                    <div class="timeline-description" *ngIf="activity.description">{{ activity.description }}</div>
                  </div>
                </div>
                <div class="empty-state" *ngIf="!activities().length">No activity yet.</div>
              </div>
              <ng-template #timelineLoadingTpl>
                <div class="empty-state">Loading timeline...</div>
              </ng-template>
              </p-tabpanel>

              <p-tabpanel value="notes">
              <div class="notes">
                <div class="note-editor">
        <textarea 
          pTextarea 
          rows="4" 
          placeholder="Add a note about this contact..." 
          class="w-full"
          [(ngModel)]="noteText"
          [ngModelOptions]="{ standalone: true }"
        ></textarea>
                  <div class="note-actions">
                    <button
                      pButton
                      type="button"
                      label="Add note"
                      icon="pi pi-plus"
                      class="crm-button crm-button--primary"
                      [disabled]="!noteText.trim() || noteSaving()"
                      (click)="addNote()"
                    ></button>
                  </div>
                </div>

                <div class="note-list" *ngIf="notes().length; else notesEmpty">
                  <div class="note-item" *ngFor="let note of notes()">
                    <div class="note-header">
                      <span class="note-title">{{ note.subject }}</span>
                      <span class="note-meta">{{ note.createdAtUtc | date: 'MMM d, yyyy · h:mm a' }}</span>
                    </div>
                    <div class="note-body">{{ note.description }}</div>
                  </div>
                </div>
                <ng-template #notesEmpty>
                  <div class="empty-state">No notes yet.</div>
                </ng-template>
              </div>
              </p-tabpanel>

              <p-tabpanel value="related">
              <div class="related-grid">
                <div class="related-section">
                  <h3>Account</h3>
                  <div
                    class="account-card clickable-row"
                    *ngIf="linkedAccount(); else accountEmpty"
                    [routerLink]="['/app/customers', linkedAccount()?.id, 'edit']"
                  >
                    <div class="account-name related-link">{{ linkedAccount()?.name }}</div>
                    <div class="account-meta">{{ linkedAccount()?.company || '—' }}</div>
                    <div class="account-meta">
                      Owner: {{ linkedAccount()?.owner || '—' }} · Created
                      {{ linkedAccount()?.createdAt | date: 'MMM d, yyyy' }}
                    </div>
                  </div>
                  <ng-template #accountEmpty>
                    <div class="empty-state">No account linked.</div>
                  </ng-template>
                </div>

                <div class="related-section">
                  <h3>Opportunities</h3>
                  <p-table [value]="relatedOpportunitiesSorted()" [paginator]="false" [rows]="5" styleClass="compact-table">
                    <ng-template pTemplate="header">
                      <tr>
                        <th>Name</th>
                        <th>Stage</th>
                        <th>Amount</th>
                        <th>Owner</th>
                        <th>Created</th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-row>
                      <tr class="clickable-row" [routerLink]="['/app/opportunities', row.id, 'edit']">
                        <td><span class="related-link">{{ row.name }}</span></td>
                        <td><p-tag [value]="row.stage" severity="info"></p-tag></td>
                        <td>{{ row.amount | currency: row.currency : 'symbol' : '1.0-0' }}</td>
                        <td>{{ row.owner || '—' }}</td>
                        <td>{{ row.createdAtUtc | date: 'MMM d, yyyy' }}</td>
                      </tr>
                    </ng-template>
                  </p-table>
                  <div class="empty-state" *ngIf="!relatedOpportunities().length">No opportunities yet.</div>
                </div>

                <div class="related-section">
                  <h3>Related accounts</h3>
                  <p-table [value]="relatedAccountsSorted()" [paginator]="false" [rows]="5" styleClass="compact-table">
                    <ng-template pTemplate="header">
                      <tr>
                        <th>Name</th>
                        <th>Relationship</th>
                        <th>Owner</th>
                        <th>Created</th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-row>
                      <tr class="clickable-row" [routerLink]="['/app/customers', row.id, 'edit']">
                        <td><span class="related-link">{{ row.name }}</span></td>
                        <td>{{ relatedAccountRelation(row) }}</td>
                        <td>{{ row.owner || '—' }}</td>
                        <td>{{ row.createdAt | date: 'MMM d, yyyy' }}</td>
                      </tr>
                    </ng-template>
                  </p-table>
                  <div class="empty-state" *ngIf="!relatedAccounts().length">No related accounts.</div>
                </div>

                <div class="related-section">
                  <h3>Account history</h3>
                  <div class="timeline" *ngIf="!accountHistoryLoading(); else accountHistoryLoadingTpl">
                    <div class="timeline-item" *ngFor="let activity of accountHistory()">
                      <div class="timeline-type">
                        <span class="type-dot" [attr.data-type]="activity.type">{{ activity.type }}</span>
                      </div>
                      <div class="timeline-body">
                        <div class="timeline-title">{{ activity.subject }}</div>
                        <div class="timeline-meta">
                          <span>{{ activity.createdAtUtc | date: 'MMM d, yyyy · h:mm a' }}</span>
                          <span *ngIf="activity.ownerName">• {{ activity.ownerName }}</span>
                        </div>
                        <div class="timeline-description" *ngIf="activity.description">{{ activity.description }}</div>
                      </div>
                    </div>
                    <div class="empty-state" *ngIf="!accountHistory().length">No account history yet.</div>
                  </div>
                  <ng-template #accountHistoryLoadingTpl>
                    <div class="empty-state">Loading account history...</div>
                  </ng-template>
                </div>
              </div>
              </p-tabpanel>

              <p-tabpanel value="attachments">
              <div class="attachments">
                <p-fileUpload
                  mode="basic"
                  chooseLabel="Upload file"
                  [customUpload]="true"
                  (uploadHandler)="onAttachmentUpload($event)"
                  [auto]="true"
                ></p-fileUpload>

                <p-table [value]="attachments()" [paginator]="false" [rows]="5" styleClass="compact-table">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>File</th>
                      <th>Uploaded by</th>
                      <th>Size</th>
                      <th></th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-row>
                    <tr>
                      <td>{{ row.fileName }}</td>
                      <td>{{ row.uploadedBy || '—' }}</td>
                      <td>{{ row.size | number }} bytes</td>
                      <td class="table-actions">
                        <button pButton type="button" class="icon-btn" icon="pi pi-download" (click)="downloadAttachment(row)"></button>
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
                <div class="empty-state" *ngIf="!attachments().length">No attachments yet.</div>
              </div>
              </p-tabpanel>
            </p-tabpanels>
          </p-tabs>
        </section>
      </section>
    </div>
  
