<div class="contacts page-container">
  <div class="bg-orbs">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
  </div>

  <app-breadcrumbs></app-breadcrumbs>

  <section class="hero-section">
    <div class="hero-content">
      <div class="hero-badge">
        <span class="badge-dot"></span>
        <span>People intelligence</span>
      </div>

      <h1 class="hero-title">
        <span class="title-gradient">Contact</span>
        <span class="title-light">Workspace</span>
      </h1>

      <p class="hero-description">
        Centralize every stakeholder, keep lifecycle context visible, and push the right next step for each account.
      </p>

      <div class="hero-stats">
        <div class="hero-stat">
          <div class="stat-value">{{ contactsInScope() || 0 }}</div>
          <div class="stat-label">In view</div>
          <div class="stat-bar">
            <div class="stat-bar-fill" style="width: 100%"></div>
          </div>
        </div>
        <div class="hero-stat">
          <div class="stat-value">{{ contactsWithLinkedAccounts() }}</div>
          <div class="stat-label">Linked accounts</div>
          <div class="stat-bar">
            <div class="stat-bar-fill stat-bar-fill--cyan" [style.width.%]="contacts().length ? (contactsWithLinkedAccounts() / contacts().length) * 100 : 0"></div>
          </div>
        </div>
        <div class="hero-stat">
          <div class="stat-value">{{ ownerCount() }}</div>
          <div class="stat-label">Owners active</div>
          <div class="stat-bar">
            <div class="stat-bar-fill stat-bar-fill--purple" [style.width.%]="ownerOptions().length ? (ownerCount() / (ownerOptions().length || 1)) * 100 : 0"></div>
          </div>
        </div>
      </div>

      <div class="hero-actions">
        <button pButton type="button" class="btn btn-primary btn-glow" [disabled]="!canManage()" (click)="onCreate()">
          <i class="pi pi-user-plus"></i>
          <span>Add contact</span>
          <div class="btn-shine"></div>
        </button>
        <button pButton type="button" class="btn btn-secondary" (click)="load()">
          <i class="pi pi-refresh"></i>
          <span>Refresh</span>
        </button>
      </div>
    </div>

    <div class="hero-visual">
      <div class="visual-card visual-card--primary">
        <div class="card-icon">
          <i class="pi pi-bullseye"></i>
        </div>
        <div class="card-content">
          <span class="card-label">Lead coverage</span>
          <strong class="card-value">{{ lifecycleCounts().lead }}</strong>
          <span class="card-trend">
            <i class="pi pi-bolt"></i> High intent
          </span>
        </div>
        <div class="card-glow"></div>
      </div>

      <div class="visual-card visual-card--secondary">
        <div class="card-icon">
          <i class="pi pi-star"></i>
        </div>
        <div class="card-content">
          <span class="card-label">Prospects</span>
          <strong class="card-value">{{ lifecycleCounts().prospect }}</strong>
          <span class="card-trend card-trend--up">
            <i class="pi pi-arrow-up"></i> Growing
          </span>
        </div>
        <div class="card-glow"></div>
      </div>
    </div>
  </section>

  <section class="metrics-section">
    <div class="metric-card metric-card--total">
      <div class="metric-icon">
        <i class="pi pi-users"></i>
      </div>
      <div class="metric-content">
        <span class="metric-label">Contacts</span>
        <strong class="metric-value">{{ contacts().length || '—' }}</strong>
      </div>
      <div class="metric-chart">
        <svg viewBox="0 0 100 40" class="sparkline">
          <path d="M0,35 Q25,30 50,20 T100,15" fill="none" stroke="url(#gradient-contacts)" stroke-width="2"/>
          <defs>
            <linearGradient id="gradient-contacts" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#667eea"/>
              <stop offset="100%" stop-color="#764ba2"/>
            </linearGradient>
          </defs>
        </svg>
      </div>
    </div>

    <div class="metric-card metric-card--leads">
      <div class="metric-icon">
        <i class="pi pi-bolt"></i>
      </div>
      <div class="metric-content">
        <span class="metric-label">Leads</span>
        <strong class="metric-value">{{ lifecycleCounts().lead }}</strong>
      </div>
      <div class="metric-ring">
        <svg viewBox="0 0 36 36">
          <path class="ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
          <path class="ring-fill ring-fill--cyan" 
            [attr.stroke-dasharray]="(contacts().length ? (lifecycleCounts().lead / contacts().length) * 100 : 0) + ', 100'"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
        </svg>
      </div>
    </div>

    <div class="metric-card metric-card--prospects">
      <div class="metric-icon">
        <i class="pi pi-star"></i>
      </div>
      <div class="metric-content">
        <span class="metric-label">Prospects</span>
        <strong class="metric-value">{{ lifecycleCounts().prospect }}</strong>
      </div>
      <div class="metric-ring">
        <svg viewBox="0 0 36 36">
          <path class="ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
          <path class="ring-fill ring-fill--purple" 
            [attr.stroke-dasharray]="(contacts().length ? (lifecycleCounts().prospect / contacts().length) * 100 : 0) + ', 100'"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
        </svg>
      </div>
    </div>

    <div class="metric-card metric-card--customers">
      <div class="metric-icon">
        <i class="pi pi-check-circle"></i>
      </div>
      <div class="metric-content">
        <span class="metric-label">Customers</span>
        <strong class="metric-value">{{ lifecycleCounts().customer }}</strong>
      </div>
      <div class="metric-ring">
        <svg viewBox="0 0 36 36">
          <path class="ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
          <path class="ring-fill ring-fill--green" 
            [attr.stroke-dasharray]="(contacts().length ? (lifecycleCounts().customer / contacts().length) * 100 : 0) + ', 100'"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
        </svg>
      </div>
    </div>
  </section>

  <section class="filter-section">
    <div class="filter-bar">
      <div class="search-wrapper">
        <i class="pi pi-search search-icon"></i>
        <input
          pInputText
          type="search"
          class="search-input"
          placeholder="Search contacts, emails, phone..."
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearch($event)"
        />
        <kbd class="search-kbd">⌘K</kbd>
      </div>

      <div class="filter-pills">
        <div class="filter-pill">
          <i class="pi pi-user"></i>
          <p-select appendTo="body"
            [options]="ownerOptions()"
            optionLabel="label"
            optionValue="value"
            [ngModel]="ownerFilter()"
            (ngModelChange)="onOwnerFilterChange($event)"
            placeholder="Owner"
            styleClass="filter-select"
          ></p-select>
        </div>

        <div class="filter-pill">
          <i class="pi pi-tag"></i>
          <p-select appendTo="body"
            [options]="lifecycleOptions"
            optionLabel="label"
            optionValue="value"
            [ngModel]="lifecycleFilter()"
            (ngModelChange)="onLifecycleChange($event)"
            placeholder="Lifecycle"
            styleClass="filter-select"
          ></p-select>
        </div>

        <div class="filter-pill">
          <i class="pi pi-building"></i>
          <p-select appendTo="body"
            [options]="accountFilterOptions()"
            optionLabel="label"
            optionValue="value"
            [ngModel]="accountFilter === 'all' ? 'all' : accountFilter"
            (ngModelChange)="onAccountChange($event)"
            placeholder="Account"
            styleClass="filter-select"
          ></p-select>
        </div>
      </div>
    </div>

  </section>

  <section class="contacts__content">
    <div class="table-card crm-panel">
      <header class="list-header">
        <div>
          <div class="list-title">Contact coverage</div>
          <small>Showing {{ filteredContacts().length }} {{ filteredContacts().length === 1 ? 'contact' : 'contacts' }} with lifecycle + account context</small>
        </div>
        <div class="list-select">
          <p-checkbox
            [binary]="true"
            [ngModel]="selectedIds().length && selectedIds().length === filteredContacts().length"
            (onChange)="toggleSelectAll($event.checked)"
          ></p-checkbox>
          <span>Select all</span>
        </div>
        <div class="list-actions">
          <button pButton type="button" class="crm-button crm-button--ghost crm-button--sm" icon="pi pi-upload" label="Import" [disabled]="!canManage()" (click)="openImport()"></button>
          <button pButton type="button" class="crm-button crm-button--ghost crm-button--sm" icon="pi pi-download" label="Export" (click)="onExport()"></button>
          <button pButton type="button" class="crm-button crm-button--primary crm-button--sm" icon="pi pi-plus" label="Add contact" [disabled]="!canManage()" (click)="onCreate()"></button>
        </div>
      </header>

      <ng-container *ngIf="!loading(); else loadingState">
        <ng-container *ngIf="filteredContacts().length; else emptyState">
          <p-table class="crm-table crm-table--highlight contacts-table" [value]="filteredContacts()" [tableStyle]="{ 'min-width': '100%' }" [styleClass]="'p-datatable-sm'">
            <ng-template pTemplate="header">
              <tr>
                <th class="th-select">
                  <p-checkbox
                    [binary]="true"
                    [ngModel]="selectedIds().length && selectedIds().length === filteredContacts().length"
                    (onChange)="toggleSelectAll($event.checked)"
                  ></p-checkbox>
                </th>
                <th>Contact</th>
                <th>Phone</th>
                <th>Lifecycle</th>
                <th>Owner</th>
                <th class="th-actions">Actions</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row>
              <tr>
                <td class="select-cell">
                  <p-checkbox
                    [binary]="true"
                    [ngModel]="isSelected(row.id)"
                    (onChange)="toggleSelection(row.id, $event.checked)"
                  ></p-checkbox>
                </td>
                <td class="contact-cell">
                  <div class="contact-cell__main">
                    <div class="name__title">{{ row.name }}</div>
                    <small>{{ row.email || 'No email' }}</small>
                  </div>
                  <div class="contact-cell__meta">
                    <span>{{ row.accountName || 'No account' }}</span>
                    <span>{{ row.jobTitle || 'No role' }}</span>
                  </div>
                </td>
                <td>
                  <span class="cell-value">{{ row.phone || row.mobile || '—' }}</span>
                </td>
                <td>
                  <p-select appendTo="body"
                    [options]="lifecycleFormOptions"
                    optionLabel="label"
                    optionValue="value"
                    [ngModel]="row.lifecycleStage || 'Customer'"
                    (ngModelChange)="onInlineLifecycleChange(row, $event)"
                    styleClass="inline-select"
                  ></p-select>
                </td>
                <td>
                  <p-select appendTo="body"
                    [options]="ownerOptionsForAssign()"
                    optionLabel="label"
                    optionValue="value"
                    [ngModel]="row.ownerId"
                    (ngModelChange)="onInlineOwnerChange(row, $event)"
                    placeholder="Owner"
                    styleClass="inline-select"
                  ></p-select>
                </td>
                <td class="actions">
                  <button pButton icon="pi pi-pencil" [disabled]="!canManage()" (click)="$event.stopPropagation(); onEdit(row)"></button>
                  <button pButton icon="pi pi-trash" [disabled]="!canManage()" (click)="$event.stopPropagation(); onDelete(row)"></button>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </ng-container>
      </ng-container>

      <ng-template #loadingState>
        <div class="skeletons">
          <p-skeleton height="1.5rem" *ngFor="let _ of [1,2,3,4,5]"></p-skeleton>
        </div>
      </ng-template>

      <ng-template #emptyState>
        <div class="empty-state">
          <i class="pi pi-user"></i>
          <p>No contacts match the current filters.</p>
          <button pButton type="button" class="crm-button crm-button--text" label="Create contact" [disabled]="!canManage()" (click)="onCreate()"></button>
        </div>
      </ng-template>

      <p-paginator
        [rows]="rows"
        [totalRecords]="total()"
        [rowsPerPageOptions]="[5, 10, 20]"
        [first]="pageIndex * rows"
        (onPageChange)="onPageChange($event)"
        styleClass="contacts__paginator"
      ></p-paginator>
    </div>
  </section>

  <app-bulk-actions-bar
    [actions]="bulkActions()"
    [selectedItems]="selectedIds()"
    [totalCount]="filteredContacts().length"
    (actionClicked)="onBulkAction($event)"
    (clearSelection)="clearSelection()"
    (selectAll)="selectAllFiltered()"
  ></app-bulk-actions-bar>

  <p-dialog
    header="Assign owner"
    [(visible)]="assignDialogVisible"
    [modal]="true"
    [style]="{ width: '360px' }"
  >
    <div class="bulk-assign">
      <label>Owner</label>
      <p-select appendTo="body"
        [options]="ownerOptionsForAssign()"
        optionLabel="label"
        optionValue="value"
        [(ngModel)]="assignOwnerId"
        placeholder="Select owner"
        styleClass="w-full"
      ></p-select>
    </div>
    <ng-template pTemplate="footer">
      <button pButton type="button" class="crm-button crm-button--ghost" label="Cancel" (click)="assignDialogVisible = false"></button>
      <button pButton type="button" class="crm-button crm-button--primary" label="Assign" [disabled]="!assignOwnerId || !canManage()" (click)="confirmBulkAssign()"></button>
    </ng-template>
  </p-dialog>

  <p-dialog
    header="Change lifecycle"
    [(visible)]="statusDialogVisible"
    [modal]="true"
    [style]="{ width: '360px' }"
  >
    <div class="bulk-assign">
      <label>Lifecycle</label>
      <p-select appendTo="body"
        [options]="lifecycleFormOptions"
        optionLabel="label"
        optionValue="value"
        [(ngModel)]="bulkStatus"
        placeholder="Select lifecycle"
        styleClass="w-full"
      ></p-select>
    </div>
    <ng-template pTemplate="footer">
      <button pButton type="button" class="crm-button crm-button--ghost" label="Cancel" (click)="statusDialogVisible = false"></button>
      <button pButton type="button" class="crm-button crm-button--primary" label="Update" [disabled]="!bulkStatus || !canManage()" (click)="confirmBulkStatusUpdate()"></button>
    </ng-template>
  </p-dialog>

  <p-dialog
    header="Import contacts"
    [(visible)]="importDialogVisible"
    [modal]="true"
    [dismissableMask]="true"
    [style]="{ width: '480px' }"
    (onHide)="closeImport()"
  >
    <div class="import-dialog">
      <p class="import-note">
        Upload a CSV with headers. Required column: <strong>Name</strong> or <strong>FirstName</strong>.
      </p>
      <label class="import-upload">
        <p-fileUpload
          mode="basic"
          name="file"
          [auto]="false"
          [customUpload]="true"
          [showUploadButton]="false"
          [showCancelButton]="false"
          [chooseLabel]="importFile?.name || 'Choose CSV file'"
          accept=".csv"
          (onSelect)="onImportFileSelected($event)"
        ></p-fileUpload>
      </label>
      <div class="import-actions">
        <button pButton type="button" class="crm-button crm-button--ghost" label="Cancel" (click)="closeImport()"></button>
        <button pButton type="button" class="crm-button crm-button--primary" [disabled]="!importFile || importing() || !canManage()" (click)="onImport()">
          {{ importing() ? 'Importing...' : 'Import' }}
        </button>
      </div>
      <div class="import-error" *ngIf="importError()">{{ importError() }}</div>
      <div class="import-status" *ngIf="importJob() as job">
        <span>Status: {{ importStatus()?.status || job.status }}</span>
      </div>
      <div class="import-result" *ngIf="importStatus() as result">
        <div class="import-metrics">
          <span>Rows: {{ result.total }}</span>
          <span>Imported: {{ result.imported }}</span>
          <span>Skipped: {{ result.skipped }}</span>
        </div>
        <div class="import-errors" *ngIf="result.errors.length">
          <p>Errors (first 5):</p>
          <ul>
            <li *ngFor="let err of result.errors.slice(0, 5)">
              Row {{ err.rowNumber }}: {{ err.message }}
            </li>
          </ul>
        </div>
      </div>
    </div>
  </p-dialog>

</div>
