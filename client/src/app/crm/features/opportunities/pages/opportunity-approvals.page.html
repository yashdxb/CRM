<div class="page-container approvals-page">
  <div class="bg-orbs" aria-hidden="true">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
  </div>

  <app-breadcrumbs></app-breadcrumbs>

  <section class="hero-shell liquid-card">
    <div class="hero-copy">
      <div class="hero-badge">
        <span class="badge-dot"></span>
        <span>{{ pageTitle() }}</span>
      </div>
      <h1 class="hero-title">{{ pageTitle() }}</h1>
      <p class="hero-description">{{ heroDescription() }}</p>
    </div>
    <div class="hero-actions">
      <button pButton type="button" class="command-btn command-btn--ghost" (click)="load()">
        <i class="pi pi-refresh"></i>
        <span>Refresh</span>
      </button>
    </div>
  </section>

  <section class="kpi-grid">
    <article class="kpi-card liquid-card">
      <div class="kpi-label">Pending decisions</div>
      <div class="kpi-value">{{ kpis().pending }}</div>
      <div class="kpi-meta">Actionable now</div>
    </article>
    <article class="kpi-card liquid-card tone-danger">
      <div class="kpi-label">Overdue SLA</div>
      <div class="kpi-value">{{ kpis().overdue }}</div>
      <div class="kpi-meta">Escalation risk</div>
    </article>
    <article class="kpi-card liquid-card tone-warn">
      <div class="kpi-label">High-risk queue</div>
      <div class="kpi-value">{{ kpis().critical }}</div>
      <div class="kpi-meta">Critical / high risk</div>
    </article>
    <article class="kpi-card liquid-card tone-cyan">
      <div class="kpi-label">Pending value</div>
      <div class="kpi-value">{{ formatCompactCurrency(kpis().totalAmount) }}</div>
      <div class="kpi-meta">Avg age {{ kpis().avgAge | number:'1.0-1' }}h</div>
    </article>
  </section>

  <section class="filter-shell liquid-card">
    <div class="filter-field search-field">
      <label>Search queue</label>
      <span class="search-icon pi pi-search"></span>
      <input
        pInputText
        type="text"
        [ngModel]="searchQuery()"
        (ngModelChange)="onSearchInput($event)"
        placeholder="Search opportunity, account, requester, rule, risk"
      />
    </div>
    <div class="filter-field">
      <label>Status</label>
      <p-select
        appendTo="body"
        [options]="statusOptions"
        optionLabel="label"
        optionValue="value"
        [(ngModel)]="statusFilter"
        (onChange)="load()"
        styleClass="w-full"
      ></p-select>
    </div>
    <div class="filter-field">
      <label>Purpose</label>
      <p-select
        appendTo="body"
        [options]="purposeOptions"
        optionLabel="label"
        optionValue="value"
        [(ngModel)]="purposeFilter"
        (onChange)="load()"
        styleClass="w-full"
      ></p-select>
    </div>
  </section>

  <section class="pending-table-panel liquid-card">
    <div class="pane-header">
      <div>
        <h2 class="pane-title">Pending Action Items</h2>
        <p class="pane-subtitle">{{ queueSubtitle() }}</p>
      </div>
    </div>

    <div *ngIf="!loading(); else tableLoading" class="table-wrap">
      <p-table
        [value]="filteredApprovals()"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[10, 20, 50]"
        responsiveLayout="scroll"
        styleClass="pending-actions-table"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Subject</th>
            <th>Sender</th>
            <th>Requested</th>
            <th>Value</th>
            <th>Priority</th>
            <th>Risk</th>
            <th>SLA</th>
            <th>Open</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-item>
          <tr class="pending-row" (click)="openOpportunity(item)">
            <td>
              <div class="subject-cell">
                <div class="subject-title">{{ item.opportunityName }}</div>
                <div class="subject-subtitle">{{ item.accountName }}</div>
              </div>
            </td>
            <td>{{ item.requestedByName || 'â€”' }}</td>
            <td>{{ item.requestedOn | date:'MMM d, y, h:mm a' }}</td>
            <td>{{ formatCurrency(item.amount, item.currency) }}</td>
            <td>
              <p-tag [value]="(item.priority || 'normal').toUpperCase()" [severity]="prioritySeverity(item.priority)"></p-tag>
            </td>
            <td>
              <p-tag [value]="(item.riskLevel || 'low').toUpperCase()" [severity]="riskSeverity(item.riskLevel)"></p-tag>
            </td>
            <td>
              <span class="sla-text" [class.overdue]="item.slaStatus === 'overdue'">{{ slaLabel(item) }}</span>
            </td>
            <td>
              <button
                pButton
                type="button"
                class="action-btn command-btn command-btn--ghost"
                (click)="openOpportunity(item); $event.stopPropagation()"
              >
                <i class="pi pi-folder-open"></i>
              </button>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="empty-table">{{ emptyListMessage() }}</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </section>
</div>

<ng-template #tableLoading>
  <div class="queue-loading">
    <div class="skeleton-row" *ngFor="let row of [1,2,3,4,5]"></div>
  </div>
</ng-template>
