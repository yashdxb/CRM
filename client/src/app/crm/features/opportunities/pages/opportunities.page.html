<!-- ═══════════════════════════════════════════════════════════════════════════
     OPPORTUNITIES PAGE - FUTURISTIC ENTERPRISE UI
     ═══════════════════════════════════════════════════════════════════════════ -->
<div class="page-container">
  <!-- Animated Background Orbs -->
  <div class="bg-orbs">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
  </div>

  <!-- PrimeNG Breadcrumb -->
  <app-breadcrumbs></app-breadcrumbs>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       HERO SECTION - Revenue Intelligence Command Center
       ═══════════════════════════════════════════════════════════════════════════ -->
  <section class="hero-section">
    <div class="hero-content">
      <div class="hero-badge">
        <span class="badge-dot"></span>
        <span>Revenue Intelligence</span>
      </div>
      
      <h1 class="hero-title">
        <span class="title-gradient">Opportunity</span>
        <span class="title-light">Pipeline</span>
      </h1>
      
      <p class="hero-description">
        Track deals, forecast revenue, and close opportunities with AI-powered insights
      </p>

      <div class="hero-stats">
        <div class="hero-stat">
          <div class="stat-value">{{ metrics().total || 0 }}</div>
          <div class="stat-label">Total Deals</div>
          <div class="stat-bar">
            <div class="stat-bar-fill" style="width: 100%"></div>
          </div>
        </div>
        <div class="hero-stat">
          <div class="stat-value">{{ metrics().open }}</div>
          <div class="stat-label">Open</div>
          <div class="stat-bar">
            <div class="stat-bar-fill stat-bar-fill--open" [style.width.%]="metrics().total ? (metrics().open / metrics().total) * 100 : 0"></div>
          </div>
        </div>
        <div class="hero-stat">
          <div class="stat-value">{{ metrics().closedWon }}</div>
          <div class="stat-label">Won</div>
          <div class="stat-bar">
            <div class="stat-bar-fill stat-bar-fill--success" [style.width.%]="metrics().total ? (metrics().closedWon / metrics().total) * 100 : 0"></div>
          </div>
        </div>
        <div class="hero-stat">
          <div class="stat-value">{{ metrics().closedLost }}</div>
          <div class="stat-label">Lost</div>
          <div class="stat-bar">
            <div class="stat-bar-fill stat-bar-fill--danger" [style.width.%]="metrics().total ? (metrics().closedLost / metrics().total) * 100 : 0"></div>
          </div>
        </div>
      </div>

      <div class="hero-actions">
        <button pButton type="button" class="btn btn-primary btn-glow" [disabled]="!canManage()" (click)="onCreate()">
          <i class="pi pi-plus"></i>
          <span>New Opportunity</span>
          <div class="btn-shine"></div>
        </button>
        <button pButton type="button" class="btn btn-secondary" (click)="load()">
          <i class="pi pi-refresh"></i>
          <span>Refresh</span>
        </button>
      </div>
    </div>

    <div class="hero-visual">
      <div class="visual-card visual-card--primary">
        <div class="card-icon">
          <i class="pi pi-dollar"></i>
        </div>
        <div class="card-content">
          <span class="card-label">Pipeline Value</span>
          <strong class="card-value">{{ metrics().pipelineValue | currency:'USD':'symbol':'1.0-0' }}</strong>
          <span class="card-trend card-trend--up">
            <i class="pi pi-chart-line"></i> Open forecast
          </span>
        </div>
        <div class="card-glow"></div>
      </div>

      <div class="visual-card visual-card--secondary">
        <div class="card-icon">
          <i class="pi pi-percentage"></i>
        </div>
        <div class="card-content">
          <span class="card-label">Weighted Forecast</span>
          <strong class="card-value">{{ metrics().weightedPipeline | currency:'USD':'symbol':'1.0-0' }}</strong>
          <span class="card-trend">
            <i class="pi pi-calculator"></i> Probability adjusted
          </span>
        </div>
        <div class="card-glow"></div>
      </div>
    </div>
  </section>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       METRICS DASHBOARD
       ═══════════════════════════════════════════════════════════════════════════ -->
  <section class="metrics-section">
    <div class="metric-card metric-card--total">
      <div class="metric-icon">
        <i class="pi pi-briefcase"></i>
      </div>
      <div class="metric-content">
        <span class="metric-label">Total Deals</span>
        <strong class="metric-value">{{ metrics().total || '—' }}</strong>
      </div>
      <div class="metric-chart">
        <svg viewBox="0 0 100 40" class="sparkline">
          <path d="M0,35 Q25,30 50,20 T100,15" fill="none" stroke="url(#gradient-blue)" stroke-width="2"/>
          <defs>
            <linearGradient id="gradient-blue" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#667eea"/>
              <stop offset="100%" stop-color="#764ba2"/>
            </linearGradient>
          </defs>
        </svg>
      </div>
    </div>

    <div class="metric-card metric-card--open">
      <div class="metric-icon">
        <i class="pi pi-bolt"></i>
      </div>
      <div class="metric-content">
        <span class="metric-label">Open</span>
        <strong class="metric-value">{{ metrics().open }}</strong>
      </div>
      <div class="metric-ring">
        <svg viewBox="0 0 36 36">
          <path class="ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
          <path class="ring-fill ring-fill--cyan" 
            [attr.stroke-dasharray]="(metrics().total ? (metrics().open / metrics().total) * 100 : 0) + ', 100'"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
        </svg>
      </div>
    </div>

    <div class="metric-card metric-card--won">
      <div class="metric-icon">
        <i class="pi pi-check-circle"></i>
      </div>
      <div class="metric-content">
        <span class="metric-label">Closed Won</span>
        <strong class="metric-value">{{ metrics().closedWon }}</strong>
      </div>
      <div class="metric-ring">
        <svg viewBox="0 0 36 36">
          <path class="ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
          <path class="ring-fill ring-fill--green" 
            [attr.stroke-dasharray]="(metrics().total ? (metrics().closedWon / metrics().total) * 100 : 0) + ', 100'"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
        </svg>
      </div>
    </div>

    <div class="metric-card metric-card--lost">
      <div class="metric-icon">
        <i class="pi pi-times-circle"></i>
      </div>
      <div class="metric-content">
        <span class="metric-label">Closed Lost</span>
        <strong class="metric-value">{{ metrics().closedLost }}</strong>
      </div>
      <div class="metric-ring">
        <svg viewBox="0 0 36 36">
          <path class="ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
          <path class="ring-fill ring-fill--rose" 
            [attr.stroke-dasharray]="(metrics().total ? (metrics().closedLost / metrics().total) * 100 : 0) + ', 100'"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
        </svg>
      </div>
    </div>

    <div class="metric-card metric-card--stalled">
      <div class="metric-icon">
        <i class="pi pi-exclamation-triangle"></i>
      </div>
      <div class="metric-content">
        <span class="metric-label">Stalled 30+ days</span>
        <strong class="metric-value">{{ metrics().stalled }}</strong>
      </div>
      <div class="metric-badge" *ngIf="metrics().stalled > 0">
        <span>ALERT</span>
      </div>
    </div>
  </section>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       SMART FILTER BAR
       ═══════════════════════════════════════════════════════════════════════════ -->
  <section class="filter-section">
    <div class="filter-bar">
      <div class="search-wrapper">
        <i class="pi pi-search search-icon"></i>
        <input
          pInputText
          type="search"
          class="search-input"
          placeholder="Search opportunities, accounts, deals..."
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearch($event)"
        />
        <kbd class="search-kbd">⌘K</kbd>
      </div>

      <div class="filter-pills">
        <div class="filter-pill">
          <i class="pi pi-filter"></i>
          <p-select appendTo="body"
            [options]="stageOptions"
            optionLabel="label"
            optionValue="value"
            [ngModel]="stageFilter === 'all' ? null : stageFilter"
            (ngModelChange)="onStageChange($event || 'all')"
            placeholder="All Stages"
            styleClass="filter-select"
          ></p-select>
        </div>
      </div>

      <div class="quick-stages">
        <button pButton type="button" class="stage-pill" [class.active]="stageFilter === 'all'" (click)="onStageChange('all')">All</button>
        <button pButton type="button" class="stage-pill" [class.active]="stageFilter === 'Prospecting'" (click)="onStageChange('Prospecting')">Prospecting</button>
        <button pButton type="button" class="stage-pill" [class.active]="stageFilter === 'Proposal'" (click)="onStageChange('Proposal')">Proposal</button>
        <button pButton type="button" class="stage-pill stage-pill--success" [class.active]="stageFilter === 'Closed Won'" (click)="onStageChange('Closed Won')">Won</button>
        <button pButton type="button" class="stage-pill stage-pill--danger" [class.active]="stageFilter === 'Closed Lost'" (click)="onStageChange('Closed Lost')">Lost</button>
      </div>

      <div class="filter-actions">
        <button pButton type="button" class="btn btn-ghost" (click)="onStageChange('all')">
          <i class="pi pi-times"></i>
          <span>Clear</span>
        </button>
        <button pButton type="button" class="btn btn-ghost" (click)="onExport()">
          <i class="pi pi-download"></i>
          <span>Export</span>
        </button>
      </div>
    </div>

    <div class="filter-summary" *ngIf="searchTerm || stageFilter !== 'all'">
      <span class="summary-label">Active filters:</span>
      <span class="filter-tag" *ngIf="searchTerm">
        "{{ searchTerm }}"
        <i class="pi pi-times" (click)="searchTerm = ''; onSearch('')"></i>
      </span>
      <span class="filter-tag" *ngIf="stageFilter !== 'all'">
        {{ stageFilter }}
        <i class="pi pi-times" (click)="onStageChange('all')"></i>
      </span>
    </div>
  </section>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       DATA TABLE
       ═══════════════════════════════════════════════════════════════════════════ -->
  <section class="data-section">
    <div class="data-card">
      <header class="data-header">
        <div class="header-title">
          <h2>Opportunity Records</h2>
          <span class="record-count">
            {{ opportunities().length }} of {{ total() }} records
          </span>
        </div>
        <div class="header-actions">
          <button pButton type="button" class="action-btn" (click)="onExport()">
            <i class="pi pi-download"></i>
            <span>Export</span>
          </button>
          <button pButton type="button" class="action-btn action-btn--primary" [disabled]="!canManage()" (click)="onCreate()">
            <i class="pi pi-plus"></i>
            <span>Add Opportunity</span>
          </button>
        </div>
      </header>

      <!-- Loading State -->
      <div class="loading-state" *ngIf="loading()">
        <div class="skeleton-row" *ngFor="let _ of [1,2,3,4,5]">
          <div class="skeleton skeleton-avatar"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text skeleton-short"></div>
          <div class="skeleton skeleton-badge"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-actions"></div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="!loading() && !opportunities().length">
        <div class="empty-icon">
          <i class="pi pi-briefcase"></i>
        </div>
        <h3>No opportunities found</h3>
        <p>Try adjusting your search or filters to find what you're looking for</p>
        <button pButton type="button" class="btn btn-primary" (click)="onStageChange('all')">
          <i class="pi pi-refresh"></i>
          <span>Reset Filters</span>
        </button>
      </div>

      <!-- Table View -->
      <div class="table-wrapper" *ngIf="!loading() && opportunities().length">
        <p-table class="data-table" [value]="opportunities()" [resizableColumns]="true" columnResizeMode="fit">
          <ng-template pTemplate="header">
            <tr>
              <th class="th-opportunity" pSortableColumn="name" pResizableColumn>
                Opportunity
                <p-sortIcon field="name"></p-sortIcon>
              </th>
              <th pSortableColumn="account" pResizableColumn>
                Account
                <p-sortIcon field="account"></p-sortIcon>
              </th>
              <th pSortableColumn="stage" pResizableColumn>
                Stage
                <p-sortIcon field="stage"></p-sortIcon>
              </th>
              <th pSortableColumn="amount" pResizableColumn>
                Amount
                <p-sortIcon field="amount"></p-sortIcon>
              </th>
              <th pSortableColumn="probability" pResizableColumn>
                Probability
                <p-sortIcon field="probability"></p-sortIcon>
              </th>
              <th pResizableColumn>Risk</th>
              <th pSortableColumn="status" pResizableColumn>
                Status
                <p-sortIcon field="status"></p-sortIcon>
              </th>
              <th pSortableColumn="owner" pResizableColumn>
                Owner
                <p-sortIcon field="owner"></p-sortIcon>
              </th>
              <th class="th-actions" pResizableColumn>Actions</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr class="table-row" [class.row-stalled]="isStalled(row)">
              <td class="td-opportunity">
                <div class="opportunity-icon">
                  <i class="pi pi-briefcase"></i>
                </div>
                <div class="opportunity-info">
                  <span class="opportunity-name">{{ row.name }}</span>
                  <span class="opportunity-stage">{{ row.stage }}</span>
                </div>
              </td>
              <td>
                <span class="account-name">{{ row.account || '—' }}</span>
              </td>
              <td>
                <ng-container *ngIf="!row.stage.startsWith('Closed'); else closedStage">
                  <p-select appendTo="body"
                    [options]="stageOptionsInline"
                    optionLabel="label"
                    optionValue="value"
                    [ngModel]="row.stage"
                    (ngModelChange)="onInlineStageChange(row, $event)"
                    styleClass="inline-select"
                  ></p-select>
                </ng-container>
                <ng-template #closedStage>
                  <span class="status-badge" [class.status-badge--success]="row.stage === 'Closed Won'" [class.status-badge--danger]="row.stage === 'Closed Lost'">
                    {{ row.stage }}
                  </span>
                </ng-template>
              </td>
              <td>
                <span class="amount-value">{{ row.amount | currency: row.currency }}</span>
              </td>
              <td>
                <div class="probability-cell">
                  <div class="probability-bar">
                    <div class="probability-fill" [style.width.%]="row.probability || 0"></div>
                  </div>
                  <span class="probability-value">{{ row.probability || 0 }}%</span>
                </div>
              </td>
              <td>
                <span class="risk-badge" *ngIf="isStalled(row)">
                  <i class="pi pi-exclamation-triangle"></i>
                  Stalled {{ stalledAge(row) }}d
                </span>
                <span *ngIf="!isStalled(row)">—</span>
              </td>
              <td>
                <span class="status-badge" 
                  [class.status-badge--success]="row.status === 'Closed Won'"
                  [class.status-badge--danger]="row.status === 'Closed Lost'"
                  [class.status-badge--info]="row.status === 'Open'">
                  {{ row.status }}
                </span>
              </td>
              <td>
                <p-select appendTo="body"
                  [options]="ownerOptionsForAssign()"
                  optionLabel="label"
                  optionValue="value"
                  [ngModel]="row.ownerId"
                  (ngModelChange)="onInlineOwnerChange(row, $event)"
                  placeholder="Owner"
                  styleClass="inline-select"
                ></p-select>
              </td>
              <td class="td-actions">
                <div class="action-buttons">
                  <button pButton type="button" class="action-icon" [disabled]="!canManage()" (click)="$event.stopPropagation(); onEdit(row)" pTooltip="Edit">
                    <i class="pi pi-pencil"></i>
                  </button>
                  <button pButton type="button" class="action-icon action-icon--danger" [disabled]="!canManage()" (click)="$event.stopPropagation(); onDelete(row)" pTooltip="Delete">
                    <i class="pi pi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <!-- Paginator -->
      <p-paginator
        *ngIf="!loading() && opportunities().length"
        [rows]="rows"
        [totalRecords]="total()"
        [rowsPerPageOptions]="[5, 10, 20]"
        [first]="pageIndex * rows"
        (onPageChange)="onPageChange($event)"
        styleClass="data-paginator"
      ></p-paginator>
    </div>
  </section>

</div>
