
    <section class="opportunity-form-page">
      <div class="form-header">
        <div class="header-content">
          <app-breadcrumbs></app-breadcrumbs>

          <button type="button" class="back-link" routerLink="/app/opportunities">
            <i class="pi pi-arrow-left"></i>
            Back to Deals
          </button>

          <div class="header-row">
            <div class="header-title">
              <h1 class="hero-title">
                <span class="title-gradient">{{ isEditMode() ? 'Update' : 'Create' }}</span>
                <span class="title-light">Deal</span>
              </h1>
              <p>Capture the deal details, set your stage, and keep the team aligned on next steps.</p>
              <div class="presence-strip" *ngIf="isEditMode() && presenceUsers().length">
                <span class="presence-label">Viewing now</span>
                <span class="presence-chip" *ngFor="let viewer of presenceUsers()">{{ viewer.displayName }}</span>
              </div>
            </div>
            <div class="header-meta">
              <span class="meta-chip">
                <i class="pi pi-flag"></i>
                {{ selectedStage || 'Prospecting' }}
              </span>
              <span class="meta-chip">
                <i class="pi pi-percentage"></i>
                {{ form.probability ?? 0 }}%
              </span>
              <span class="meta-chip">
                <i class="pi pi-money-bill"></i>
                {{ form.currency || resolveCurrencyCode() }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="policy-gate-banner" *ngIf="policyGateMessage() as gateMessage">
        <i class="pi pi-shield"></i>
        <div>
          <strong>Policy gate triggered</strong>
          <p>{{ gateMessage }}</p>
        </div>
        <div class="policy-gate-actions" *ngIf="canRequestStageOverride()">
          <button
            pButton
            type="button"
            class="policy-gate-action-button"
            icon="pi pi-send"
            [label]="stageOverrideRequesting() ? 'Submitting...' : 'Request Stage Override'"
            [loading]="stageOverrideRequesting()"
            [disabled]="stageOverrideRequesting()"
            (click)="requestStageOverride()">
          </button>
        </div>
      </div>

      <section class="decision-review-banner" *ngIf="decisionReviewMode()">
        <i class="pi pi-eye"></i>
        <div>
          <strong>Decision review mode</strong>
          <p>This record is opened from Pending Action in read-only mode. Use the review panel to decide or send back.</p>
        </div>
      </section>

      <section class="decision-review-banner approval-lock-banner" *ngIf="requesterApprovalLocked() && !decisionReviewMode()">
        <i class="pi pi-lock"></i>
        <div>
          <strong>Approval Pending - Record Locked</strong>
          <p>This deal is read-only for all users until the pending approval is approved or rejected.</p>
        </div>
      </section>

      <section class="related-summary" *ngIf="isEditMode()">
        <div class="related-summary-label">Related record</div>
        <div class="related-summary-links" *ngIf="accountLink() as link; else noAccountSummary">
          <a class="related-summary-link" [routerLink]="link">
            <i class="pi pi-building"></i>
            Account: {{ accountLabel() }}
          </a>
        </div>
        <ng-template #noAccountSummary>
          <span class="related-summary-empty">No linked account yet.</span>
        </ng-template>
      </section>

      <div class="form-body">
        <section class="deal-sticky-summary">
          <div class="metric-card metric-card--total">
            <div class="metric-icon">
              <i class="pi pi-briefcase"></i>
            </div>
            <div class="metric-content">
              <span class="metric-label">Deal</span>
              <strong class="metric-value">{{ form.name || 'Untitled deal' }}</strong>
            </div>
          </div>
          <div class="metric-card metric-card--leads">
            <div class="metric-icon">
              <i class="pi pi-flag"></i>
            </div>
            <div class="metric-content">
              <span class="metric-label">Stage</span>
              <strong class="metric-value">{{ selectedStage || 'Prospecting' }}</strong>
            </div>
          </div>
          <div class="metric-card metric-card--prospects">
            <div class="metric-icon">
              <i class="pi pi-money-bill"></i>
            </div>
            <div class="metric-content">
              <span class="metric-label">Amount</span>
              <strong class="metric-value">{{ (form.amount || 0) | currency:resolveCurrencyCode():'symbol':'1.0-0' }}</strong>
            </div>
          </div>
          <div class="metric-card metric-card--customers">
            <div class="metric-icon">
              <i class="pi pi-user"></i>
            </div>
            <div class="metric-content">
              <span class="metric-label">Owner</span>
              <strong class="metric-value">{{ dealOwnerLabel() }}</strong>
            </div>
          </div>
          <div class="metric-card metric-card--risk">
            <div class="metric-icon">
              <i class="pi pi-shield"></i>
            </div>
            <div class="metric-content">
              <span class="metric-label">Risk</span>
              <span
                class="opportunity-accordion-badge metric-card__status-badge"
                [class]="'opportunity-accordion-badge metric-card__status-badge opportunity-accordion-badge--' + dealRiskSummary().tone"
                [title]="dealRiskSummary().detail || ''"
              >
                {{ dealRiskSummary().label }}
              </span>
            </div>
          </div>
          <div class="metric-card metric-card--approval">
            <div class="metric-icon">
              <i class="pi pi-lock"></i>
            </div>
            <div class="metric-content">
              <span class="metric-label">Approval</span>
              <span
                class="opportunity-accordion-badge metric-card__status-badge"
                [class]="'opportunity-accordion-badge metric-card__status-badge opportunity-accordion-badge--' + currentApprovalStatusTone()"
                [title]="approvalPendingSummaryDetail()"
              >
                {{ requesterApprovalLocked() ? 'Approval Pending' : currentApprovalStatusLabel() }}
              </span>
            </div>
          </div>
        </section>

        <div class="deal-workbench-layout">
          <aside class="deal-workbench-nav" aria-label="Deal workflow navigation">
            <div class="deal-workbench-nav__title">Deal Workbench</div>
            <p-tree
              class="deal-stage-tree"
              [value]="dealStageTreeNodes()"
              selectionMode="single"
              [(selection)]="selectedDealTreeNode"
              (onNodeSelect)="onDealTreeNodeSelect($event)"
            >
              <ng-template let-node pTemplate="default">
                <div class="deal-stage-tree__node" *ngIf="node.data?.kind === 'stage'; else sectionNode">
                  <span class="deal-stage-tree__stage-label">{{ node.label }}</span>
                  <span
                    class="opportunity-accordion-badge"
                    [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + stageTreeTone(node.label)"
                  >
                    {{ stageTreeLabel(node.label) }}
                  </span>
                </div>
                <ng-template #sectionNode>
                  <div
                    class="deal-stage-tree__section"
                    [class.deal-stage-tree__section--active]="node.data?.kind === 'section' && isSectionActive(node.data.section)"
                    [class.deal-stage-tree__section--locked]="node.data?.kind === 'section' && isSectionLocked(node.data.section)"
                    [title]="node.data?.kind === 'section' && isSectionLocked(node.data.section) ? (sectionLockReason(node.data.section) || '') : ''"
                  >
                    <span class="deal-stage-tree__section-main">
                      <i [class]="node.data?.kind === 'section' ? sectionIcon(node.data.section) : 'pi pi-circle'"></i>
                      <span>{{ node.label }}</span>
                    </span>
                    <span
                      *ngIf="node.data?.kind === 'section'"
                      class="opportunity-accordion-badge"
                      [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + sectionStatusTone(node.data.section)"
                    >
                      {{ sectionStatusLabel(node.data.section) }}
                    </span>
                  </div>
                </ng-template>
              </ng-template>
            </p-tree>
          </aside>

          <div class="deal-workbench-content">
        <form class="form-layout" [class.form-layout--read-only]="decisionReviewMode() || requesterApprovalLocked()" (ngSubmit)="onSave()">
          <fieldset
            class="form-lock-fieldset"
            [disabled]="decisionReviewMode() || requesterApprovalLocked()"
            [attr.aria-busy]="decisionReviewMode() || requesterApprovalLocked()"
          >
            <p-accordion
              class="opportunity-section-accordion"
              [multiple]="true"
              [value]="accordionPanels()"
              (valueChange)="onAccordionPanelsChange($event)"
            >
            <p-accordion-panel value="opportunity-details" [disabled]="isSectionLocked('opportunity-details')" [attr.data-deal-section]="'opportunity-details'">
              <p-accordion-header>
                <div class="opportunity-accordion-header">
                  <span class="opportunity-accordion-title">
                    <i class="pi pi-briefcase"></i>
                    Deal Details
                  </span>
                  <span class="opportunity-accordion-header-meta">
                    <span class="opportunity-accordion-badge">{{ opportunityDetailsBadge() }}</span>
                    <span
                      class="opportunity-accordion-badge"
                      [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + sectionStatusTone('opportunity-details')"
                    >
                      {{ sectionStatusLabel('opportunity-details') }}
                    </span>
                  </span>
                </div>
              </p-accordion-header>
              <p-accordion-content>
          <section class="form-card opportunity-accordion-card">
            <div class="form-grid">
              <div class="field">
                <label for="oppName">Deal name <span class="required">*</span></label>
                <input
                  pInputText
                  id="oppName"
                  name="name"
                  [(ngModel)]="form.name"
                  required
                  placeholder="ACME rollout"
                  class="w-full"
                />
              </div>
              <div class="field">
                <label for="oppAccount">Account</label>
                <p-select
                  inputId="oppAccount"
                  appendTo="body"
                  [options]="accountOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="accountId"
                  [(ngModel)]="form.accountId"
                  placeholder="Select account"
                  styleClass="w-full"
                ></p-select>
              </div>
              <div class="field">
                <label for="oppStage">Stage *</label>
                <p-select
                  inputId="oppStage"
                  appendTo="body"
                  [options]="stageOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="stage"
                  [(ngModel)]="selectedStage"
                  (ngModelChange)="onStageChange($event)"
                  placeholder="Pick stage"
                  styleClass="w-full"
                ></p-select>
                <small class="field-hint" *ngIf="demoOutcomeGuidance() as guidance">{{ guidance }}</small>
                <small class="field-hint" *ngIf="discoveryGuidance() as discoveryGuidance">{{ discoveryGuidance }}</small>
                <small class="field-hint" *ngIf="decisionMakerGuidance() as decisionGuidance">{{ decisionGuidance }}</small>
                <small class="field-hint" *ngIf="selectedStage === 'Commit'">Commit requires an expected close date and verified checklist items.</small>
              </div>
              <div class="field">
                <label for="oppClose">Expected close</label>
                <p-datePicker
                  inputId="oppClose"
                  appendTo="body"
                  name="closeDate"
                  [(ngModel)]="form.expectedCloseDate"
                  [showIcon]="true"
                  styleClass="w-full"
                ></p-datePicker>
              </div>
            </div>
          </section>
              </p-accordion-content>
            </p-accordion-panel>

            <p-accordion-panel value="deal-settings" [disabled]="isSectionLocked('deal-settings')" [attr.data-deal-section]="'deal-settings'">
              <p-accordion-header>
                <div class="opportunity-accordion-header">
                  <span class="opportunity-accordion-title">
                    <i class="pi pi-chart-line"></i>
                    Deal Settings
                  </span>
                  <span class="opportunity-accordion-header-meta">
                    <span
                      class="opportunity-accordion-badge"
                      [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + amountApprovalBadge().tone"
                    >
                      {{ dealSettingsHeaderBadge() }}
                    </span>
                    <span
                      class="opportunity-accordion-badge"
                      [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + sectionStatusTone('deal-settings')"
                    >
                      {{ sectionStatusLabel('deal-settings') }}
                    </span>
                  </span>
                </div>
              </p-accordion-header>
              <p-accordion-content>
          <section class="form-card opportunity-accordion-card">
            <div class="form-grid">
              <div class="field">
                <div class="field-label-row">
                  <label for="oppAmount">Amount</label>
                  <span
                    class="approval-requirement-badge"
                    [class]="'approval-requirement-badge approval-requirement-badge--' + amountApprovalBadge().tone"
                    [title]="amountApprovalBadge().detail || ''"
                  >
                    {{ amountApprovalBadge().label }}
                  </span>
                </div>
                <p-inputNumber
                  inputId="oppAmount"
                  [(ngModel)]="form.amount"
                  name="amount"
                  (ngModelChange)="syncApprovalAmount()"
                  mode="currency"
                  [currency]="resolveCurrency(form.currency)"
                  placeholder="0"
                  class="w-full"
                ></p-inputNumber>
                <small class="field-hint" *ngIf="amountApprovalBadge().detail">{{ amountApprovalBadge().detail }}</small>
              </div>
              <div class="field">
                <label for="oppCurrency">Currency</label>
                <p-select
                  inputId="oppCurrency"
                  appendTo="body"
                  [options]="currencyOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="currency"
                  [(ngModel)]="form.currency"
                  (ngModelChange)="onCurrencyChange($event)"
                  placeholder="Currency"
                  styleClass="w-full"
                ></p-select>
              </div>
              <div class="field">
                <label for="oppProbability">Probability (%)</label>
                <p-inputNumber
                  inputId="oppProbability"
                  [(ngModel)]="form.probability"
                  name="probability"
                  suffix="%"
                  [min]="0"
                  [max]="100"
                  class="w-full"
                ></p-inputNumber>
              </div>
              <div class="field">
                <label for="oppForecast">Forecast category</label>
                <p-select
                  inputId="oppForecast"
                  appendTo="body"
                  [options]="forecastCategoryOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="forecastCategory"
                  [(ngModel)]="form.forecastCategory"
                  placeholder="Select forecast"
                  [disabled]="isForecastLocked()"
                  styleClass="w-full"
                ></p-select>
                <small class="field-hint" *ngIf="forecastGuidance() as guidance">{{ guidance }}</small>
              </div>
              <div class="field">
                <label for="oppType">Deal type</label>
                <p-select
                  inputId="oppType"
                  appendTo="body"
                  [options]="opportunityTypeOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="opportunityType"
                  [(ngModel)]="form.opportunityType"
                  placeholder="Type"
                  styleClass="w-full"
                ></p-select>
              </div>
              <div class="field">
                <label for="oppContractStart">Contract start</label>
                <p-datePicker
                  inputId="oppContractStart"
                  appendTo="body"
                  name="contractStartDateUtc"
                  [(ngModel)]="form.contractStartDateUtc"
                  [showIcon]="true"
                  styleClass="w-full"
                ></p-datePicker>
              </div>
              <div class="field">
                <label for="oppContractEnd">Contract end</label>
                <p-datePicker
                  inputId="oppContractEnd"
                  appendTo="body"
                  name="contractEndDateUtc"
                  [(ngModel)]="form.contractEndDateUtc"
                  [showIcon]="true"
                  styleClass="w-full"
                ></p-datePicker>
              </div>
              <div class="field">
                <label for="oppReason">Win/Loss reason</label>
                <input
                  pInputText
                  id="oppReason"
                  name="reason"
                  [(ngModel)]="form.winLossReason"
                  placeholder="Optional"
                  class="w-full"
                />
              </div>
              <div class="field full">
                <label for="oppSummary">Summary</label>
                <textarea
                  pTextarea
                  id="oppSummary"
                  rows="4"
                  name="summary"
                  [(ngModel)]="form.summary"
                  placeholder="Key notes, stakeholders, risks"
                  class="w-full"
                ></textarea>
                <small class="field-hint" *ngIf="isPainConfirmationRequired()">Required before moving to Qualification or later stages.</small>
              </div>
              <div class="field full">
                <label>Requirements <span class="required" *ngIf="isQualificationFitRequired()">*</span></label>
                <textarea
                  pTextarea
                  rows="3"
                  name="requirements"
                  [(ngModel)]="form.requirements"
                  placeholder="Key requirements, scope, constraints"
                  class="w-full"
                ></textarea>
              </div>
              <div class="field full">
                <label>Buying process <span class="required" *ngIf="isQualificationFitRequired()">*</span></label>
                <textarea
                  pTextarea
                  rows="3"
                  name="buyingProcess"
                  [(ngModel)]="form.buyingProcess"
                  placeholder="Decision steps, stakeholders, approvals"
                  class="w-full"
                ></textarea>
              </div>
              <div class="field full">
                <label>Success criteria <span class="required" *ngIf="isQualificationFitRequired()">*</span></label>
                <textarea
                  pTextarea
                  rows="3"
                  name="successCriteria"
                  [(ngModel)]="form.successCriteria"
                  placeholder="What must be true for a win"
                  class="w-full"
                ></textarea>
              </div>
            </div>
          </section>
              </p-accordion-content>
            </p-accordion-panel>

            <p-accordion-panel value="pricing-discounts" [disabled]="isSectionLocked('pricing-discounts')" [attr.data-deal-section]="'pricing-discounts'">
              <p-accordion-header>
                <div class="opportunity-accordion-header">
                  <span class="opportunity-accordion-title">
                    <i class="pi pi-percentage"></i>
                    Pricing & Discounts
                  </span>
                  <span class="opportunity-accordion-header-meta">
                    <span
                      class="opportunity-accordion-badge"
                      [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + discountApprovalBadge().tone"
                    >
                      {{ pricingHeaderBadge() }}
                    </span>
                    <span
                      class="opportunity-accordion-badge"
                      [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + sectionStatusTone('pricing-discounts')"
                    >
                      {{ sectionStatusLabel('pricing-discounts') }}
                    </span>
                  </span>
                </div>
              </p-accordion-header>
              <p-accordion-content>
          <section class="form-card opportunity-accordion-card">
            <div class="form-grid">
              <div class="field">
                <div class="field-label-row">
                  <label for="oppDiscountPercent">Discount (%)</label>
                  <span
                    class="approval-requirement-badge"
                    [class]="'approval-requirement-badge approval-requirement-badge--' + discountApprovalBadge().tone"
                    [title]="discountApprovalBadge().detail || ''"
                  >
                    {{ discountApprovalBadge().label }}
                  </span>
                </div>
                <p-inputNumber
                  inputId="oppDiscountPercent"
                  [(ngModel)]="form.discountPercent"
                  name="discountPercent"
                  suffix="%"
                  [min]="0"
                  [max]="100"
                  class="w-full"
                ></p-inputNumber>
                <small class="field-hint" *ngIf="discountApprovalBadge().detail">{{ discountApprovalBadge().detail }}</small>
              </div>
              <div class="field">
                <label for="oppDiscountAmount">Discount Amount</label>
                <p-inputNumber
                  inputId="oppDiscountAmount"
                  [(ngModel)]="form.discountAmount"
                  name="discountAmount"
                  (ngModelChange)="syncApprovalAmount()"
                  mode="currency"
                  [currency]="resolveCurrency(form.currency)"
                  placeholder="0"
                  class="w-full"
                ></p-inputNumber>
              </div>
              <div class="field full">
                <label for="oppPricingNotes">Pricing notes & objections</label>
                <textarea
                  pTextarea
                  id="oppPricingNotes"
                  rows="3"
                  name="pricingNotes"
                  [(ngModel)]="form.pricingNotes"
                  placeholder="Discount rationale, objections, approvals, or constraints"
                  class="w-full"
                ></textarea>
              </div>
            </div>
          </section>
              </p-accordion-content>
            </p-accordion-panel>

            <p-accordion-panel *ngIf="isSectionVisible('quote-proposal')" value="quote-proposal" [disabled]="isSectionLocked('quote-proposal')" [attr.data-deal-section]="'quote-proposal'">
              <p-accordion-header>
                <div class="opportunity-accordion-header">
                  <span class="opportunity-accordion-title">
                    <i class="pi pi-file-edit"></i>
                    Quote / Proposal
                  </span>
                  <span class="opportunity-accordion-header-meta">
                    <span class="opportunity-accordion-badge">{{ proposalHeaderBadge() }}</span>
                    <span
                      class="opportunity-accordion-badge"
                      [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + sectionStatusTone('quote-proposal')"
                    >
                      {{ sectionStatusLabel('quote-proposal') }}
                    </span>
                  </span>
                </div>
              </p-accordion-header>
              <p-accordion-content>
          <section class="form-card opportunity-accordion-card">
            <p class="section-subtitle">Generate and track the proposal before sending to the customer.</p>
            <div class="form-grid">
              <div class="field">
                <label for="oppProposalStatus">Proposal status</label>
                <p-select
                  inputId="oppProposalStatus"
                  appendTo="body"
                  [options]="proposalStatusOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="proposalStatus"
                  [(ngModel)]="form.proposalStatus"
                  placeholder="Select status"
                  styleClass="w-full"
                ></p-select>
              </div>
              <div class="field">
                <label for="oppProposalLink">Proposal link</label>
                <input
                  pInputText
                  id="oppProposalLink"
                  name="proposalLink"
                  [(ngModel)]="form.proposalLink"
                  placeholder="Paste proposal URL"
                  class="w-full"
                />
              </div>
              <div class="field">
                <label for="oppProposalGenerated">Generated on</label>
                <p-datePicker
                  inputId="oppProposalGenerated"
                  [(ngModel)]="form.proposalGeneratedAtUtc"
                  name="proposalGeneratedAtUtc"
                  [showIcon]="true"
                  appendTo="body"
                  class="w-full"
                ></p-datePicker>
              </div>
              <div class="field">
                <label for="oppProposalSent">Sent on</label>
                <p-datePicker
                  inputId="oppProposalSent"
                  [(ngModel)]="form.proposalSentAtUtc"
                  name="proposalSentAtUtc"
                  [showIcon]="true"
                  appendTo="body"
                  class="w-full"
                ></p-datePicker>
              </div>
              <div class="field full">
                <label for="oppProposalNotes">Proposal summary</label>
                <textarea
                  pTextarea
                  id="oppProposalNotes"
                  rows="3"
                  name="proposalNotes"
                  [(ngModel)]="form.proposalNotes"
                  placeholder="Scope summary, key terms, or customer notes"
                  class="w-full"
                ></textarea>
              </div>
            </div>
            <div class="quote-workspace">
              <div class="quote-workspace__header">
                <h4>Quote Workspace</h4>
                <span class="field-hint" *ngIf="activeQuote">Quote #{{ activeQuote.quoteNumber }}</span>
              </div>
              <div class="form-grid">
                <div class="field">
                  <label for="oppQuoteSelect">Quote draft</label>
                  <p-select
                    inputId="oppQuoteSelect"
                    appendTo="body"
                    [options]="quoteSummaries"
                    optionLabel="name"
                    optionValue="id"
                    [showClear]="true"
                    [ngModel]="selectedQuoteId"
                    (ngModelChange)="onQuoteSelectionChange($event)"
                    placeholder="Select quote"
                    styleClass="w-full"
                  ></p-select>
                </div>
                <div class="field">
                  <label for="oppQuoteName">Quote name</label>
                  <input
                    pInputText
                    id="oppQuoteName"
                    [(ngModel)]="quoteName"
                    name="quoteName"
                    class="w-full"
                    placeholder="Quote name"
                  />
                </div>
                <div class="field">
                  <label for="oppQuotePriceList">Price list</label>
                  <p-select
                    inputId="oppQuotePriceList"
                    appendTo="body"
                    [options]="priceListOptions"
                    optionLabel="label"
                    optionValue="value"
                    [(ngModel)]="quotePriceListId"
                    name="quotePriceListId"
                    placeholder="Select price list"
                    styleClass="w-full"
                  ></p-select>
                </div>
                <div class="field">
                  <label for="oppQuoteTax">Tax amount</label>
                  <p-inputNumber
                    inputId="oppQuoteTax"
                    [(ngModel)]="quoteTaxAmount"
                    name="quoteTaxAmount"
                    mode="currency"
                    [currency]="resolveCurrency(quoteCurrency || form.currency)"
                    class="w-full"
                  ></p-inputNumber>
                </div>
              </div>

              <div class="quote-lines" *ngIf="quoteLines.length; else emptyQuoteLines">
                <div class="quote-line quote-line--header">
                  <span>Product</span>
                  <span>Description</span>
                  <span>Qty</span>
                  <span>Unit Price</span>
                  <span>Disc %</span>
                  <span>Total</span>
                  <span></span>
                </div>
                <div class="quote-line" *ngFor="let line of quoteLines; let i = index">
                  <p-select
                    appendTo="body"
                    [options]="itemOptionsForLine(line)"
                    optionLabel="label"
                    optionValue="value"
                    [(ngModel)]="line.itemMasterId"
                    name="quoteItem{{ i }}"
                    placeholder="Item"
                    (ngModelChange)="onQuoteItemChanged(i)"
                    styleClass="w-full"
                  ></p-select>
                  <input
                    pInputText
                    [(ngModel)]="line.description"
                    name="quoteDescription{{ i }}"
                    (ngModelChange)="onQuoteLineChanged()"
                    placeholder="Line description"
                    class="w-full"
                  />
                  <p-inputNumber
                    [(ngModel)]="line.quantity"
                    name="quoteQty{{ i }}"
                    [min]="1"
                    (ngModelChange)="onQuoteLineChanged()"
                    class="w-full"
                  ></p-inputNumber>
                  <p-inputNumber
                    [(ngModel)]="line.unitPrice"
                    name="quoteUnitPrice{{ i }}"
                    mode="currency"
                    [currency]="resolveCurrency(quoteCurrency || form.currency)"
                    (ngModelChange)="onQuoteLineChanged()"
                    class="w-full"
                  ></p-inputNumber>
                  <p-inputNumber
                    [(ngModel)]="line.discountPercent"
                    name="quoteDiscount{{ i }}"
                    suffix="%"
                    [min]="0"
                    [max]="100"
                    (ngModelChange)="onQuoteLineChanged()"
                    class="w-full"
                  ></p-inputNumber>
                  <p-inputNumber
                    [ngModel]="line.lineTotal"
                    [disabled]="true"
                    mode="currency"
                    [currency]="resolveCurrency(quoteCurrency || form.currency)"
                    class="w-full"
                  ></p-inputNumber>
                  <button type="button" class="btn-glass btn-icon" (click)="removeQuoteLine(i)">
                    <i class="pi pi-times"></i>
                  </button>
                </div>
              </div>
              <ng-template #emptyQuoteLines>
                <p class="empty-state">No quote lines yet. Add products to build this quote.</p>
              </ng-template>

              <div class="quote-summary">
                <span>Subtotal: {{ quoteSubtotal() | number: '1.2-2' }}</span>
                <span>Discount: {{ quoteDiscountAmount() | number: '1.2-2' }}</span>
                <span>Total: {{ quoteTotal() | number: '1.2-2' }}</span>
              </div>
              <div class="proposal-preview-card" *ngIf="proposalPreviewUrl() as proposalUrl">
                <div class="proposal-preview-card__info">
                  <span class="proposal-preview-card__label">Proposal file ready</span>
                  <a class="proposal-preview-card__link" [href]="proposalUrl" target="_blank" rel="noopener">
                    {{ form.proposalLink }}
                  </a>
                </div>
                <div class="proposal-preview-card__actions">
                  <a
                    pButton
                    [href]="proposalUrl"
                    target="_blank"
                    rel="noopener"
                    class="p-button-sm p-button-text"
                    icon="pi pi-eye"
                    label="Preview"
                  ></a>
                  <a
                    pButton
                    [href]="proposalUrl"
                    target="_blank"
                    rel="noopener"
                    download
                    class="p-button-sm"
                    icon="pi pi-download"
                    label="Download"
                  ></a>
                </div>
              </div>
              <div class="proposal-activity-card" *ngIf="proposalActivityTimeline().length">
                <h5>Proposal activity</h5>
                <div class="proposal-activity-row" *ngFor="let event of proposalActivityTimeline()">
                  <div class="proposal-activity-row__title">
                    {{ proposalActivityLabel(event) }}
                    <span *ngIf="event.field === 'ProposalSentTo' && event.newValue">to {{ event.newValue }}</span>
                  </div>
                  <div class="proposal-activity-row__meta">
                    <span>{{ event.createdAtUtc | date: 'medium' }}</span>
                    <span *ngIf="event.changedByName">by {{ event.changedByName }}</span>
                    <button
                      *ngIf="event.action === 'ProposalSent' && isLatestProposalSentEvent(event)"
                      pButton
                      type="button"
                      class="p-button-sm p-button-text"
                      icon="pi pi-replay"
                      label="Resend"
                      (click)="resendProposalFromActivity(event)"
                    ></button>
                    <span
                      *ngIf="isRecentlyResentEvent(event)"
                      class="proposal-resent-chip"
                    >
                      <i class="pi pi-check"></i>
                      Resent just now
                    </span>
                  </div>
                </div>
              </div>
            </div>
            <div class="team-actions">
              <button type="button" class="btn-glass" (click)="addQuoteLine()">
                <i class="pi pi-plus"></i>
                Add line
              </button>
              <button type="button" class="btn-glass btn-primary" [disabled]="quoteSaving()" (click)="saveQuoteAsDraft()">
                <i class="pi pi-save"></i>
                Save quote
              </button>
              <button
                type="button"
                class="btn-glass"
                [disabled]="quoteApprovalSubmitting() || !selectedQuoteId"
                (click)="submitQuoteForApproval()"
              >
                <i class="pi pi-check-circle"></i>
                Submit for approval
              </button>
              <button type="button" class="btn-glass" [disabled]="proposalGenerating() || !selectedQuoteId" (click)="generateProposal()">
                <i class="pi pi-file"></i>
                {{ proposalGenerating() ? 'Generating...' : 'Generate proposal' }}
              </button>
              <button type="button" class="btn-glass" [disabled]="proposalSending() || !selectedQuoteId || !proposalPreviewUrl()" (click)="openSendProposalDialog()">
                <i class="pi pi-send"></i>
                {{ proposalSending() ? 'Sending...' : 'Send proposal' }}
              </button>
            </div>
            <p class="proposal-send-hint" *ngIf="selectedQuoteId && !proposalPreviewUrl()">
              Generate proposal first to enable sending.
            </p>
            <p-dialog
              header="Send Proposal"
              [(visible)]="proposalSendDialogVisible"
              [modal]="true"
              [draggable]="false"
              [resizable]="false"
              [style]="{ width: '34rem', maxWidth: '95vw' }"
            >
              <div class="proposal-send-dialog">
                <div class="field">
                  <label for="proposalSendRecipient">Recipient email (optional)</label>
                  <input
                    pInputText
                    id="proposalSendRecipient"
                    [(ngModel)]="proposalSendRecipient"
                    name="proposalSendRecipient"
                    class="w-full"
                    placeholder="Leave empty to use primary contact email"
                  />
                </div>
                <div class="field">
                  <label for="proposalSendMessage">Message (optional)</label>
                  <textarea
                    pTextarea
                    id="proposalSendMessage"
                    [(ngModel)]="proposalSendMessage"
                    name="proposalSendMessage"
                    class="w-full"
                    rows="4"
                    placeholder="Add a short custom message"
                  ></textarea>
                </div>
                <div class="proposal-send-dialog__actions">
                  <button
                    pButton
                    type="button"
                    class="p-button-text"
                    label="Cancel"
                    icon="pi pi-times"
                    (click)="proposalSendDialogVisible = false"
                  ></button>
                  <button
                    pButton
                    type="button"
                    label="{{ proposalSending() ? 'Sending...' : 'Send proposal' }}"
                    icon="pi pi-send"
                    [disabled]="proposalSending()"
                    (click)="markProposalSent()"
                  ></button>
                </div>
              </div>
            </p-dialog>
          </section>
              </p-accordion-content>
            </p-accordion-panel>

            <p-accordion-panel *ngIf="isSectionVisible('pre-sales-team')" value="pre-sales-team" [disabled]="isSectionLocked('pre-sales-team')" [attr.data-deal-section]="'pre-sales-team'">
              <p-accordion-header>
                <div class="opportunity-accordion-header">
                  <span class="opportunity-accordion-title">
                    <i class="pi pi-users"></i>
                    Pre-Sales Team
                  </span>
                  <span class="opportunity-accordion-header-meta">
                    <span class="opportunity-accordion-badge">{{ preSalesTeamHeaderBadge() }}</span>
                    <span
                      class="opportunity-accordion-badge"
                      [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + sectionStatusTone('pre-sales-team')"
                    >
                      {{ sectionStatusLabel('pre-sales-team') }}
                    </span>
                  </span>
                </div>
              </p-accordion-header>
              <p-accordion-content>
          <ng-container *ngIf="!isEditMode() || isSectionLoaded('pre-sales-team'); else preSalesLoading">
          <section class="form-card opportunity-accordion-card">
            <p class="section-subtitle">Track solution partners and demo owners supporting this deal.</p>
            <div class="team-grid" *ngIf="teamMembers.length; else emptyTeam">
              <div class="team-row" *ngFor="let member of teamMembers; let i = index">
                <p-select
                  appendTo="body"
                  [options]="teamMemberOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="teamUser{{ i }}"
                  [(ngModel)]="teamMembers[i].userId"
                  (ngModelChange)="markTeamDirty()"
                  placeholder="Select teammate"
                  styleClass="w-full"
                ></p-select>
                <p-select
                  appendTo="body"
                  [options]="teamRoleOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="teamRole{{ i }}"
                  [(ngModel)]="teamMembers[i].role"
                  (ngModelChange)="markTeamDirty()"
                  placeholder="Role"
                  styleClass="w-full"
                ></p-select>
                <button type="button" class="btn-glass btn-icon" (click)="removeTeamMember(i)">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </div>
            <ng-template #emptyTeam>
              <p class="empty-state">No pre-sales teammates yet.</p>
            </ng-template>
            <div class="team-actions">
              <button type="button" class="btn-glass" (click)="addTeamMember()">
                <i class="pi pi-plus"></i>
                Add teammate
              </button>
            </div>
            <div class="form-grid">
              <div class="field full">
                <label for="oppPreSalesScope">Scope summary</label>
                <textarea
                  pTextarea
                  id="oppPreSalesScope"
                  rows="3"
                  name="preSalesScope"
                  [(ngModel)]="form.preSalesScope"
                  placeholder="Solution scope, deliverables, and boundaries"
                  class="w-full"
                ></textarea>
              </div>
              <div class="field full">
                <label for="oppPreSalesApproach">Approach / solution outline</label>
                <textarea
                  pTextarea
                  id="oppPreSalesApproach"
                  rows="3"
                  name="preSalesApproach"
                  [(ngModel)]="form.preSalesApproach"
                  placeholder="Proposed approach, timeline, and key assumptions"
                  class="w-full"
                ></textarea>
              </div>
            </div>
          </section>
          </ng-container>
          <ng-template #preSalesLoading>
            <section class="form-card opportunity-accordion-card section-loading-card">
              <p class="helper-text">{{ isSectionLoading('pre-sales-team') ? 'Loading pre-sales team…' : 'Open section to load pre-sales team.' }}</p>
            </section>
          </ng-template>
              </p-accordion-content>
            </p-accordion-panel>

            <p-accordion-panel value="approval-workflow" *ngIf="isSectionVisible('approval-workflow')" [disabled]="isSectionLocked('approval-workflow')" [attr.data-deal-section]="'approval-workflow'">
              <p-accordion-header>
                <div class="opportunity-accordion-header">
                  <span class="opportunity-accordion-title">
                    <i class="pi pi-check-circle"></i>
                    Approval Workflow
                  </span>
                  <span class="opportunity-accordion-header-meta">
                    <span
                      class="opportunity-accordion-badge"
                      [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + approvalWorkflowHeaderTone()"
                    >
                      {{ approvalWorkflowHeaderBadge() }}
                    </span>
                    <span
                      class="opportunity-accordion-badge"
                      [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + sectionStatusTone('approval-workflow')"
                    >
                      {{ sectionStatusLabel('approval-workflow') }}
                    </span>
                  </span>
                </div>
              </p-accordion-header>
              <p-accordion-content>
          <ng-container *ngIf="!isEditMode() || isSectionLoaded('approval-workflow'); else approvalLoading">
          <section class="form-card opportunity-accordion-card" *ngIf="isEditMode()">
            <div class="approval-current-status">
              <span class="approval-current-status__label">Current Approval Status</span>
              <span
                class="opportunity-accordion-badge"
                [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + currentApprovalStatusTone()"
              >
                {{ currentApprovalStatusLabel() }}
              </span>
            </div>

            <div class="approval-request">
              <div class="approval-request-row">
                <div class="field">
                  <label>Purpose</label>
                  <p-select
                    appendTo="body"
                    [options]="approvalPurposeOptions"
                    optionLabel="label"
                    optionValue="value"
                    name="approvalPurpose"
                    [(ngModel)]="approvalRequest.purpose"
                    (ngModelChange)="onApprovalPurposeChange($event)"
                    placeholder="Purpose"
                    styleClass="w-full"
                  ></p-select>
                </div>
                <div class="field">
                  <label>Amount</label>
                  <p-inputNumber
                    [(ngModel)]="approvalRequest.amount"
                    name="approvalAmount"
                    mode="currency"
                    [currency]="resolveCurrency(approvalRequest.currency)"
                    class="w-full"
                    (ngModelChange)="onApprovalAmountEdited()"
                  ></p-inputNumber>
                </div>
                <div class="field">
                  <label>Currency</label>
                  <p-select
                    appendTo="body"
                    [options]="currencyOptions"
                    optionLabel="label"
                    optionValue="value"
                    name="approvalCurrency"
                    [(ngModel)]="approvalRequest.currency"
                    placeholder="Currency"
                    styleClass="w-full"
                  ></p-select>
                </div>
                <div class="field approval-action">
                  <label>&nbsp;</label>
                  <button
                    pButton
                    type="button"
                    class="crm-button--primary"
                    [disabled]="!canRequestApproval() || approvalRequesting()"
                    (click)="requestApproval()"
                  >
                    <span *ngIf="!approvalRequesting()">Request approval</span>
                    <span *ngIf="approvalRequesting()">Requesting…</span>
                  </button>
                </div>
              </div>
              <p class="helper-text" *ngIf="canRequestApproval(); else noApprovalPermission">
                Request approval before closing or applying large discounts.
              </p>
              <ng-template #noApprovalPermission>
                <p class="helper-text muted">You don’t have permission to request approvals.</p>
              </ng-template>
            </div>

            <div class="approval-summary-list" *ngIf="approvals.length; else noApprovals">
              <div class="approval-summary-item" *ngFor="let approval of approvals">
                <div class="approval-meta">
                  <span [class]="approvalStatusClass(approval.status)">{{ approval.status }}</span>
                  <span class="approval-purpose">{{ approval.purpose }}</span>
                  <span class="approval-amount">
                    {{ approval.amount | number:'1.0-2' }} {{ approval.currency }}
                  </span>
                </div>
                <div class="approval-details">
                  <span>Requested by {{ approval.requestedByName || 'Unknown' }}</span>
                  <span>{{ approval.requestedOn | date:'medium' }}</span>
                  <span *ngIf="approval.totalSteps && approval.totalSteps > 1">
                    Step {{ approval.stepOrder || 1 }} of {{ approval.totalSteps }}
                  </span>
                  <span *ngIf="approval.totalSteps && approval.totalSteps > 1">
                    Chain status: {{ approval.chainStatus || approval.status }}
                  </span>
                  <span *ngIf="approval.approverRole">Approver role: {{ approval.approverRole }}</span>
                  <span *ngIf="approval.approverName">Approved by: {{ approval.approverName }}</span>
                  <span *ngIf="approval.decisionOn">Decision: {{ approval.decisionOn | date:'medium' }}</span>
                </div>
                <div class="approval-notes" *ngIf="approval.status !== 'Pending' && approval.notes">
                  {{ approval.notes }}
                </div>
              </div>
            </div>
            <ng-template #noApprovals>
              <p class="helper-text">No approvals requested yet.</p>
            </ng-template>
            <p class="helper-text muted" *ngIf="decisionReviewMode()">
              Decision actions are handled in the Review Action section.
            </p>
          </section>
          </ng-container>
          <ng-template #approvalLoading>
            <section class="form-card opportunity-accordion-card section-loading-card">
              <p class="helper-text">{{ isSectionLoading('approval-workflow') ? 'Loading approvals…' : 'Open section to load approvals.' }}</p>
            </section>
          </ng-template>
              </p-accordion-content>
            </p-accordion-panel>

            <p-accordion-panel *ngIf="isSectionVisible('security-legal')" value="security-legal" [disabled]="isSectionLocked('security-legal')" [attr.data-deal-section]="'security-legal'">
              <p-accordion-header>
                <div class="opportunity-accordion-header">
                  <span class="opportunity-accordion-title">
                    <i class="pi pi-shield"></i>
                    Security & Legal Review
                  </span>
                  <span class="opportunity-accordion-header-meta">
                    <span class="opportunity-accordion-badge">{{ securityLegalHeaderBadge() }}</span>
                    <span
                      class="opportunity-accordion-badge"
                      [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + sectionStatusTone('security-legal')"
                    >
                      {{ sectionStatusLabel('security-legal') }}
                    </span>
                  </span>
                </div>
              </p-accordion-header>
              <p-accordion-content>
          <ng-container *ngIf="!isEditMode() || isSectionLoaded('security-legal'); else securityLoading">
          <section class="form-card opportunity-accordion-card">
            <div class="form-grid">
              <div class="field">
                <label for="oppSecurityStatus">Security status</label>
                <p-select
                  inputId="oppSecurityStatus"
                  appendTo="body"
                  [options]="reviewStatusOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="securityReviewStatus"
                  [(ngModel)]="form.securityReviewStatus"
                  placeholder="Select status"
                  styleClass="w-full"
                ></p-select>
              </div>
              <div class="field">
                <label for="oppLegalStatus">Legal status</label>
                <p-select
                  inputId="oppLegalStatus"
                  appendTo="body"
                  [options]="reviewStatusOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="legalReviewStatus"
                  [(ngModel)]="form.legalReviewStatus"
                  placeholder="Select status"
                  styleClass="w-full"
                ></p-select>
              </div>
              <div class="field full review-checklist">
                <div class="checklist-header">
                  <h4>Security checklist</h4>
                  <div class="checklist-add">
                    <input
                      pInputText
                      name="newSecurityItem"
                      [(ngModel)]="newSecurityItem"
                      placeholder="Add security task"
                      class="w-full"
                    />
                    <button pButton type="button" class="btn-glass btn-sm" (click)="addChecklistItem('Security')">
                      <i class="pi pi-plus"></i>
                      Add
                    </button>
                  </div>
                </div>
                <div class="checklist-list" *ngIf="securityChecklist.length; else emptySecurityChecklist">
                  <div class="checklist-item" *ngFor="let item of securityChecklist">
                    <input
                      pInputText
                      [(ngModel)]="item.title"
                      name="securityTitle{{item.id}}"
                      (blur)="saveChecklistItem(item)"
                      class="w-full"
                    />
                    <p-select
                      appendTo="body"
                      [options]="reviewStatusOptions"
                      optionLabel="label"
                      optionValue="value"
                      [(ngModel)]="item.status"
                      name="securityStatus{{item.id}}"
                      (onChange)="saveChecklistItem(item)"
                      styleClass="w-full"
                    ></p-select>
                    <input
                      pInputText
                      [(ngModel)]="item.notes"
                      name="securityNotes{{item.id}}"
                      placeholder="Notes (optional)"
                      (blur)="saveChecklistItem(item)"
                      class="w-full"
                    />
                    <span class="checklist-status" *ngIf="isChecklistSaving(item)">
                      Saving…
                    </span>
                    <span class="checklist-status saved" *ngIf="isChecklistSaved(item)">
                      Saved
                    </span>
                    <button pButton type="button" class="btn-glass btn-sm" (click)="deleteChecklistItem(item)">
                      <i class="pi pi-trash"></i>
                    </button>
                  </div>
                </div>
                <ng-template #emptySecurityChecklist>
                  <p class="helper-text">No security checklist items yet.</p>
                </ng-template>
              </div>

              <div class="field full review-checklist">
                <div class="checklist-header">
                  <h4>Legal checklist</h4>
                  <div class="checklist-add">
                    <input
                      pInputText
                      name="newLegalItem"
                      [(ngModel)]="newLegalItem"
                      placeholder="Add legal task"
                      class="w-full"
                    />
                    <button pButton type="button" class="btn-glass btn-sm" (click)="addChecklistItem('Legal')">
                      <i class="pi pi-plus"></i>
                      Add
                    </button>
                  </div>
                </div>
                <div class="checklist-list" *ngIf="legalChecklist.length; else emptyLegalChecklist">
                  <div class="checklist-item" *ngFor="let item of legalChecklist">
                    <input
                      pInputText
                      [(ngModel)]="item.title"
                      name="legalTitle{{item.id}}"
                      (blur)="saveChecklistItem(item)"
                      class="w-full"
                    />
                    <p-select
                      appendTo="body"
                      [options]="reviewStatusOptions"
                      optionLabel="label"
                      optionValue="value"
                      [(ngModel)]="item.status"
                      name="legalStatus{{item.id}}"
                      (onChange)="saveChecklistItem(item)"
                      styleClass="w-full"
                    ></p-select>
                    <input
                      pInputText
                      [(ngModel)]="item.notes"
                      name="legalNotes{{item.id}}"
                      placeholder="Notes (optional)"
                      (blur)="saveChecklistItem(item)"
                      class="w-full"
                    />
                    <span class="checklist-status" *ngIf="isChecklistSaving(item)">
                      Saving…
                    </span>
                    <span class="checklist-status saved" *ngIf="isChecklistSaved(item)">
                      Saved
                    </span>
                    <button pButton type="button" class="btn-glass btn-sm" (click)="deleteChecklistItem(item)">
                      <i class="pi pi-trash"></i>
                    </button>
                  </div>
                </div>
                <ng-template #emptyLegalChecklist>
                  <p class="helper-text">No legal checklist items yet.</p>
                </ng-template>
              </div>

              <div class="field full review-checklist">
                <div class="checklist-header">
                  <h4>Technical risk checklist</h4>
                  <div class="checklist-add">
                    <input
                      pInputText
                      name="newTechnicalItem"
                      [(ngModel)]="newTechnicalItem"
                      placeholder="Add technical risk"
                      class="w-full"
                    />
                    <button pButton type="button" class="btn-glass btn-sm" (click)="addChecklistItem('Technical')">
                      <i class="pi pi-plus"></i>
                      Add
                    </button>
                  </div>
                </div>
                <div class="checklist-list" *ngIf="technicalChecklist.length; else emptyTechnicalChecklist">
                  <div class="checklist-item" *ngFor="let item of technicalChecklist">
                    <input
                      pInputText
                      [(ngModel)]="item.title"
                      name="technicalTitle{{item.id}}"
                      (blur)="saveChecklistItem(item)"
                      class="w-full"
                    />
                    <p-select
                      appendTo="body"
                      [options]="reviewStatusOptions"
                      optionLabel="label"
                      optionValue="value"
                      [(ngModel)]="item.status"
                      name="technicalStatus{{item.id}}"
                      (onChange)="saveChecklistItem(item)"
                      styleClass="w-full"
                    ></p-select>
                    <input
                      pInputText
                      [(ngModel)]="item.notes"
                      name="technicalNotes{{item.id}}"
                      placeholder="Notes (optional)"
                      (blur)="saveChecklistItem(item)"
                      class="w-full"
                    />
                    <span class="checklist-status" *ngIf="isChecklistSaving(item)">
                      Saving…
                    </span>
                    <span class="checklist-status saved" *ngIf="isChecklistSaved(item)">
                      Saved
                    </span>
                    <button pButton type="button" class="btn-glass btn-sm" (click)="deleteChecklistItem(item)">
                      <i class="pi pi-trash"></i>
                    </button>
                  </div>
                </div>
                <ng-template #emptyTechnicalChecklist>
                  <p class="helper-text">No technical risks logged yet.</p>
                </ng-template>
              </div>
            </div>
          </section>
          </ng-container>
          <ng-template #securityLoading>
            <section class="form-card opportunity-accordion-card section-loading-card">
              <p class="helper-text">{{ isSectionLoading('security-legal') ? 'Loading security and legal checklists…' : 'Open section to load checklists.' }}</p>
            </section>
          </ng-template>
              </p-accordion-content>
            </p-accordion-panel>

            <p-accordion-panel *ngIf="isSectionVisible('delivery-handoff')" value="delivery-handoff" [disabled]="isSectionLocked('delivery-handoff')" [attr.data-deal-section]="'delivery-handoff'">
              <p-accordion-header>
                <div class="opportunity-accordion-header">
                  <span class="opportunity-accordion-title">
                    <i class="pi pi-briefcase"></i>
                    Delivery Handoff
                  </span>
                  <span class="opportunity-accordion-header-meta">
                    <span class="opportunity-accordion-badge">{{ deliveryHeaderBadge() }}</span>
                    <span
                      class="opportunity-accordion-badge"
                      [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + sectionStatusTone('delivery-handoff')"
                    >
                      {{ sectionStatusLabel('delivery-handoff') }}
                    </span>
                  </span>
                </div>
              </p-accordion-header>
              <p-accordion-content>
          <section class="form-card opportunity-accordion-card">
            <p class="section-subtitle">Capture scope, risks, and delivery ownership before kickoff.</p>
            <div class="form-grid">
              <div class="field">
                <label for="oppDeliveryOwner">Delivery owner</label>
                <p-select
                  inputId="oppDeliveryOwner"
                  appendTo="body"
                  [options]="teamMemberOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="deliveryOwnerId"
                  [(ngModel)]="form.deliveryOwnerId"
                  placeholder="Select owner"
                  styleClass="w-full"
                ></p-select>
              </div>
              <div class="field">
                <label for="oppDeliveryStatus">Delivery status</label>
                <p-select
                  inputId="oppDeliveryStatus"
                  appendTo="body"
                  [options]="deliveryStatusOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="deliveryStatus"
                  [(ngModel)]="form.deliveryStatus"
                  placeholder="Status"
                  styleClass="w-full"
                ></p-select>
              </div>
              <div class="field full">
                <label for="oppDeliveryScope">Scope</label>
                <textarea
                  pTextarea
                  id="oppDeliveryScope"
                  rows="3"
                  name="deliveryHandoffScope"
                  [(ngModel)]="form.deliveryHandoffScope"
                  placeholder="Implementation scope and key deliverables"
                  class="w-full"
                ></textarea>
              </div>
              <div class="field full">
                <label for="oppDeliveryRisks">Risks</label>
                <textarea
                  pTextarea
                  id="oppDeliveryRisks"
                  rows="3"
                  name="deliveryHandoffRisks"
                  [(ngModel)]="form.deliveryHandoffRisks"
                  placeholder="Dependencies, blockers, or risks"
                  class="w-full"
                ></textarea>
              </div>
              <div class="field full">
                <label for="oppDeliveryTimeline">Timeline</label>
                <textarea
                  pTextarea
                  id="oppDeliveryTimeline"
                  rows="2"
                  name="deliveryHandoffTimeline"
                  [(ngModel)]="form.deliveryHandoffTimeline"
                  placeholder="Target milestones and timing"
                  class="w-full"
                ></textarea>
              </div>
              <div class="field full">
                <button
                  pButton
                  type="button"
                  class="crm-button crm-button--primary"
                  icon="pi pi-calendar-plus"
                  label="Trigger kickoff"
                  [disabled]="!isEditMode()"
                  (click)="triggerKickoff()"
                ></button>
              </div>
            </div>
          </section>
              </p-accordion-content>
            </p-accordion-panel>

            <p-accordion-panel *ngIf="isSectionVisible('onboarding')" value="onboarding" [disabled]="isSectionLocked('onboarding')" [attr.data-deal-section]="'onboarding'">
              <p-accordion-header>
                <div class="opportunity-accordion-header">
                  <span class="opportunity-accordion-title">
                    <i class="pi pi-list-check"></i>
                    Onboarding Checklist & Milestones
                  </span>
                  <span class="opportunity-accordion-header-meta">
                    <span class="opportunity-accordion-badge">{{ onboardingHeaderBadge() }}</span>
                    <span
                      class="opportunity-accordion-badge"
                      [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + sectionStatusTone('onboarding')"
                    >
                      {{ sectionStatusLabel('onboarding') }}
                    </span>
                  </span>
                </div>
              </p-accordion-header>
              <p-accordion-content>
          <ng-container *ngIf="!isEditMode() || isSectionLoaded('onboarding'); else onboardingLoading">
          <section class="form-card opportunity-accordion-card">
            <div class="checklist-form">
              <input
                pInputText
                type="text"
                name="newOnboardingChecklistItem"
                [(ngModel)]="newOnboardingChecklistItem"
                placeholder="Add onboarding checklist item"
                class="w-full"
              />
              <button pButton type="button" class="btn-glass btn-sm" (click)="addOnboardingItem('Checklist')">
                Add checklist
              </button>
            </div>
            <div class="checklist-list" *ngIf="onboardingChecklist.length; else emptyOnboardingChecklist">
              <div class="checklist-item" *ngFor="let item of onboardingChecklist">
                <input
                  pInputText
                  type="text"
                  [(ngModel)]="item.title"
                  [ngModelOptions]="{ standalone: true }"
                  (blur)="saveOnboardingItem(item)"
                  class="w-full"
                />
                <p-select
                  appendTo="body"
                  [options]="onboardingStatusOptions"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="item.status"
                  [ngModelOptions]="{ standalone: true }"
                  (onChange)="saveOnboardingItem(item)"
                  styleClass="w-full"
                ></p-select>
                <p-datePicker
                  appendTo="body"
                  [(ngModel)]="item.dueDateUtc"
                  [ngModelOptions]="{ standalone: true }"
                  (onSelect)="saveOnboardingItem(item)"
                  [showIcon]="true"
                  styleClass="w-full"
                ></p-datePicker>
                <textarea
                  pTextarea
                  rows="2"
                  [(ngModel)]="item.notes"
                  [ngModelOptions]="{ standalone: true }"
                  (blur)="saveOnboardingItem(item)"
                  placeholder="Notes"
                  class="w-full"
                ></textarea>
                <span class="checklist-status" *ngIf="isOnboardingSaving(item)">Saving...</span>
                <span class="checklist-status saved" *ngIf="isOnboardingSaved(item)">Saved</span>
                <button pButton type="button" class="btn-glass btn-sm" (click)="deleteOnboardingItem(item)">
                  Remove
                </button>
              </div>
            </div>
            <ng-template #emptyOnboardingChecklist>
              <p class="empty-state">No onboarding checklist items yet.</p>
            </ng-template>

            <div class="checklist-form">
              <input
                pInputText
                type="text"
                name="newOnboardingMilestoneItem"
                [(ngModel)]="newOnboardingMilestoneItem"
                placeholder="Add onboarding milestone"
                class="w-full"
              />
              <button pButton type="button" class="btn-glass btn-sm" (click)="addOnboardingItem('Milestone')">
                Add milestone
              </button>
            </div>
            <div class="checklist-list" *ngIf="onboardingMilestones.length; else emptyOnboardingMilestones">
              <div class="checklist-item" *ngFor="let item of onboardingMilestones">
                <input
                  pInputText
                  type="text"
                  [(ngModel)]="item.title"
                  [ngModelOptions]="{ standalone: true }"
                  (blur)="saveOnboardingItem(item)"
                  class="w-full"
                />
                <p-select
                  appendTo="body"
                  [options]="onboardingStatusOptions"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="item.status"
                  [ngModelOptions]="{ standalone: true }"
                  (onChange)="saveOnboardingItem(item)"
                  styleClass="w-full"
                ></p-select>
                <p-datePicker
                  appendTo="body"
                  [(ngModel)]="item.dueDateUtc"
                  [ngModelOptions]="{ standalone: true }"
                  (onSelect)="saveOnboardingItem(item)"
                  [showIcon]="true"
                  styleClass="w-full"
                ></p-datePicker>
                <textarea
                  pTextarea
                  rows="2"
                  [(ngModel)]="item.notes"
                  [ngModelOptions]="{ standalone: true }"
                  (blur)="saveOnboardingItem(item)"
                  placeholder="Notes"
                  class="w-full"
                ></textarea>
                <span class="checklist-status" *ngIf="isOnboardingSaving(item)">Saving...</span>
                <span class="checklist-status saved" *ngIf="isOnboardingSaved(item)">Saved</span>
                <button pButton type="button" class="btn-glass btn-sm" (click)="deleteOnboardingItem(item)">
                  Remove
                </button>
              </div>
            </div>
            <ng-template #emptyOnboardingMilestones>
              <p class="empty-state">No onboarding milestones yet.</p>
            </ng-template>
          </section>
          </ng-container>
          <ng-template #onboardingLoading>
            <section class="form-card opportunity-accordion-card section-loading-card">
              <p class="helper-text">{{ isSectionLoading('onboarding') ? 'Loading onboarding checklist…' : 'Open section to load onboarding.' }}</p>
            </section>
          </ng-template>
              </p-accordion-content>
            </p-accordion-panel>

            <p-accordion-panel value="review-thread" *ngIf="isSectionVisible('review-thread')" [disabled]="isSectionLocked('review-thread')" [attr.data-deal-section]="'review-thread'">
              <p-accordion-header>
                <div class="opportunity-accordion-header">
                  <span class="opportunity-accordion-title">
                    <i class="pi pi-comments"></i>
                    Deal Review Thread
                  </span>
                  <span class="opportunity-accordion-header-meta">
                    <span
                      class="opportunity-accordion-badge"
                      [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + reviewThreadHeaderTone()"
                    >
                      {{ reviewThreadHeaderBadge() }}
                    </span>
                    <span
                      class="opportunity-accordion-badge"
                      [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + sectionStatusTone('review-thread')"
                    >
                      {{ sectionStatusLabel('review-thread') }}
                    </span>
                  </span>
                </div>
              </p-accordion-header>
              <p-accordion-content>
          <ng-container *ngIf="isSectionLoaded('review-thread'); else reviewLoading">
          <section class="form-card review-thread-card opportunity-accordion-card" *ngIf="isEditMode()">

            <div class="review-thread-controls" *ngIf="isManager(); else repAckBlock">
              <div class="form-grid">
                <div class="field">
                  <label for="reviewOutcome">Review outcome</label>
                  <p-select
                    inputId="reviewOutcome"
                    appendTo="body"
                    [options]="reviewOutcomeOptions"
                    optionLabel="label"
                    optionValue="value"
                    [(ngModel)]="reviewOutcome"
                    name="reviewOutcome"
                    styleClass="w-full"
                  ></p-select>
                </div>
                <div class="field" *ngIf="reviewOutcome !== 'Approved'">
                  <label for="reviewDue">Acknowledgment due</label>
                  <input
                    id="reviewDue"
                    type="datetime-local"
                    class="review-input"
                    [(ngModel)]="reviewAckDueLocal"
                    name="reviewAckDueLocal"
                  />
                </div>
                <div class="field full">
                  <label for="reviewComment">Manager comment</label>
                  <textarea
                    id="reviewComment"
                    pTextarea
                    rows="3"
                    class="w-full"
                    [(ngModel)]="reviewComment"
                    name="reviewComment"
                    placeholder="Explain what needs to change, or confirm approval."
                  ></textarea>
                </div>
              </div>
              <div class="review-actions">
                <button
                  pButton
                  type="button"
                  class="btn-gradient"
                  (click)="submitReviewOutcome()"
                  [disabled]="reviewSubmitting"
                >
                  {{ reviewSubmitting ? 'Saving...' : 'Save review outcome' }}
                </button>
              </div>
            </div>

            <ng-template #repAckBlock>
              <div class="review-thread-controls review-thread-controls--rep">
                <p class="helper-text" *ngIf="hasPendingAcknowledgment(); else noAckNeeded">
                  A manager has requested acknowledgment on this deal review.
                </p>
                <ng-template #noAckNeeded>
                  <p class="helper-text">No manager acknowledgment is required right now.</p>
                </ng-template>
                <div class="review-actions" *ngIf="hasPendingAcknowledgment()">
                  <button
                    pButton
                    type="button"
                    class="btn-gradient"
                    (click)="acknowledgeReview()"
                    [disabled]="ackSubmitting"
                  >
                    {{ ackSubmitting ? 'Acknowledging...' : 'Acknowledge review' }}
                  </button>
                </div>
              </div>
            </ng-template>

            <div class="review-thread-list" *ngIf="reviewThread().length; else emptyReviewThread">
              <div class="review-thread-item" *ngFor="let item of reviewThread()">
                <div class="review-thread-item__header">
                  <span class="review-badge" [ngClass]="item.kind === 'Acknowledgment' ? 'ack' : 'review'">
                    {{ item.kind }}
                  </span>
                  <strong class="review-outcome">{{ item.outcome }}</strong>
                  <span class="review-meta">
                    {{ item.ownerName }} · {{ item.createdAtUtc | date: 'MMM d, y, h:mm a' }}
                  </span>
                </div>
                <div class="review-thread-item__comment" *ngIf="item.comment">
                  {{ item.comment }}
                </div>
                <div class="review-thread-item__dates" *ngIf="item.dueDateUtc || item.completedDateUtc">
                  <span *ngIf="item.dueDateUtc">
                    Due: {{ item.dueDateUtc | date: 'MMM d, y, h:mm a' }}
                  </span>
                  <span *ngIf="item.completedDateUtc">
                    Completed: {{ item.completedDateUtc | date: 'MMM d, y, h:mm a' }}
                  </span>
                </div>
              </div>
            </div>
            <ng-template #emptyReviewThread>
              <p class="helper-text">No manager review comments yet.</p>
            </ng-template>
          </section>
          </ng-container>
          <ng-template #reviewLoading>
            <section class="form-card opportunity-accordion-card section-loading-card">
              <p class="helper-text">{{ isSectionLoading('review-thread') ? 'Loading review history…' : 'Open section to load review history.' }}</p>
            </section>
          </ng-template>
              </p-accordion-content>
            </p-accordion-panel>
            </p-accordion>
          </fieldset>

          <section class="form-card opportunity-accordion-card decision-review-panel" *ngIf="decisionReviewMode()">
            <h2 class="section-title">Review Action</h2>
            <p class="section-subtitle">Decision summary and reviewer comment for this pending case.</p>
            <div class="decision-summary" *ngIf="decisionReviewSummary() as summary">
              <div class="decision-summary-grid">
                <div class="decision-summary-item">
                  <span class="decision-summary-label">Purpose</span>
                  <span class="decision-summary-value">{{ summary.purpose }}</span>
                </div>
                <div class="decision-summary-item">
                  <span class="decision-summary-label">Status</span>
                  <span class="decision-summary-value">{{ summary.status }}</span>
                </div>
                <div class="decision-summary-item">
                  <span class="decision-summary-label">Amount</span>
                  <span class="decision-summary-value">{{ summary.amount | number:'1.0-2' }} {{ summary.currency }}</span>
                </div>
                <div class="decision-summary-item">
                  <span class="decision-summary-label">Requested by</span>
                  <span class="decision-summary-value">{{ summary.requestedByName || 'Unknown' }}</span>
                </div>
                <div class="decision-summary-item">
                  <span class="decision-summary-label">Requested on</span>
                  <span class="decision-summary-value">{{ summary.requestedOn | date:'MMM d, y, h:mm a' }}</span>
                </div>
                <div class="decision-summary-item" *ngIf="summary.approverRole">
                  <span class="decision-summary-label">Approver role</span>
                  <span class="decision-summary-value">{{ summary.approverRole }}</span>
                </div>
              </div>
            </div>
            <div class="form-grid">
              <div class="field full">
                <label for="decisionReviewComment">Comment for reviewer / requester</label>
                <textarea
                  id="decisionReviewComment"
                  pTextarea
                  rows="3"
                  class="w-full"
                  [(ngModel)]="decisionReviewComment"
                  name="decisionReviewComment"
                  placeholder="Explain decision rationale or required changes"
                ></textarea>
              </div>
            </div>
            <div class="decision-action-row">
              <p-select
                appendTo="body"
                [options]="decisionActionOptions"
                optionLabel="label"
                optionValue="value"
                name="decisionAction"
                [(ngModel)]="decisionAction"
                placeholder="Select action"
                styleClass="w-full"
              ></p-select>
              <button
                pButton
                type="button"
                class="crm-button--primary"
                [disabled]="decisionActionSubmitting() || !decisionAction"
                (click)="submitDecisionAction()"
              >
                {{ decisionActionSubmitting() ? 'Submitting...' : 'Submit Action' }}
              </button>
            </div>
          </section>

          <section class="form-card opportunity-accordion-card approval-history-section" *ngIf="decisionReviewMode()">
            <div class="approval-history-header">
              <h2 class="section-title">Approval History</h2>
              <span class="opportunity-accordion-badge">{{ decisionHistory().length }} entries</span>
            </div>

            <div class="approval-history-list" *ngIf="decisionHistory().length; else emptyDecisionHistory">
              <article class="approval-history-item" *ngFor="let item of decisionHistory()">
                <div class="approval-history-item__header">
                  <span
                    class="opportunity-accordion-badge"
                    [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + decisionHistoryTone(item)"
                  >
                    {{ item.action }}
                  </span>
                  <span
                    class="opportunity-accordion-badge"
                    [class]="'opportunity-accordion-badge opportunity-accordion-badge--' + decisionStatusTone(item.status)"
                  >
                    {{ item.status }}
                  </span>
                  <span class="approval-history-meta">
                    {{ item.actorName || 'System' }} · {{ item.actionAtUtc | date: 'MMM d, y, h:mm a' }}
                  </span>
                </div>
                <div class="approval-history-item__details">
                  <span>Priority: {{ item.priority || 'normal' }}</span>
                  <span>Risk: {{ item.riskLevel || 'low' }}</span>
                  <span *ngIf="item.isEscalated">Escalated</span>
                </div>
                <p class="approval-history-notes" *ngIf="item.notes">{{ item.notes }}</p>
                <p class="approval-history-policy" *ngIf="item.policyReason">{{ item.policyReason }}</p>
              </article>
            </div>
            <ng-template #emptyDecisionHistory>
              <p class="helper-text">No approval history yet for this decision.</p>
            </ng-template>
          </section>

          <div class="form-actions">
            <button
              type="button"
              pButton
              label="Cancel"
              class="crm-button--ghost"
              (click)="router.navigate(['/app/opportunities'])"
            ></button>
            <button
              pButton
              type="submit"
              [label]="isEditMode() ? 'Update deal' : 'Save deal'"
              class="crm-button--primary"
              [disabled]="!form.name || saving() || decisionReviewMode() || requesterApprovalLocked()"
            ></button>
          </div>
        </form>
          </div>
        </div>
      </div>
    </section>
  
