
    <div class="lead-form-page">
      <app-breadcrumbs></app-breadcrumbs>
      <header class="page-header">
        <div class="header-content">
          <div class="header-top">
            <button pButton type="button" class="back-link p-button-text" routerLink="/app/leads">
              <i class="pi pi-arrow-left"></i>
              <span>Back to leads</span>
            </button>
            <button
              pButton
              type="button"
              class="crm-button crm-button--primary"
              icon="pi pi-calendar-plus"
              label="Log activity"
              *ngIf="isEditMode()"
              (click)="logActivity()"
            ></button>
          </div>
          <div class="header-title">
            <h1>
              <span class="title-gradient">{{ isEditMode() ? 'Edit' : 'Create New' }}</span>
              <span class="title-light">Lead</span>
            </h1>
            <p>{{ isEditMode() ? 'Update lead details and status' : 'Add a new lead to your pipeline' }}</p>
          </div>
        </div>
      </header>

      <section class="related-summary" *ngIf="isEditMode()">
        <div class="related-summary-label">Converted to</div>
        <div class="related-summary-links" *ngIf="hasLinkedRecords(); else noLinkedSummary">
          <a *ngIf="linkedAccountLink() as link" [routerLink]="link" class="related-summary-link">
            <i class="pi pi-building"></i>
            Account
          </a>
          <a *ngIf="linkedContactLink() as link" [routerLink]="link" class="related-summary-link">
            <i class="pi pi-user"></i>
            Contact
          </a>
          <a *ngIf="linkedOpportunityLink() as link" [routerLink]="link" class="related-summary-link">
            <i class="pi pi-briefcase"></i>
            Opportunity
          </a>
        </div>
        <ng-template #noLinkedSummary>
          <span class="related-summary-empty">No linked records yet.</span>
        </ng-template>
      </section>

      <main class="form-container">
        <div class="lead-sticky-bar" *ngIf="isEditMode()">
          <div class="lead-sticky-left">
            <h3>{{ leadDisplayName() }}</h3>
            <div class="lead-sticky-meta">
              <span class="status-chip" [attr.data-status]="form.status">{{ form.status }}</span>
              <span class="score-chip">Score {{ form.score ?? 0 }} / 100</span>
              <span class="confidence-chip">{{ qualificationConfidenceDisplayLabel() }}</span>
              <span class="score-source-chip" *ngIf="scoreSourceBadge()">{{ scoreSourceBadge() }}</span>
            </div>
          </div>
          <div class="lead-sticky-right">
            <div class="sla-strip sla-strip--sticky">
              <div class="sla-pill" [ngClass]="getSlaTone()">
                <i class="pi pi-stopwatch"></i>
                <span class="sla-label">{{ getSlaStatusLabel() }}</span>
                <span class="sla-time">
                  {{ firstTouchDueAtUtc() ? (firstTouchDueAtUtc() | date:'medium') : 'â€”' }}
                </span>
              </div>
              <div class="sla-meta" *ngIf="firstTouchedAtUtc()">
                First touched {{ firstTouchedAtUtc() | date:'medium' }}
              </div>
            </div>
            <button
              pButton
              type="button"
              class="crm-button crm-button--primary"
              icon="pi pi-bolt"
              label="Convert lead"
              [disabled]="!canConvertLead()"
              (click)="onConvertLead()"
            ></button>
          </div>
        </div>

        <div class="lead-tabs">
          <button
            type="button"
            class="lead-tab"
            data-tab="overview"
            [class.is-active]="activeTab() === 'overview'"
            [class.is-disabled]="isTabDisabled('overview')"
            [disabled]="isTabDisabled('overview')"
            (click)="setActiveTab('overview')"
          >
            Overview
          </button>
          <button
            type="button"
            class="lead-tab"
            data-tab="qualification"
            [class.is-active]="activeTab() === 'qualification'"
            [class.is-disabled]="isTabDisabled('qualification')"
            [disabled]="isTabDisabled('qualification')"
            (click)="setActiveTab('qualification')"
          >
            Qualification
            <span class="tab-badge" *ngIf="qualificationTabBadge()">{{ qualificationTabBadge() }}</span>
          </button>
          <button
            type="button"
            class="lead-tab"
            data-tab="activity"
            [class.is-active]="activeTab() === 'activity'"
            [class.is-disabled]="isTabDisabled('activity')"
            [disabled]="isTabDisabled('activity')"
            (click)="setActiveTab('activity')"
          >
            Activity &amp; Follow-Up
            <span class="tab-badge warn" *ngIf="activityTabBadge()">{{ activityTabBadge() }}</span>
          </button>
          <button
            type="button"
            class="lead-tab"
            data-tab="history"
            [class.is-active]="activeTab() === 'history'"
            [class.is-disabled]="isTabDisabled('history')"
            [disabled]="isTabDisabled('history')"
            (click)="setActiveTab('history')"
          >
            History
          </button>
        </div>

        <form class="lead-form" (ngSubmit)="onSave()">
          <section class="form-section form-section--overview" *ngIf="activeTab() === 'overview'">
            <div class="section-block">
              <h2 class="section-title">
                <i class="pi pi-user"></i>
                Lead basics
              </h2>
              <div class="form-grid qualification-grid">
                <div class="field">
                  <label>First name <span class="required">*</span></label>
                  <input pInputText name="firstName" [(ngModel)]="form.firstName" required placeholder="First name" class="w-full" />
                </div>
                <div class="field">
                  <label>Last name <span class="required">*</span></label>
                  <input pInputText name="lastName" [(ngModel)]="form.lastName" required placeholder="Last name" class="w-full" />
                </div>
                <div class="field">
                  <label>Company</label>
                  <input pInputText name="companyName" [(ngModel)]="form.companyName" placeholder="Company" class="w-full" />
                </div>
                <div class="field">
                  <label>Status</label>
                  <p-select
                    [options]="statusOptionsForView()"
                    optionLabel="label"
                    optionValue="value"
                    optionDisabled="disabled"
                    name="status"
                    [(ngModel)]="form.status"
                    placeholder="Select status"
                    appendTo="body"
                    styleClass="w-full"
                  >
                    <ng-template pTemplate="item" let-option>
                      <div class="status-option" [attr.data-status]="option.value">
                        <i class="pi" [ngClass]="option.icon"></i>
                        <span>{{ option.label }}</span>
                      </div>
                    </ng-template>
                    <ng-template pTemplate="value" let-option>
                      <div class="status-option" *ngIf="option" [attr.data-status]="option.value">
                        <i class="pi" [ngClass]="option.icon"></i>
                        <span>{{ option.label }}</span>
                      </div>
                      <span *ngIf="!option" class="status-placeholder">Select status</span>
                    </ng-template>
                  </p-select>
                  <p class="status-note" *ngIf="isEditMode() && form.status === 'Converted'">
                    This lead is already converted. Update the opportunity instead.
                  </p>
                </div>
                <div class="field">
                  <label>Assignment</label>
                  <p-select
                    [options]="assignmentOptions"
                    optionLabel="label"
                    optionValue="value"
                    name="assignmentStrategy"
                    [(ngModel)]="form.assignmentStrategy"
                    placeholder="Select assignment"
                    appendTo="body"
                    styleClass="w-full"
                    [disabled]="!canEditAssignment()"
                  >
                    <ng-template pTemplate="item" let-option>
                      <div class="option-row" [attr.data-testid]="'lead-assignment-option-' + option.value">
                        {{ option.label }}
                      </div>
                    </ng-template>
                  </p-select>
                </div>
                <div class="field" *ngIf="form.assignmentStrategy === 'Manual'">
                  <label>Owner</label>
                  <p-select
                    [options]="ownerOptions()"
                    optionLabel="label"
                    optionValue="value"
                    name="ownerId"
                    [(ngModel)]="form.ownerId"
                    placeholder="Select owner"
                    appendTo="body"
                    styleClass="w-full"
                    [readonly]="isOwnerReadOnly()"
                    [disabled]="isOwnerReadOnly()"
                  >
                    <ng-template pTemplate="item" let-option>
                      <div class="option-row" [attr.data-testid]="'lead-owner-option-' + option.value">
                        {{ option.label }}
                      </div>
                    </ng-template>
                  </p-select>
                </div>
              </div>
            </div>

            <div class="section-divider"></div>

            <div class="section-block">
              <h2 class="section-title">
                <i class="pi pi-phone"></i>
                Contact details
              </h2>
              <div class="form-grid">
                <div class="field">
                  <label>Email</label>
                  <input
                    pInputText
                    name="email"
                    [ngModel]="form.email"
                    (ngModelChange)="onEmailChange($event)"
                    type="email"
                    placeholder="name@company.com"
                    class="w-full"
                  />
                  <p class="field-error" *ngIf="emailError()">{{ emailError() }}</p>
                </div>
                <div class="field full">
                  <label>Phone</label>
                  <div class="phone-grid">
                    <p-select
                      [options]="phoneTypeOptions"
                      optionLabel="label"
                      optionValue="value"
                      name="phoneTypeId"
                      [(ngModel)]="form.phoneTypeId"
                      placeholder="Select type"
                      appendTo="body"
                      styleClass="phone-type-select w-full"
                    ></p-select>
                    <p-select
                      [options]="phoneCountryOptions"
                      optionLabel="label"
                      optionValue="value"
                      name="phoneCountry"
                      [(ngModel)]="phoneCountryIso"
                      (ngModelChange)="onPhoneCountryChange($event)"
                      placeholder="Select country"
                      [filter]="true"
                      filterBy="label"
                      appendTo="body"
                      styleClass="phone-country-select w-full"
                    >
                      <ng-template pTemplate="selectedItem" let-option>
                        <div class="phone-country-option" *ngIf="option">
                          <span>{{ option.flag }} {{ option.name }}</span>
                          <strong>{{ option.dialCode }}</strong>
                        </div>
                      </ng-template>
                      <ng-template pTemplate="item" let-option>
                        <div class="phone-country-option">
                          <span>{{ option.flag }} {{ option.name }}</span>
                          <strong>{{ option.dialCode }}</strong>
                        </div>
                      </ng-template>
                    </p-select>
                    <ng-container *ngIf="phoneCountryIso; else plainPhoneInput">
                      <p-inputMask
                        name="phoneNumber"
                        [mask]="phoneMask()"
                        [slotChar]="'_'"
                        [autoClear]="false"
                        [unmask]="false"
                        [ngModel]="phoneNationalNumber"
                        (ngModelChange)="onPhoneChange($event)"
                        [placeholder]="phonePlaceholder()"
                        styleClass="w-full"
                      ></p-inputMask>
                    </ng-container>
                    <ng-template #plainPhoneInput>
                      <input
                        pInputText
                        name="phoneNumberPlain"
                        [ngModel]="phoneNationalNumber"
                        (ngModelChange)="onPhoneChange($event)"
                        placeholder="Phone number"
                        class="w-full"
                      />
                    </ng-template>
                  </div>
                  <p class="field-error" *ngIf="phoneError()">{{ phoneError() }}</p>
                </div>
                <div class="field">
                  <label>Job title</label>
                  <input pInputText name="jobTitle" [(ngModel)]="form.jobTitle" placeholder="Role or title" class="w-full" />
                </div>
                <div class="field">
                  <label>Source</label>
                  <input pInputText name="source" [(ngModel)]="form.source" placeholder="Web, Referral, Event" class="w-full" />
                </div>
                <div class="field" *ngIf="routingReason()">
                  <label>Routing reason</label>
                  <input
                    pInputText
                    [ngModel]="routingReason()"
                    [ngModelOptions]="{ standalone: true }"
                    class="w-full"
                    [disabled]="true"
                  />
                </div>
              </div>
            </div>
          </section>

          <section class="form-section form-section--score" *ngIf="activeTab() === 'overview'">
            <h2 class="section-title">
              <i class="pi pi-chart-line"></i>
              Score
            </h2>
            <p-progressBar
              *ngIf="aiScoring()"
              styleClass="ai-score-progress ai-score-progress--top"
              mode="indeterminate"
            ></p-progressBar>
            <div class="form-grid">
              <div class="field score-field">
                <label>Score</label>
                <p-inputNumber
                  name="score"
                  [(ngModel)]="form.score"
                  [min]="0"
                  [max]="100"
                  placeholder="0-100"
                  class="w-full"
                  [disabled]="true"
                ></p-inputNumber>
                <div class="score-meta">
                  <p class="hint-text">
                    Primary prioritization score, calculated from lead signals and qualification factors.
                    Manual entry is disabled.
                    <span *ngIf="form.autoScore"> Preview: {{ computeAutoScore() }}.</span>
                  </p>
                  <p-tag *ngIf="aiScoreConfidenceLabel()" [value]="aiScoreConfidenceLabel()!" severity="info"></p-tag>
                  <p-tag *ngIf="scoreSourceBadge()" [value]="scoreSourceBadge()!" severity="secondary"></p-tag>
                </div>
                <div class="ai-score-row" *ngIf="isEditMode()">
                  <button
                    pButton
                    type="button"
                    label="Refresh score"
                    icon="pi pi-sync"
                    class="crm-button crm-button--primary ai-score-button"
                    (click)="onAiScore()"
                    [disabled]="aiScoring() || !canRefreshScore()"
                  ></button>
                  <div class="ai-score-inline" *ngIf="aiScoreNote() && !aiScoring()" [ngClass]="aiScoreClass()">
                    <i class="pi" [ngClass]="aiScoreIcon()"></i>
                    <span>{{ aiScoreNote() }}</span>
                  </div>
                </div>
              </div>
              <div class="field">
                <label>Territory</label>
                <input pInputText name="territory" [(ngModel)]="form.territory" placeholder="West, EMEA, APAC" class="w-full" />
              </div>
            </div>
          </section>

          <section class="form-section form-section--qualification" *ngIf="activeTab() === 'qualification'">
            <h2 class="section-title">
              <i class="pi pi-chart-line"></i>
              Qualification
            </h2>
            <div class="form-grid">
              <div class="field full-row">
                <p class="status-rule">{{ qualificationRuleMessage() }}</p>
                <p class="status-note">
                  A discovery meeting (completed or due) must be logged before setting status to Qualified.
                </p>
                <p class="status-error" *ngIf="qualificationInlineError()">{{ qualificationInlineError() }}</p>
                <p class="status-note" *ngIf="isEditMode() && form.status !== 'Converted'">
                  Convert via the "Convert lead" button after qualification.
                </p>
              </div>
              <div class="field full-row" *ngIf="isEditMode()">
                <p class="status-note" *ngIf="firstTouchDueAtUtc()">
                  First touch due: {{ firstTouchDueAtUtc() | date:'medium' }}
                </p>
                <p class="status-note" *ngIf="firstTouchedAtUtc()">
                  First touched: {{ firstTouchedAtUtc() | date:'medium' }}
                </p>
              </div>
              <div class="field full-row">
                <div class="qualification-header">
                  <div>
                    <h3>Qualification factors</h3>
                  </div>
                  <div class="qualification-legend">
                    <span class="legend-title">Confidence legend</span>
                    <div class="legend-chips">
                      <p-tag value="Unknown" severity="info"></p-tag>
                      <p-tag value="Assumed" severity="warn"></p-tag>
                      <p-tag value="Verified" severity="success"></p-tag>
                      <p-tag value="Invalid" severity="danger"></p-tag>
                    </div>
                  </div>
                </div>
                <div class="qualification-feedback" *ngIf="qualificationFeedback() as feedback">
                  <span class="feedback-title">Qualification status</span>
                  <div class="feedback-metrics">
                    <span class="feedback-item feedback-item--confidence">
                      <i class="pi pi-chart-line feedback-icon" aria-hidden="true"></i>
                      Confidence:
                      <p-tag
                        [value]="feedback.confidenceLabel"
                        [severity]="feedback.confidenceLabel === 'High' ? 'success' : feedback.confidenceLabel === 'Medium' ? 'info' : 'warn'"
                      ></p-tag>
                    </span>
                    <span class="feedback-item feedback-item--truth" *ngIf="truthCoverage() !== null">
                      <i class="pi pi-check-circle feedback-icon" aria-hidden="true"></i>
                      Evidence coverage:
                      <strong>{{ truthCoveragePercent() }}%</strong>
                    </span>
                    <span class="feedback-item feedback-item--assumptions" *ngIf="assumptionsOutstanding() !== null">
                      <i class="pi pi-exclamation-circle feedback-icon" aria-hidden="true"></i>
                      Assumptions outstanding:
                      <strong>{{ assumptionsOutstandingLabel() }}</strong>
                    </span>
                    <span class="feedback-item feedback-item--weakest" *ngIf="feedback.weakestSignal">
                      <i class="pi pi-bolt feedback-icon" aria-hidden="true"></i>
                      Weakest signal:
                      <strong>{{ feedback.weakestSignal }}</strong>
                      <span class="feedback-state">({{ feedback.weakestState }})</span>
                    </span>
                  </div>
                  <div class="feedback-suggestions" *ngIf="nextEvidenceSuggestions().length">
                    <span class="feedback-title">Suggested next evidence</span>
                    <ul class="feedback-suggestions-list">
                      <li *ngFor="let suggestion of nextEvidenceSuggestions()">{{ suggestion }}</li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="field">
                <label>Budget availability</label>
                <p-select
                  name="budgetAvailability"
                  [options]="budgetOptions"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="form.budgetAvailability"
                  (ngModelChange)="onQualificationFactorChange()"
                  placeholder="Unknown / not yet discussed"
                  class="w-full"
                >
                  <ng-template pTemplate="selectedItem" let-option>
                    <div class="select-option" *ngIf="option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-option>
                    <div class="select-option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>
              <div class="field">
                <label>Evidence source</label>
                <p-select
                  name="budgetEvidence"
                  [options]="evidenceOptions"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="form.budgetEvidence"
                  [disabled]="isEvidenceDisabled(form.budgetAvailability)"
                  placeholder="Select evidence"
                  class="w-full"
                >
                  <ng-template pTemplate="selectedItem" let-option>
                    <div class="select-option" *ngIf="option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-option>
                    <div class="select-option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>
              <div class="field">
                <label>Readiness to spend</label>
                <p-select
                  name="readinessToSpend"
                  [options]="readinessOptions"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="form.readinessToSpend"
                  (ngModelChange)="onQualificationFactorChange()"
                  placeholder="Unknown / not yet discussed"
                  class="w-full"
                >
                  <ng-template pTemplate="selectedItem" let-option>
                    <div class="select-option" *ngIf="option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-option>
                    <div class="select-option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>
              <div class="field">
                <label>Evidence source</label>
                <p-select
                  name="readinessEvidence"
                  [options]="evidenceOptions"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="form.readinessEvidence"
                  [disabled]="isEvidenceDisabled(form.readinessToSpend)"
                  placeholder="Select evidence"
                  class="w-full"
                >
                  <ng-template pTemplate="selectedItem" let-option>
                    <div class="select-option" *ngIf="option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-option>
                    <div class="select-option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>
              <div class="field">
                <label>Buying timeline</label>
                <p-select
                  name="buyingTimeline"
                  [options]="timelineOptions"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="form.buyingTimeline"
                  (ngModelChange)="onQualificationFactorChange()"
                  placeholder="Unknown / not yet discussed"
                  class="w-full"
                >
                  <ng-template pTemplate="selectedItem" let-option>
                    <div class="select-option" *ngIf="option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-option>
                    <div class="select-option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>
              <div class="field">
                <label>Evidence source</label>
                <p-select
                  name="timelineEvidence"
                  [options]="evidenceOptions"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="form.timelineEvidence"
                  [disabled]="isEvidenceDisabled(form.buyingTimeline)"
                  placeholder="Select evidence"
                  class="w-full"
                >
                  <ng-template pTemplate="selectedItem" let-option>
                    <div class="select-option" *ngIf="option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-option>
                    <div class="select-option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>
              <div class="field">
                <label>Problem severity</label>
                <p-select
                  name="problemSeverity"
                  [options]="problemOptions"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="form.problemSeverity"
                  (ngModelChange)="onQualificationFactorChange()"
                  placeholder="Unknown / not yet discussed"
                  class="w-full"
                >
                  <ng-template pTemplate="selectedItem" let-option>
                    <div class="select-option" *ngIf="option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-option>
                    <div class="select-option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>
              <div class="field">
                <label>Evidence source</label>
                <p-select
                  name="problemEvidence"
                  [options]="evidenceOptions"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="form.problemEvidence"
                  [disabled]="isEvidenceDisabled(form.problemSeverity)"
                  placeholder="Select evidence"
                  class="w-full"
                >
                  <ng-template pTemplate="selectedItem" let-option>
                    <div class="select-option" *ngIf="option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-option>
                    <div class="select-option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>
              <div class="field">
                <label>Economic buyer</label>
                <p-select
                  name="economicBuyer"
                  [options]="economicBuyerOptions"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="form.economicBuyer"
                  (ngModelChange)="onQualificationFactorChange()"
                  placeholder="Unknown / not yet discussed"
                  class="w-full"
                >
                  <ng-template pTemplate="selectedItem" let-option>
                    <div class="select-option" *ngIf="option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-option>
                    <div class="select-option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>
              <div class="field">
                <label>Evidence source</label>
                <p-select
                  name="economicBuyerEvidence"
                  [options]="evidenceOptions"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="form.economicBuyerEvidence"
                  [disabled]="isEvidenceDisabled(form.economicBuyer)"
                  placeholder="Select evidence"
                  class="w-full"
                >
                  <ng-template pTemplate="selectedItem" let-option>
                    <div class="select-option" *ngIf="option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-option>
                    <div class="select-option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>
              <div class="field">
                <label>
                  ICP fit
                  <i
                    class="pi pi-info-circle info-icon"
                    pTooltip="How closely this lead matches our ideal customer profile (industry, size, use case, delivery fit)."
                    tooltipPosition="top"
                  ></i>
                </label>
                <p-select
                  name="icpFit"
                  [options]="icpFitOptions"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="form.icpFit"
                  (ngModelChange)="onQualificationFactorChange()"
                  placeholder="Unknown / not yet discussed"
                  class="w-full"
                >
                  <ng-template pTemplate="selectedItem" let-option>
                    <div class="select-option" *ngIf="option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-option>
                    <div class="select-option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>
              <div class="field">
                <label>Evidence source</label>
                <p-select
                  name="icpFitEvidence"
                  [options]="evidenceOptions"
                  optionLabel="label"
                  optionValue="value"
                  [(ngModel)]="form.icpFitEvidence"
                  [disabled]="isEvidenceDisabled(form.icpFit)"
                  placeholder="Select evidence"
                  class="w-full"
                >
                  <ng-template pTemplate="selectedItem" let-option>
                    <div class="select-option" *ngIf="option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-option>
                    <div class="select-option">
                      <i [ngClass]="['option-icon', 'tone-' + option.tone, option.icon]"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>
              <div class="field full-row" *ngIf="scoreBreakdown().length">
                <div class="score-breakdown">
                  <div class="score-breakdown__header">
                    <div class="score-breakdown__title">
                      <span class="eyebrow">Scoring model</span>
                      <strong>Scoring Details</strong>
                    </div>
                    <span class="confidence-pill">{{ qualificationConfidenceDisplayLabel() }}</span>
                  </div>
                  <div class="confidence-gauge-panel">
                    <div class="confidence-gauge">
                      <div class="confidence-gauge__label">Qualification confidence</div>
                      <p-knob
                        [ngModel]="qualificationConfidencePercent()"
                        [ngModelOptions]="{ standalone: true }"
                        [readonly]="true"
                        [size]="86"
                        [strokeWidth]="10"
                        [valueColor]="scoreKnobValueColor()"
                        rangeColor="rgba(var(--apple-gray-4), 0.35)"
                        textColor="rgba(var(--apple-secondary), 0.9)"
                        styleClass="confidence-gauge__knob"
                      ></p-knob>
                    </div>
                    <p class="hint-text compact" *ngIf="qualificationConfidenceHint()">{{ qualificationConfidenceHint() }}</p>
                  </div>
                  <div class="score-breakdown__grid">
                    <div class="score-breakdown__item" [ngClass]="scoreItemClass(item)" *ngFor="let item of scoreBreakdown()">
                      <div class="score-breakdown__item-head">
                        <span class="factor-name">{{ item.factor }}</span>
                        <strong class="factor-score">{{ item.score }} / {{ item.maxScore }}</strong>
                      </div>
                      <div class="factor-rail">
                        <span class="factor-rail__fill" [style.width.%]="item.maxScore ? (item.score / item.maxScore) * 100 : 0"></span>
                      </div>
                    </div>
                  </div>
                  <div class="risk-flags" *ngIf="riskFlags().length">
                    <span class="risk-label">Top risks</span>
                    <span class="risk-flag" *ngFor="let flag of riskFlags()">{{ flag }}</span>
                  </div>
                </div>
              </div>
              <div class="field full-row">
                <label>Context &amp; supporting notes <span class="required" *ngIf="form.status === 'Qualified'">*</span></label>
                <p class="hint-text compact">Context only. Does not change Score.</p>
                <textarea
                  pTextarea
                  name="qualifiedNotes"
                  rows="5"
                  placeholder="Key context, objections, and next steps (non-scoring)"
                  class="w-full"
                  [(ngModel)]="form.qualifiedNotes"
                ></textarea>
              </div>
              <div class="field" *ngIf="form.status === 'Nurture'">
                <label>Nurture follow-up date <span class="required">*</span></label>
                <p-datepicker
                  name="nurtureFollowUpAtUtc"
                  [(ngModel)]="form.nurtureFollowUpAtUtc"
                  appendTo="body"
                  styleClass="w-full"
                ></p-datepicker>
              </div>
              <div class="field full-row" *ngIf="form.status === 'Disqualified'">
                <label>Disqualified reason <span class="required">*</span></label>
                <textarea
                  pTextarea
                  name="disqualifiedReason"
                  rows="4"
                  placeholder="Reason for disqualification"
                  class="w-full"
                  [(ngModel)]="form.disqualifiedReason"
                ></textarea>
              </div>
              <div class="field full-row" *ngIf="form.status === 'Lost'">
                <label>Loss reason <span class="required">*</span></label>
                <textarea
                  pTextarea
                  name="lossReason"
                  rows="3"
                  placeholder="Primary reason the lead was lost"
                  class="w-full"
                  [(ngModel)]="form.lossReason"
                ></textarea>
              </div>
              <div class="field" *ngIf="form.status === 'Lost'">
                <label>Competitor <span class="required">*</span></label>
                <input
                  pInputText
                  name="lossCompetitor"
                  placeholder="Competitor name"
                  class="w-full"
                  [(ngModel)]="form.lossCompetitor"
                />
              </div>
              <div class="field full-row" *ngIf="form.status === 'Lost'">
                <label>Loss notes <span class="required">*</span></label>
                <textarea
                  pTextarea
                  name="lossNotes"
                  rows="4"
                  placeholder="Context and details about the loss"
                  class="w-full"
                  [(ngModel)]="form.lossNotes"
                ></textarea>
              </div>
            </div>
          </section>

          <section class="form-section cadence-section" *ngIf="isEditMode() && activeTab() === 'activity'">
            <h2 class="section-title">
              <i class="pi pi-bullseye"></i>
              Follow-Up Plan
            </h2>
            <p class="hint-text compact" *ngIf="followUpHint()">{{ followUpHint() }}</p>
            <div class="cadence-grid">
              <div class="field">
                <label>Channel</label>
                <p-select
                  [options]="cadenceChannelOptions"
                  optionLabel="label"
                  optionValue="value"
                  name="cadenceChannel"
                  [(ngModel)]="cadenceChannel"
                  placeholder="Select channel"
                  appendTo="body"
                  styleClass="w-full cadence-input"
                ></p-select>
              </div>
              <div class="field">
                <label>Next step due date</label>
                <p-datepicker
                  name="cadenceNextStepLocal"
                  [(ngModel)]="cadenceNextStepLocal"
                  [showTime]="true"
                  hourFormat="12"
                  appendTo="body"
                  styleClass="w-full cadence-input"
                  [disabled]="cadenceSubmitting()"
                ></p-datepicker>
              </div>
              <div class="field full-row">
                <label>Outcome</label>
                <input
                  pInputText
                  class="cadence-input"
                  name="cadenceOutcome"
                  [(ngModel)]="cadenceOutcome"
                  placeholder="Connected, voicemail, no response, meeting booked..."
                />
              </div>
            </div>
            <div class="cadence-actions">
              <button
                pButton
                type="button"
                label="Log cadence touch"
                icon="pi pi-check"
                class="crm-button crm-button--primary"
                (click)="logCadenceTouch()"
                [disabled]="cadenceSubmitting() || !cadenceOutcome.trim()"
              ></button>
            </div>
            <div class="cadence-history" *ngIf="cadenceTouches().length; else noCadenceTouches">
              <div class="cadence-item" *ngFor="let touch of cadenceTouches()">
                <div class="cadence-item__meta">
                  <strong>{{ touch.channel }}</strong>
                  <span>{{ touch.completedAtUtc | date:'medium' }}</span>
                </div>
                <div class="cadence-item__outcome">{{ touch.outcome }}</div>
                <div class="cadence-item__next" *ngIf="touch.nextStepDueAtUtc">
                  Next step due {{ touch.nextStepDueAtUtc | date:'mediumDate' }}
                </div>
              </div>
            </div>
            <ng-template #noCadenceTouches>
              <div class="history-empty">No cadence touches logged yet.</div>
            </ng-template>
          </section>

          <section class="form-section" *ngIf="isEditMode() && activeTab() === 'history'">
            <h2 class="section-title">
              <i class="pi pi-history"></i>
              Status history
            </h2>
            <div class="history-list" *ngIf="statusHistory().length; else noHistory">
              <div class="history-item" *ngFor="let entry of statusHistory()">
                <div class="history-header">
                  <p-tag [value]="entry.status" [severity]="statusSeverity(entry.status)"></p-tag>
                  <span class="history-time">{{ entry.changedAtUtc | date:'medium' }}</span>
                </div>
                <div class="history-meta">
                  <span>Changed by {{ entry.changedBy || 'system' }}</span>
                </div>
                <div class="history-notes" *ngIf="entry.notes">{{ entry.notes }}</div>
              </div>
            </div>
            <ng-template #noHistory>
              <div class="history-empty">No status changes recorded yet.</div>
            </ng-template>
          </section>

          <footer class="form-actions">
            <button type="button" pButton label="Cancel" class="crm-button crm-button--ghost" (click)="router.navigate(['/app/leads'])"></button>
            <button
              type="submit"
              pButton
              [label]="isEditMode() ? 'Update lead' : 'Create lead'"
              class="crm-button crm-button--primary"
              [disabled]="!form.firstName || !form.lastName || saving()"
            ></button>
          </footer>
        </form>
      </main>
    </div>
  
