<app-breadcrumbs></app-breadcrumbs>
<div class="convert-page">
  <header class="page-header">
    <div class="header-content">
      <button pButton type="button" class="back-link p-button-text" routerLink="/app/leads">
        <i class="pi pi-arrow-left"></i>
        <span>Back to leads</span>
      </button>
      <div class="header-title">
        <h1>Convert lead</h1>
        <p *ngIf="lead() as leadData">Turn {{ leadData.name }} into an account, contact, and opportunity.</p>
      </div>
    </div>
  </header>

  <main class="convert-container">
    <div class="glass-card" *ngIf="lead() as leadData">
      <div class="lead-summary">
        <div class="lead-avatar">{{ leadData.name.charAt(0) }}</div>
        <div class="lead-meta">
          <span class="lead-name">{{ leadData.name }}</span>
          <span class="lead-company">{{ leadData.company }}</span>
          <span class="lead-contact" *ngIf="leadData.email">{{ leadData.email }}</span>
        </div>
        <span class="status-pill" [attr.data-status]="leadData.status">{{ leadData.status }}</span>
      </div>

      <form class="convert-form" (ngSubmit)="onConvert()">
        <section class="form-section">
          <h2 class="section-title">
            <i class="pi pi-building"></i>
            Account
          </h2>
          <div class="form-grid">
            <label class="checkbox-field">
              <p-checkbox [(ngModel)]="form().createAccount" name="createAccount" binary="true" (ngModelChange)="onFormChange()"></p-checkbox>
              <span>Create new account</span>
            </label>
            <div class="field" *ngIf="form().createAccount">
              <label>Account name</label>
              <input pInputText name="accountName" [(ngModel)]="form().accountName" class="w-full" />
            </div>
          </div>
        </section>

        <section class="form-section">
          <h2 class="section-title">
            <i class="pi pi-id-card"></i>
            Contact
          </h2>
          <div class="form-grid">
            <label class="checkbox-field">
              <p-checkbox [(ngModel)]="form().createContact" name="createContact" binary="true" (ngModelChange)="onFormChange()"></p-checkbox>
              <span>Create contact from lead details</span>
            </label>
            <div class="field">
              <label>Contact</label>
              <div class="value-pill">
                {{ leadData.name }} â€¢ {{ leadData.email || 'No email' }}
              </div>
            </div>
          </div>
        </section>

        <section class="form-section">
          <h2 class="section-title">
            <i class="pi pi-briefcase"></i>
            Opportunity
          </h2>
          <div class="form-grid">
            <label class="checkbox-field">
              <p-checkbox [(ngModel)]="form().createOpportunity" name="createOpportunity" binary="true" (ngModelChange)="onFormChange()"></p-checkbox>
              <span>Create opportunity</span>
            </label>
            <div class="field" *ngIf="form().createOpportunity">
              <label>Opportunity name</label>
              <input pInputText name="opportunityName" [(ngModel)]="form().opportunityName" class="w-full" />
            </div>
            <div class="field" *ngIf="form().createOpportunity">
              <label>Amount</label>
              <p-inputNumber name="amount" [(ngModel)]="form().amount" [min]="0" class="w-full"></p-inputNumber>
            </div>
            <div class="field" *ngIf="form().createOpportunity">
              <label>Expected close date</label>
              <p-datePicker name="expectedCloseDate" [(ngModel)]="form().expectedCloseDate" [showIcon]="true" styleClass="w-full"></p-datePicker>
            </div>
          </div>
          <p class="hint" *ngIf="form().createOpportunity && !form().createAccount">
            Create an account to attach the opportunity.
          </p>
        </section>

        <section class="form-section qualification-section" *ngIf="lead() as leadData">
          <h2 class="section-title">
            <i class="pi pi-sliders-h"></i>
            Qualification guardrails
          </h2>
          <div class="qualification-summary">
            <div>
              <span class="label">Score</span>
              <strong>{{ leadData.score }}/100</strong>
            </div>
            <div>
              <span class="label">Band</span>
              <span class="pill" [attr.data-band]="qualificationDecision().band">{{ qualificationDecision().band }}</span>
            </div>
            <div>
              <span class="label">Threshold</span>
              <strong>{{ qualificationDecision().adjustedThreshold }}</strong>
            </div>
            <div class="summary-message">
              {{ qualificationDecision().message }}
            </div>
          </div>

          <div class="form-grid form-grid--2col">
            <div class="field">
              <label>Deal type</label>
              <p-select
                appendTo="body"
                [options]="dealTypeOptions"
                optionLabel="label"
                optionValue="value"
                [(ngModel)]="form().dealType"
                (ngModelChange)="onFormChange()"
                name="dealType"
                styleClass="w-full"
              ></p-select>
            </div>
            <div class="field">
              <label>Segment</label>
              <p-select
                appendTo="body"
                [options]="segmentOptions"
                optionLabel="label"
                optionValue="value"
                [(ngModel)]="form().segment"
                (ngModelChange)="onFormChange()"
                name="segment"
                styleClass="w-full"
              ></p-select>
            </div>
            <div class="field">
              <label>Stage</label>
              <p-select
                appendTo="body"
                [options]="stageOptions"
                optionLabel="label"
                optionValue="value"
                [(ngModel)]="form().stage"
                (ngModelChange)="onFormChange()"
                name="stage"
                styleClass="w-full"
              ></p-select>
            </div>
            <div class="field">
              <label>Velocity</label>
              <p-select
                appendTo="body"
                [options]="velocityOptions"
                optionLabel="label"
                optionValue="value"
                [(ngModel)]="form().velocity"
                (ngModelChange)="onFormChange()"
                name="velocity"
                styleClass="w-full"
              ></p-select>
            </div>
          </div>

          <div class="form-grid form-grid--2col">
            <label class="checkbox-field">
              <p-checkbox [(ngModel)]="form().isCompetitive" name="isCompetitive" binary="true" (ngModelChange)="onFormChange()"></p-checkbox>
              <span>Competitive deal</span>
            </label>
            <label class="checkbox-field">
              <p-checkbox [(ngModel)]="form().hasExecutiveChampion" name="hasExecutiveChampion" binary="true" (ngModelChange)="onFormChange()"></p-checkbox>
              <span>Executive champion</span>
            </label>
            <label class="checkbox-field">
              <p-checkbox [(ngModel)]="form().isStrategic" name="isStrategic" binary="true" (ngModelChange)="onFormChange()"></p-checkbox>
              <span>Strategic account</span>
            </label>
          </div>

          <div class="form-grid form-grid--2col" *ngIf="qualificationDecision().requiresManagerApproval || qualificationDecision().requiresOverrideReason">
            <label class="checkbox-field" *ngIf="qualificationDecision().requiresManagerApproval">
              <p-checkbox [(ngModel)]="form().managerApproved" name="managerApproved" binary="true" (ngModelChange)="onFormChange()"></p-checkbox>
              <span>Manager approved</span>
            </label>
            <div class="field" *ngIf="qualificationDecision().requiresOverrideReason">
              <label>Override reason</label>
              <textarea
                pTextarea
                name="overrideReason"
                [(ngModel)]="form().overrideReason"
                (ngModelChange)="onFormChange()"
                rows="3"
                placeholder="Explain why you are converting below threshold"
              ></textarea>
            </div>
          </div>
        </section>

        <footer class="form-actions">
          <button type="button" pButton label="Cancel" class="crm-button crm-button--ghost" (click)="onCancel()"></button>
          <button type="submit" pButton label="Convert lead" class="crm-button crm-button--primary" [disabled]="saving() || !canConvert()"></button>
        </footer>
      </form>
    </div>
  </main>
</div>
