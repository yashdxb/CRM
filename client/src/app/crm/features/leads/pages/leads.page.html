<div class="page-background">
  <div class="animated-orb orb-1"></div>
  <div class="animated-orb orb-2"></div>
  <div class="animated-orb orb-3"></div>
  <div class="grid-pattern"></div>
</div>

<div class="page-container">
  <div class="page-content">
    <!-- PrimeNG Breadcrumb -->
    <app-breadcrumbs></app-breadcrumbs>

    <!-- Compact Header -->
    <header class="page-header">
      <div class="header-left">
        <h1 class="page-title">
          <i class="pi pi-users gradient-icon"></i>
          Leads
          <span class="title-count">{{ total() }}</span>
        </h1>
      </div>
      <div class="header-right">
        <div class="view-toggle">
          <button pButton type="button" class="toggle-btn" [class.active]="viewMode === 'table'" (click)="viewMode = 'table'" title="Table View">
            <i class="pi pi-list"></i>
          </button>
          <button pButton type="button" class="toggle-btn" [class.active]="viewMode === 'kanban'" (click)="viewMode = 'kanban'" title="Kanban View">
            <i class="pi pi-objects-column"></i>
          </button>
        </div>
        <button pButton type="button" class="btn-icon" (click)="load()" title="Refresh">
          <i class="pi pi-refresh"></i>
        </button>
        <button pButton type="button" class="btn-ghost" [disabled]="!canManage()" (click)="openImport()">
          <i class="pi pi-upload"></i>
          <span>Import</span>
        </button>
        <button pButton type="button" class="btn-primary" [disabled]="!canManage()" (click)="onCreate()">
          <i class="pi pi-plus"></i>
          <span>Add Lead</span>
        </button>
      </div>
    </header>

    <!-- KPI Strip -->
    <section class="kpi-strip">
      <div class="kpi-card">
        <div class="kpi-icon total">
          <i class="pi pi-inbox"></i>
        </div>
        <div class="kpi-data">
          <span class="kpi-value">{{ metrics().total }}</span>
          <span class="kpi-label">Total Leads</span>
        </div>
      </div>
      <div class="kpi-divider"></div>
      <div class="kpi-card clickable" [class.active]="statusFilter === 'New'" (click)="onStatusChange('New')">
        <div class="kpi-icon new">
          <i class="pi pi-star"></i>
        </div>
        <div class="kpi-data">
          <span class="kpi-value">{{ metrics().newLeads }}</span>
          <span class="kpi-label">New</span>
        </div>
        <span class="kpi-percentage" *ngIf="metrics().total">{{ ((metrics().newLeads / metrics().total) * 100) | number:'1.0-0' }}%</span>
      </div>
      <div class="kpi-card clickable" [class.active]="statusFilter === 'Qualified'" (click)="onStatusChange('Qualified')">
        <div class="kpi-icon qualified">
          <i class="pi pi-check"></i>
        </div>
        <div class="kpi-data">
          <span class="kpi-value">{{ metrics().qualified }}</span>
          <span class="kpi-label">Qualified</span>
        </div>
        <span class="kpi-percentage" *ngIf="metrics().total">{{ ((metrics().qualified / metrics().total) * 100) | number:'1.0-0' }}%</span>
      </div>
      <div class="kpi-card clickable" [class.active]="statusFilter === 'Converted'" (click)="onStatusChange('Converted')">
        <div class="kpi-icon converted">
          <i class="pi pi-verified"></i>
        </div>
        <div class="kpi-data">
          <span class="kpi-value">{{ metrics().converted }}</span>
          <span class="kpi-label">Won</span>
        </div>
        <span class="kpi-badge success">{{ conversionRate() }}% rate</span>
      </div>
      <div class="kpi-card clickable" [class.active]="statusFilter === 'Lost'" (click)="onStatusChange('Lost')">
        <div class="kpi-icon lost">
          <i class="pi pi-times"></i>
        </div>
        <div class="kpi-data">
          <span class="kpi-value">{{ metrics().lost }}</span>
          <span class="kpi-label">Lost</span>
        </div>
      </div>
      <div class="kpi-divider"></div>
      <div class="kpi-card">
        <div class="kpi-icon score">
          <i class="pi pi-chart-bar"></i>
        </div>
        <div class="kpi-data">
          <span class="kpi-value">{{ metrics().avgScore }}<small>%</small></span>
          <span class="kpi-label">Avg Score</span>
        </div>
      </div>
    </section>

    <!-- Action Bar -->
    <section class="action-bar glass-card">
      <div class="search-box">
        <i class="pi pi-search"></i>
        <input 
          pInputText
          type="text" 
          placeholder="Search leads..." 
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearch($event)"
        />
        <kbd *ngIf="!searchTerm">âŒ˜K</kbd>
        <button pButton type="button" class="clear-btn" *ngIf="searchTerm" (click)="searchTerm = ''; onSearch('')">
          <i class="pi pi-times"></i>
        </button>
      </div>
      
      <div class="quick-filters">
        <button pButton type="button" class="filter-chip" [class.active]="statusFilter === 'all'" (click)="onStatusChange('all')">
          All
        </button>
        <button pButton type="button" class="filter-chip" *ngFor="let opt of filteredStatusOptions" 
                [class.active]="statusFilter === opt.value"
                (click)="onStatusChange(opt.value)">
          <span class="chip-dot" [attr.data-status]="opt.value"></span>
          {{ opt.label }}
        </button>
      </div>

      <div class="action-right">
        <button pButton type="button" class="btn-ghost" *ngIf="statusFilter !== 'all'" (click)="onStatusChange('all')">
          <i class="pi pi-filter-slash"></i>
          Clear Filter
        </button>
      </div>
    </section>

    <!-- Kanban View -->
    <section class="kanban-board" *ngIf="viewMode === 'kanban'">
      <div class="kanban-column" *ngFor="let status of ['New', 'Contacted', 'Qualified', 'Converted', 'Lost']">
        <div class="column-header" [attr.data-status]="status">
          <span class="column-title">{{ status }}</span>
          <span class="column-count">{{ getLeadsByStatus(status).length }}</span>
        </div>
        <div class="column-body">
          <div class="lead-card" *ngFor="let lead of getLeadsByStatus(status)" (click)="canManage() ? onEdit(lead) : null">
            <div class="lead-card-header">
              <div class="lead-avatar" [attr.data-status]="lead.status">
                {{ lead.name.charAt(0) }}
              </div>
              <div class="lead-meta">
                <span class="lead-name">{{ lead.name }}</span>
                <span class="lead-company">{{ lead.company }}</span>
              </div>
              <div class="lead-score" [class.high]="lead.score >= 70" [class.medium]="lead.score >= 40 && lead.score < 70" [class.low]="lead.score < 40">
                {{ lead.score }}
              </div>
            </div>
            <div class="lead-card-body">
              <div class="lead-detail" *ngIf="lead.email">
                <i class="pi pi-envelope"></i>
                <span>{{ lead.email }}</span>
              </div>
              <div class="lead-detail" *ngIf="lead.phone">
                <i class="pi pi-phone"></i>
                <span>{{ lead.phone }}</span>
              </div>
              <div class="lead-epistemic" *ngIf="lead.truthCoverage !== undefined || lead.weakestSignal">
                <span class="epistemic-chip truth" *ngIf="lead.truthCoverage !== undefined">
                  Truth {{ (lead.truthCoverage * 100) | number:'1.0-0' }}%
                </span>
                <span class="epistemic-chip weakest" *ngIf="lead.weakestSignal">
                  Weakest: {{ lead.weakestSignal }}
                </span>
              </div>
            </div>
            <div class="lead-related" *ngIf="hasConvertedLinks(lead)" (click)="$event.stopPropagation()">
              <span class="lead-related-label">Converted to</span>
              <div class="lead-related-links">
                <a
                  *ngIf="leadAccountLink(lead)"
                  class="lead-related-link"
                  [routerLink]="leadAccountLink(lead)"
                >Account</a>
                <a
                  *ngIf="leadContactLink(lead)"
                  class="lead-related-link"
                  [routerLink]="leadContactLink(lead)"
                >Contact</a>
                <a
                  *ngIf="leadOpportunityLink(lead)"
                  class="lead-related-link"
                  [routerLink]="leadOpportunityLink(lead)"
                >Opportunity</a>
              </div>
            </div>
            <div class="lead-card-footer">
              <span class="lead-owner">
                <i class="pi pi-user"></i>
                {{ lead.owner }}
              </span>
              <div class="lead-actions">
                <button pButton type="button" class="mini-btn" [disabled]="!canManage()" (click)="$event.stopPropagation(); onEdit(lead)">
                  <i class="pi pi-pencil"></i>
                </button>
                <button pButton type="button" class="mini-btn info" [disabled]="!canManage()" (click)="$event.stopPropagation(); onLogActivity(lead)">
                  <i class="pi pi-calendar-plus"></i>
                </button>
                <button pButton type="button" class="mini-btn success" *ngIf="lead.status === 'Qualified'" [disabled]="!canManage()" (click)="$event.stopPropagation(); onConvert(lead)">
                  <i class="pi pi-bolt"></i>
                </button>
                <button pButton type="button" class="mini-btn danger" [disabled]="!canManage()" (click)="$event.stopPropagation(); onDelete(lead)">
                  <i class="pi pi-trash"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="column-empty" *ngIf="!getLeadsByStatus(status).length">
            <i class="pi pi-inbox"></i>
            <span>No {{ status.toLowerCase() }} leads</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Table View -->
    <section class="data-table-section glass-card" *ngIf="viewMode === 'table'">
      <ng-container *ngIf="!loading(); else loadingState">
        <ng-container *ngIf="leads().length; else emptyState">
          <div class="table-container">
            <p-table class="leads-table" [value]="leads()">
              <ng-template pTemplate="header">
                <tr>
                  <th class="th-checkbox">
                    <p-checkbox
                      [binary]="true"
                      [ngModel]="selectedIds().length && selectedIds().length === leads().length"
                      (onChange)="toggleSelectAll($event.checked)"
                    ></p-checkbox>
                  </th>
                  <th class="th-lead">Lead</th>
                  <th class="th-status">Status</th>
                  <th class="th-contact">Contact</th>
                  <th class="th-score">Score</th>
                  <th class="th-owner">Owner</th>
                  <th class="th-actions"></th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-lead let-i="rowIndex">
                <tr class="table-row" [class.highlight]="i === 0">
                  <td class="td-checkbox">
                    <p-checkbox
                      [binary]="true"
                      [ngModel]="isSelected(lead.id)"
                      (onChange)="toggleSelection(lead.id, $event.checked)"
                    ></p-checkbox>
                  </td>
                  <td class="td-lead">
                    <div class="lead-cell">
                      <div class="avatar" [attr.data-status]="lead.status">
                        {{ lead.name.charAt(0) }}
                      </div>
                      <div class="lead-info">
                        <span class="name">{{ lead.name }}</span>
                        <span class="company">{{ lead.company }}</span>
                        <div class="lead-epistemic" *ngIf="lead.truthCoverage !== undefined || lead.weakestSignal">
                          <span class="epistemic-chip truth" *ngIf="lead.truthCoverage !== undefined">
                            Truth {{ (lead.truthCoverage * 100) | number:'1.0-0' }}%
                          </span>
                          <span class="epistemic-chip weakest" *ngIf="lead.weakestSignal">
                            Weakest: {{ lead.weakestSignal }}
                          </span>
                        </div>
                        <div class="lead-sla" *ngIf="lead.firstTouchDueAtUtc || lead.firstTouchedAtUtc">
                          <span class="sla-chip" [ngClass]="getSlaTone(lead)">
                            <i class="pi pi-stopwatch"></i>
                            {{ getSlaStatusLabel(lead) }}
                          </span>
                        </div>
                        <div class="lead-related" *ngIf="hasConvertedLinks(lead)">
                          <span class="lead-related-label">Converted to</span>
                          <div class="lead-related-links">
                            <a
                              *ngIf="leadAccountLink(lead)"
                              class="lead-related-link"
                              [routerLink]="leadAccountLink(lead)"
                            >Account</a>
                            <a
                              *ngIf="leadContactLink(lead)"
                              class="lead-related-link"
                              [routerLink]="leadContactLink(lead)"
                            >Contact</a>
                            <a
                              *ngIf="leadOpportunityLink(lead)"
                              class="lead-related-link"
                              [routerLink]="leadOpportunityLink(lead)"
                            >Opportunity</a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="td-status">
                    <p-select appendTo="body"
                      [options]="filteredStatusOptions"
                      optionLabel="label"
                      optionValue="value"
                      [ngModel]="lead.status"
                      (ngModelChange)="onInlineStatusChange(lead, $event)"
                      styleClass="inline-select"
                    >
                      <ng-template pTemplate="item" let-option>
                        <div class="status-option" [attr.data-status]="option.value">
                          <i class="pi" [ngClass]="option.icon"></i>
                          <span>{{ option.label }}</span>
                        </div>
                      </ng-template>
                      <ng-template pTemplate="value" let-option>
                        <div class="status-option" *ngIf="option" [attr.data-status]="option.value">
                          <i class="pi" [ngClass]="option.icon"></i>
                          <span>{{ option.label }}</span>
                        </div>
                        <span *ngIf="!option" class="status-placeholder">Select status</span>
                      </ng-template>
                    </p-select>
                  </td>
                  <td class="td-contact">
                    <div class="contact-cell">
                      <a class="contact-link" *ngIf="lead.email" [href]="'mailto:' + lead.email">
                        <i class="pi pi-envelope"></i>
                        {{ lead.email }}
                      </a>
                      <span class="contact-secondary" *ngIf="lead.phone">{{ lead.phone }}</span>
                    </div>
                  </td>
                  <td class="td-score">
                    <div class="score-indicator">
                      <div class="score-bar">
                        <div class="score-fill" 
                             [class.high]="lead.score >= 70" 
                             [class.medium]="lead.score >= 40 && lead.score < 70" 
                             [class.low]="lead.score < 40"
                             [style.width.%]="lead.score"></div>
                      </div>
                      <span class="score-value">{{ lead.score }}</span>
                    </div>
                  </td>
                  <td class="td-owner">
                    <p-select appendTo="body"
                      [options]="ownerOptionsForAssign()"
                      optionLabel="label"
                      optionValue="value"
                      [ngModel]="lead.ownerId"
                      (ngModelChange)="onInlineOwnerChange(lead, $event)"
                      placeholder="Owner"
                      styleClass="inline-select"
                      [disabled]="!canEditOwnerAssignment()"
                    ></p-select>
                  </td>
                  <td class="td-actions">
                    <div class="row-actions">
                      <button pButton type="button" class="action-btn" icon="pi pi-pencil" [disabled]="!canManage()" (click)="onEdit(lead)" title="Edit"></button>
                      <button pButton type="button" class="action-btn info" icon="pi pi-calendar-plus" [disabled]="!canManage()" (click)="onLogActivity(lead)" title="Log activity"></button>
                      <button pButton type="button" class="action-btn success" icon="pi pi-bolt" *ngIf="lead.status === 'Qualified'" [disabled]="!canManage()" (click)="onConvert(lead)" title="Convert"></button>
                      <button pButton type="button" class="action-btn danger" icon="pi pi-trash" [disabled]="!canManage()" (click)="onDelete(lead)" title="Delete"></button>
                    </div>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>

          <div class="table-footer">
            <div class="pagination-info">
              Showing <strong>{{ (pageIndex * rows) + 1 }}</strong> to <strong>{{ Math.min((pageIndex + 1) * rows, total()) }}</strong> of <strong>{{ total() }}</strong>
            </div>
            <p-paginator
              [rows]="rows"
              [totalRecords]="total()"
              [rowsPerPageOptions]="[10, 25, 50]"
              [first]="pageIndex * rows"
              (onPageChange)="onPageChange($event)"
              styleClass="custom-paginator"
            ></p-paginator>
          </div>
        </ng-container>
      </ng-container>

      <ng-template #loadingState>
        <div class="skeleton-table">
          <div class="skeleton-row" *ngFor="let _ of [1,2,3,4,5,6,7,8]">
            <div class="skeleton skeleton-checkbox"></div>
            <div class="skeleton skeleton-avatar"></div>
            <div class="skeleton skeleton-text long"></div>
            <div class="skeleton skeleton-badge"></div>
            <div class="skeleton skeleton-text medium"></div>
            <div class="skeleton skeleton-bar"></div>
            <div class="skeleton skeleton-text short"></div>
            <div class="skeleton skeleton-actions"></div>
          </div>
        </div>
      </ng-template>

      <ng-template #emptyState>
        <div class="empty-state">
          <div class="empty-illustration">
            <i class="pi pi-users"></i>
          </div>
          <h3>No leads yet</h3>
          <p>Start building your pipeline by adding your first lead.</p>
          <button pButton type="button" class="btn-primary" [disabled]="!canManage()" (click)="onCreate()">
            <i class="pi pi-plus"></i>
            Add Lead
          </button>
        </div>
      </ng-template>
    </section>
  </div>
</div>

<app-bulk-actions-bar
  [actions]="bulkActions()"
  [selectedItems]="selectedIds()"
  [totalCount]="leads().length"
  (actionClicked)="onBulkAction($event)"
  (clearSelection)="clearSelection()"
  (selectAll)="selectAllFiltered()"
></app-bulk-actions-bar>

<p-dialog
  header="Assign owner"
  [(visible)]="assignDialogVisible"
  [modal]="true"
  [style]="{ width: '360px' }"
>
  <div class="bulk-assign">
    <label>Owner</label>
    <p-select appendTo="body"
      [options]="ownerOptionsForAssign()"
      optionLabel="label"
      optionValue="value"
      [(ngModel)]="assignOwnerId"
      placeholder="Select owner"
      styleClass="w-full"
      [disabled]="!canEditOwnerAssignment()"
    ></p-select>
  </div>
  <ng-template pTemplate="footer">
    <button pButton type="button" class="crm-button crm-button--ghost" label="Cancel" (click)="assignDialogVisible = false"></button>
    <button pButton type="button" class="crm-button crm-button--primary" label="Assign" [disabled]="!assignOwnerId || !canEditOwnerAssignment()" (click)="confirmBulkAssign()"></button>
  </ng-template>
</p-dialog>

<p-dialog
  header="Change status"
  [(visible)]="statusDialogVisible"
  [modal]="true"
  [style]="{ width: '360px' }"
>
  <div class="bulk-assign">
    <label>Status</label>
    <p-select appendTo="body"
      [options]="filteredStatusOptions"
      optionLabel="label"
      optionValue="value"
      [(ngModel)]="bulkStatus"
      placeholder="Select status"
      styleClass="w-full"
    >
      <ng-template pTemplate="item" let-option>
        <div class="status-option" [attr.data-status]="option.value">
          <i class="pi" [ngClass]="option.icon"></i>
          <span>{{ option.label }}</span>
        </div>
      </ng-template>
      <ng-template pTemplate="value" let-option>
        <div class="status-option" *ngIf="option" [attr.data-status]="option.value">
          <i class="pi" [ngClass]="option.icon"></i>
          <span>{{ option.label }}</span>
        </div>
        <span *ngIf="!option" class="status-placeholder">Select status</span>
      </ng-template>
    </p-select>
  </div>
  <ng-template pTemplate="footer">
    <button pButton type="button" class="crm-button crm-button--ghost" label="Cancel" (click)="statusDialogVisible = false"></button>
    <button pButton type="button" class="crm-button crm-button--primary" label="Update" [disabled]="!bulkStatus || !canManage()" (click)="confirmBulkStatusUpdate()"></button>
  </ng-template>
</p-dialog>

<p-dialog
  header="Import leads"
  [(visible)]="importDialogVisible"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{ width: '480px' }"
  (onHide)="closeImport()"
>
  <div class="import-dialog">
    <p class="import-note">
      Upload a CSV with headers. Required column: <strong>Name</strong> or <strong>FirstName</strong>.
    </p>
    <label class="import-upload">
      <p-fileUpload
        mode="basic"
        name="file"
        [auto]="false"
        [customUpload]="true"
        [showUploadButton]="false"
        [showCancelButton]="false"
        [chooseLabel]="importFile?.name || 'Choose CSV file'"
        accept=".csv"
        (onSelect)="onImportFileSelected($event)"
      ></p-fileUpload>
    </label>
    <div class="import-actions">
      <button pButton type="button" class="btn-ghost" (click)="closeImport()">Cancel</button>
      <button pButton type="button" class="btn-primary" [disabled]="!importFile || importing() || !canManage()" (click)="onImport()">
        {{ importing() ? 'Importing...' : 'Import' }}
      </button>
    </div>
    <div class="import-error" *ngIf="importError()">{{ importError() }}</div>
    <div class="import-status" *ngIf="importJob() as job">
      <span>Status: {{ importStatus()?.status || job.status }}</span>
    </div>
    <div class="import-result" *ngIf="importStatus() as result">
      <div class="import-metrics">
        <span>Rows: {{ result.total }}</span>
        <span>Imported: {{ result.imported }}</span>
        <span>Skipped: {{ result.skipped }}</span>
      </div>
      <div class="import-errors" *ngIf="result.errors.length">
        <p>Errors (first 5):</p>
        <ul>
          <li *ngFor="let err of result.errors.slice(0, 5)">
            Row {{ err.rowNumber }}: {{ err.message }}
          </li>
        </ul>
      </div>
    </div>
  </div>
</p-dialog>
