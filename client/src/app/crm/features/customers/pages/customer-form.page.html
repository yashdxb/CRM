
    <div class="customer-form-page">
      <app-breadcrumbs></app-breadcrumbs>
      <!-- Page Header -->
      <header class="page-header">
        <div class="header-content">
          <button pButton type="button" class="back-link p-button-text" routerLink="/app/customers">
            <i class="pi pi-arrow-left"></i>
            <span>Back to customers</span>
          </button>
          <div class="header-title">
            <h1 class="hero-title">
              <span class="title-gradient">{{ isEditMode() ? 'Edit' : 'Create New' }}</span>
              <span class="title-light">Customer</span>
            </h1>
            <p>{{ isEditMode() ? 'Update customer information' : 'Add a new customer to your CRM' }}</p>
            <div class="presence-strip" *ngIf="isEditMode() && presenceUsers().length">
              <span class="presence-label">Viewing now</span>
              <span class="presence-chip" *ngFor="let viewer of presenceUsers()">{{ viewer.displayName }}</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Form Section -->
      <main class="form-container">
        <form class="customer-form" (ngSubmit)="onSave()">
          <section class="related-summary-strip" *ngIf="isEditMode()">
            <div class="summary-chip">
              <span class="chip-label">Contacts</span>
              <span class="chip-value">{{ contactCount() }}</span>
              <span class="chip-meta" *ngIf="latestContactCreatedAt()">
                Last added {{ latestContactCreatedAt() | date: 'MMM d, yyyy' }}
              </span>
            </div>
            <div class="summary-chip">
              <span class="chip-label">Opportunities</span>
              <span class="chip-value">{{ opportunityCount() }}</span>
              <span class="chip-meta" *ngIf="latestOpportunityCreatedAt()">
                Last added {{ latestOpportunityCreatedAt() | date: 'MMM d, yyyy' }}
              </span>
            </div>
          </section>
          <fieldset class="form-fieldset" [disabled]="loading()">
            <section class="form-section">
              <h2 class="section-title">
                <i class="pi pi-user"></i>
                Basic information
              </h2>
              
              <div class="form-grid">
                <div class="field">
                  <label for="customerName">Customer Name <span class="required">*</span></label>
                  <input 
                    pInputText 
                    id="customerName"
                    name="name" 
                    [(ngModel)]="form.name" 
                    required 
                    placeholder="Enter customer name"
                    class="w-full"
                  />
                </div>
                
                <div class="field">
                  <label for="customerStatus">Lifecycle Stage</label>
                  <p-select
                    id="customerStatus"
                    [options]="statusOptions"
                    optionLabel="label"
                    optionValue="value"
                    name="status"
                    [(ngModel)]="form.lifecycleStage"
                    placeholder="Select status"
                    styleClass="w-full"
                  ></p-select>
                </div>
                
                <div class="field">
                  <label for="parentAccountId">Parent account</label>
                  <p-select
                    id="parentAccountId"
                    [options]="parentAccountOptions()"
                    optionLabel="label"
                    optionValue="value"
                    name="parentAccountId"
                    [(ngModel)]="form.parentAccountId"
                    placeholder="Select parent account"
                    styleClass="w-full"
                  ></p-select>
                </div>

                <div class="field">
                  <label for="customerIndustry">Industry</label>
                  <input 
                    pInputText 
                    id="customerIndustry"
                    name="industry" 
                    [(ngModel)]="form.industry" 
                    placeholder="e.g., Technology, Healthcare"
                    class="w-full"
                  />
                </div>

                <div class="field">
                  <label for="customerCompany">Company</label>
                  <input 
                    pInputText 
                    id="customerCompany"
                    name="company" 
                    [(ngModel)]="form.company" 
                    placeholder="Company name"
                    class="w-full"
                  />
                </div>
              </div>
            </section>

            <section class="form-section">
              <h2 class="section-title">
                <i class="pi pi-phone"></i>
                Contact information
              </h2>
              
              <div class="form-grid">
                <div class="field">
                  <label for="customerEmail">Email Address</label>
                  <input 
                    pInputText 
                    id="customerEmail"
                    name="email" 
                    type="email"
                    [(ngModel)]="form.email" 
                    placeholder="customer@example.com"
                    class="w-full"
                  />
                </div>

                <div class="field">
                  <label for="customerPhone">Phone Number</label>
                  <input 
                    pInputText 
                    id="customerPhone"
                    name="phone" 
                    [(ngModel)]="form.phone" 
                    placeholder="+1 (555) 000-0000"
                    class="w-full"
                  />
                </div>
                
                <div class="field">
                  <label for="customerWebsite">Website</label>
                  <input 
                    pInputText 
                    id="customerWebsite"
                    name="website" 
                    [(ngModel)]="form.website" 
                    placeholder="https://example.com"
                    class="w-full"
                  />
                </div>

                <div class="field">
                  <label for="customerAddress">Address</label>
                  <input 
                    pInputText 
                    id="customerAddress"
                    name="address" 
                    [(ngModel)]="form.address" 
                    placeholder="Street address, City, Country"
                    class="w-full"
                  />
                </div>
              </div>
            </section>

            <section class="form-section">
              <h2 class="section-title">
                <i class="pi pi-file-edit"></i>
                Additional information
              </h2>
              
              <div class="field full-width">
                <label for="customerDescription">Notes</label>
                <textarea 
                  pTextarea 
                  id="customerDescription"
                  name="description" 
                  [(ngModel)]="form.description" 
                  rows="4" 
                  placeholder="Add any relevant notes about this customer..."
                  class="w-full"
                ></textarea>
              </div>
            </section>
          </fieldset>

          <footer class="form-actions">
            <button 
              type="button" 
              pButton 
              label="Cancel" 
              class="crm-button crm-button--ghost" 
              routerLink="/app/customers">
            </button>
            <button 
              type="submit" 
              pButton 
              [label]="isEditMode() ? 'Update customer' : 'Create customer'"
              class="crm-button crm-button--primary" 
              [disabled]="!form.name || saving() || loading()">
            </button>
          </footer>
        </form>
      </main>

      <section class="form-container detail-container" *ngIf="isEditMode()">
        <section class="form-section">
          <h2 class="section-title">
            <i class="pi pi-briefcase"></i>
            Customer workspace
          </h2>

          <p-tabs value="timeline">
            <p-tablist>
              <p-tab value="timeline">Timeline</p-tab>
              <p-tab value="notes">Notes</p-tab>
              <p-tab value="related">Related records</p-tab>
              <p-tab value="attachments">Attachments</p-tab>
            </p-tablist>
            <p-tabpanels>
              <p-tabpanel value="timeline">
              <div class="timeline" *ngIf="!timelineLoading(); else timelineLoadingTpl">
                <div class="timeline-item" *ngFor="let activity of activities()">
                  <div class="timeline-type">
                    <span class="type-dot" [attr.data-type]="activity.type">{{ activity.type }}</span>
                  </div>
                  <div class="timeline-body">
                    <div class="timeline-title">{{ activity.subject }}</div>
                    <div class="timeline-meta">
                      <span>{{ activity.createdAtUtc | date: 'MMM d, yyyy · h:mm a' }}</span>
                      <span *ngIf="activity.ownerName">• {{ activity.ownerName }}</span>
                    </div>
                    <div class="timeline-description" *ngIf="activity.description">{{ activity.description }}</div>
                  </div>
                </div>
                <div class="empty-state" *ngIf="!activities().length">No activity yet.</div>
              </div>
              <ng-template #timelineLoadingTpl>
                <div class="empty-state">Loading timeline...</div>
              </ng-template>
              </p-tabpanel>

              <p-tabpanel value="notes">
              <div class="notes">
                <div class="note-editor">
        <textarea 
          pTextarea 
          rows="4" 
          placeholder="Add a note about this customer..." 
          class="w-full"
          [(ngModel)]="noteText"
          [ngModelOptions]="{ standalone: true }"
        ></textarea>
                  <div class="note-actions">
                    <button
                      pButton
                      type="button"
                      label="Add note"
                      icon="pi pi-plus"
                      class="crm-button crm-button--primary"
                      [disabled]="!noteText.trim() || noteSaving()"
                      (click)="addNote()"
                    ></button>
                  </div>
                </div>

                <div class="note-list" *ngIf="notes().length; else notesEmpty">
                  <div class="note-item" *ngFor="let note of notes()">
                    <div class="note-header">
                      <span class="note-title">{{ note.subject }}</span>
                      <span class="note-meta">{{ note.createdAtUtc | date: 'MMM d, yyyy · h:mm a' }}</span>
                    </div>
                    <div class="note-body">{{ note.description }}</div>
                  </div>
                </div>
                <ng-template #notesEmpty>
                  <div class="empty-state">No notes yet.</div>
                </ng-template>
              </div>
              </p-tabpanel>

              <p-tabpanel value="related">
              <div class="related-grid">
                <div class="related-section">
                  <h3>Contacts</h3>
                  <p-table [value]="relatedContactsSorted()" [paginator]="false" [rows]="5" styleClass="compact-table">
                    <ng-template pTemplate="header">
                      <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Owner</th>
                        <th>Created</th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-row>
                      <tr class="clickable-row" [routerLink]="['/app/contacts', row.id, 'edit']">
                        <td>
                          <span class="related-link">{{ row.name }}</span>
                        </td>
                        <td>{{ row.email || '—' }}</td>
                        <td>{{ row.phone || '—' }}</td>
                        <td>{{ row.owner || '—' }}</td>
                        <td>{{ row.createdAt | date: 'MMM d, yyyy' }}</td>
                      </tr>
                    </ng-template>
                  </p-table>
                  <div class="empty-state" *ngIf="!relatedContacts().length">No contacts linked.</div>
                </div>

                <div class="related-section">
                  <h3>Opportunities</h3>
                  <p-table [value]="relatedOpportunitiesSorted()" [paginator]="false" [rows]="5" styleClass="compact-table">
                    <ng-template pTemplate="header">
                      <tr>
                        <th>Name</th>
                        <th>Stage</th>
                        <th>Amount</th>
                        <th>Owner</th>
                        <th>Created</th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-row>
                      <tr class="clickable-row" [routerLink]="['/app/opportunities', row.id, 'edit']">
                        <td>
                          <span class="related-link">{{ row.name }}</span>
                        </td>
                        <td><p-tag [value]="row.stage" severity="info"></p-tag></td>
                        <td>{{ row.amount | currency: row.currency : 'symbol' : '1.0-0' }}</td>
                        <td>{{ row.owner || '—' }}</td>
                        <td>{{ row.createdAtUtc | date: 'MMM d, yyyy' }}</td>
                      </tr>
                    </ng-template>
                  </p-table>
                  <div class="empty-state" *ngIf="!relatedOpportunities().length">No opportunities yet.</div>
                </div>
              </div>
              </p-tabpanel>

              <p-tabpanel value="attachments">
              <div class="attachments">
                <p-fileUpload
                  mode="basic"
                  chooseLabel="Upload file"
                  [customUpload]="true"
                  (uploadHandler)="onAttachmentUpload($event)"
                  [auto]="true"
                ></p-fileUpload>

                <p-table [value]="attachments()" [paginator]="false" [rows]="5" styleClass="compact-table">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>File</th>
                      <th>Uploaded by</th>
                      <th>Size</th>
                      <th></th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-row>
                    <tr>
                      <td>{{ row.fileName }}</td>
                      <td>{{ row.uploadedBy || '—' }}</td>
                      <td>{{ row.size | number }} bytes</td>
                      <td class="table-actions">
                        <button pButton type="button" class="icon-btn" icon="pi pi-download" (click)="downloadAttachment(row)"></button>
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
                <div class="empty-state" *ngIf="!attachments().length">No attachments yet.</div>
              </div>
              </p-tabpanel>
            </p-tabpanels>
          </p-tabs>
        </section>
      </section>
    </div>
  
