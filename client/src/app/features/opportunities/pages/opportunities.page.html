<div class="opportunities crm-workspace crm-shell">
  <!-- PrimeNG Breadcrumb -->
  <app-breadcrumbs></app-breadcrumbs>

  <section class="workspace-hero crm-panel crm-panel--hero">
    <div class="hero-copy">
      <div class="hero-heading">
        <div>
          <p class="hero-eyebrow">Revenue cockpit</p>
          <h1 class="hero-title">Opportunity intelligence</h1>
        </div>
        <div class="hero-health">
          <span>Forecast</span>
          <strong><i class="pi pi-chart-line"></i> Stable</strong>
        </div>
      </div>
      <p class="hero-subtitle">Audit every deal stage with the unified CRM shell—gradient CTAs, glass cards, and consistent routing controls.</p>
      <div class="hero-meta">
        <article>
          <span>Deals in flight</span>
          <strong>{{ metrics().total || '—' }}</strong>
        </article>
        <article>
          <span>Pipeline value</span>
          <strong>{{ metrics().pipelineValue | currency:'USD' }}</strong>
        </article>
        <article>
          <span>Avg. deal size</span>
          <strong>{{ metrics().avgDeal | currency:'USD' }}</strong>
        </article>
      </div>
      <div class="hero-actions">
        <p-button icon="pi pi-download" label="Export" styleClass="crm-button crm-button--ghost" (onClick)="onExport()"></p-button>
        <p-button icon="pi pi-plus" label="New opportunity" styleClass="crm-button crm-button--primary" [disabled]="!canManage()" (onClick)="onCreate()"></p-button>
      </div>
    </div>
    <div class="hero-panels">
      <article class="hero-panel">
        <header>
          <span>Open deals</span>
          <small>Active execution</small>
        </header>
        <strong>{{ metrics().open }}</strong>
        <p>Opportunities before close.</p>
      </article>
      <article class="hero-panel">
        <header>
          <span>Closed won</span>
          <small>This quarter</small>
        </header>
        <strong>{{ metrics().closedWon }}</strong>
        <p>Ready for invoicing.</p>
      </article>
    </div>
  </section>

  <section class="stats-grid crm-stat-grid">
    <article class="stat-card crm-stat-card crm-stat-card--azure">
      <span>Total opportunities</span>
      <strong>{{ metrics().total || '—' }}</strong>
      <small>Across filters</small>
    </article>
    <article class="stat-card crm-stat-card crm-stat-card--teal">
      <span>Open</span>
      <strong>{{ metrics().open }}</strong>
      <small>Active motion</small>
    </article>
    <article class="stat-card crm-stat-card crm-stat-card--indigo">
      <span>Closed won</span>
      <strong>{{ metrics().closedWon }}</strong>
      <small>Move to revenue</small>
    </article>
    <article class="stat-card crm-stat-card crm-stat-card--rose">
      <span>Closed lost</span>
      <strong>{{ metrics().closedLost }}</strong>
      <small>Needs retro</small>
    </article>
    <article class="stat-card crm-stat-card crm-stat-card--amber">
      <span>Pipeline value</span>
      <strong>{{ metrics().pipelineValue | currency:'USD' }}</strong>
      <small>Open forecast</small>
    </article>
    <article class="stat-card crm-stat-card crm-stat-card--violet">
      <span>Weighted forecast</span>
      <strong>{{ metrics().weightedPipeline | currency:'USD' }}</strong>
      <small>Probability adjusted</small>
    </article>
    <article class="stat-card crm-stat-card crm-stat-card--rose">
      <span>Stalled 30+ days</span>
      <strong>{{ metrics().stalled }}</strong>
      <small>Needs attention</small>
    </article>
  </section>

  <section class="filter-bar crm-toolbar">
    <div class="filter-group crm-filter search">
      <span class="p-input-icon-left">
        <i class="pi pi-search"></i>
        <input
          pInputText
          type="search"
          placeholder="Search opportunities"
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearch($event)"
        />
      </span>
    </div>

    <div class="filter-group crm-filter">
      <p-select appendTo="body"
        [options]="stageOptions"
        optionLabel="label"
        optionValue="value"
        [ngModel]="stageFilter === 'all' ? null : stageFilter"
        (ngModelChange)="onStageChange($event || 'all')"
        placeholder="Stage"
      ></p-select>
    </div>

    <div class="filter-group crm-filter pills">
      <span class="pill-label">Quick stages</span>
      <div class="pill-list">
        <button pButton type="button" class="pill" (click)="onStageChange('all')">All</button>
        <button pButton type="button" class="pill" (click)="onStageChange('Prospecting')">Prospecting</button>
        <button pButton type="button" class="pill" (click)="onStageChange('Proposal')">Proposal</button>
        <button pButton type="button" class="pill" (click)="onStageChange('Closed Won')">Closed Won</button>
        <button pButton type="button" class="pill" (click)="onStageChange('Closed Lost')">Closed Lost</button>
      </div>
    </div>

    <div class="filter-group view-toggle">
      <button pButton type="button" class="view-toggle__btn" [class.active]="viewMode() === 'board'" (click)="setViewMode('board')">
        <i class="pi pi-columns"></i>
        Pipeline
      </button>
      <button pButton type="button" class="view-toggle__btn" [class.active]="viewMode() === 'table'" (click)="setViewMode('table')">
        <i class="pi pi-table"></i>
        Table
      </button>
    </div>

    <p-button icon="pi pi-filter-slash" label="Reset" styleClass="crm-button crm-button--text" (onClick)="onStageChange('all')"></p-button>
  </section>

  <section class="views-bar crm-panel">
    <div class="views-select">
      <i class="pi pi-bookmark"></i>
      <p-select appendTo="body"
        [options]="viewOptions()"
        optionLabel="label"
        optionValue="value"
        [ngModel]="selectedViewId()"
        (ngModelChange)="onSelectView($event)"
        placeholder="Saved views"
        styleClass="w-full"
      ></p-select>
    </div>
    <div class="views-save">
      <input pInputText type="text" placeholder="Name this view" [(ngModel)]="viewName" />
      <button pButton type="button" class="crm-button crm-button--ghost crm-button--sm" icon="pi pi-bookmark" label="Save" (click)="onSaveView()"></button>
      <button pButton type="button" class="crm-button crm-button--ghost crm-button--sm" icon="pi pi-trash" label="Delete" [disabled]="!selectedViewId()" (click)="onDeleteView()"></button>
    </div>
  </section>

  <section class="recently-viewed crm-panel" *ngIf="recentOpportunities().length">
    <div class="recently-viewed__header">
      <h3>Recently viewed</h3>
      <span>{{ recentOpportunities().length }} recent</span>
    </div>
    <div class="recently-viewed__list">
      <button pButton type="button" class="recent-item" *ngFor="let item of recentOpportunities()" (click)="openRecent(item)">
        <div class="recent-item__title">{{ item.title }}</div>
        <div class="recent-item__meta">
          {{ item.subtitle || 'Opportunity' }} · {{ item.viewedAt | date:'MMM d, h:mm a' }}
        </div>
      </button>
    </div>
  </section>

  <section class="opportunities__content" *ngIf="viewMode() === 'table'; else pipelineView">
    <div class="table-card crm-panel">
      <header class="list-header">
        <div>
          <div class="list-title">Deals board</div>
          <small>{{ opportunities().length }} {{ opportunities().length === 1 ? 'record' : 'records' }} in view</small>
        </div>
        <div class="list-actions">
          <button pButton type="button" class="crm-button crm-button--ghost crm-button--sm" icon="pi pi-chart-bar" label="Forecast"></button>
          <button pButton type="button" class="crm-button crm-button--primary crm-button--sm" icon="pi pi-plus" label="Add opportunity" [disabled]="!canManage()" (click)="onCreate()"></button>
        </div>
      </header>

      <ng-container *ngIf="!loading(); else loadingState">
        <ng-container *ngIf="opportunities().length; else emptyState">
          <p-table class="crm-table crm-table--highlight" [value]="opportunities()" [tableStyle]="{ 'min-width': '100%' }" [styleClass]="'p-datatable-sm'">
            <ng-template pTemplate="header">
              <tr class="table-header">
                <th pSortableColumn="name">
                  <span>Name</span>
                  <p-sortIcon field="name"></p-sortIcon>
                </th>
                <th pSortableColumn="account">
                  <span>Account</span>
                  <p-sortIcon field="account"></p-sortIcon>
                </th>
                <th pSortableColumn="stage">
                  <span>Stage</span>
                  <p-sortIcon field="stage"></p-sortIcon>
                </th>
                <th pSortableColumn="amount">
                  <span>Amount</span>
                  <p-sortIcon field="amount"></p-sortIcon>
                </th>
                <th pSortableColumn="probability">
                  <span>Probability</span>
                  <p-sortIcon field="probability"></p-sortIcon>
                </th>
                <th>
                  <span>Risk</span>
                </th>
                <th pSortableColumn="closeDate">
                  <span>Close date</span>
                  <p-sortIcon field="closeDate"></p-sortIcon>
                </th>
                <th pSortableColumn="status">
                  <span>Status</span>
                  <p-sortIcon field="status"></p-sortIcon>
                </th>
                <th pSortableColumn="owner">
                  <span>Owner</span>
                  <p-sortIcon field="owner"></p-sortIcon>
                </th>
                <th class="actions">Actions</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row>
              <tr>
                <td class="name">
                  <div class="name__title">{{ row.name }}</div>
                  <small>{{ row.stage }}</small>
                </td>
                <td>{{ row.account }}</td>
                <td>
                  <ng-container *ngIf="!row.stage.startsWith('Closed'); else closedStage">
                    <p-select appendTo="body"
                      [options]="stageOptionsInline"
                      optionLabel="label"
                      optionValue="value"
                      [ngModel]="row.stage"
                      (ngModelChange)="onInlineStageChange(row, $event)"
                      styleClass="inline-select"
                    ></p-select>
                  </ng-container>
                  <ng-template #closedStage>
                    <p-tag [value]="row.stage" severity="info"></p-tag>
                  </ng-template>
                </td>
                <td>{{ row.amount | currency: row.currency }}</td>
                <td>{{ row.probability || 0 }}%</td>
                <td>
                  <span class="risk-pill" *ngIf="isStalled(row)">
                    Stalled {{ stalledAge(row) }}d
                  </span>
                </td>
                <td>{{ row.closeDate | date: 'MMM d, y' }}</td>
                <td><p-tag [value]="row.status" [severity]="statusSeverity(row.status)"></p-tag></td>
                <td>
                  <p-select appendTo="body"
                    [options]="ownerOptionsForAssign()"
                    optionLabel="label"
                    optionValue="value"
                    [ngModel]="row.ownerId"
                    (ngModelChange)="onInlineOwnerChange(row, $event)"
                    placeholder="Owner"
                    styleClass="inline-select"
                  ></p-select>
                </td>
                <td class="actions">
                  <button pButton icon="pi pi-pencil" [disabled]="!canManage()" (click)="$event.stopPropagation(); onEdit(row)"></button>
                  <button pButton icon="pi pi-trash" [disabled]="!canManage()" (click)="$event.stopPropagation(); onDelete(row)"></button>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </ng-container>
      </ng-container>

      <ng-template #loadingState>
        <div class="skeletons">
          <p-skeleton height="1.5rem" *ngFor="let _ of [1,2,3,4,5]"></p-skeleton>
        </div>
      </ng-template>

      <ng-template #emptyState>
        <div class="empty-state">
          <i class="pi pi-briefcase"></i>
          <p>No opportunities match the active filters.</p>
          <button pButton type="button" class="crm-button crm-button--text" label="Reset" (click)="onStageChange('all')"></button>
        </div>
      </ng-template>

      <p-paginator
        [rows]="rows"
        [totalRecords]="total()"
        [rowsPerPageOptions]="[5, 10, 20]"
        [first]="pageIndex * rows"
        (onPageChange)="onPageChange($event)"
        styleClass="opportunities__paginator"
      ></p-paginator>
    </div>
  </section>

  <ng-template #pipelineView>
    <section class="pipeline crm-panel">
      <header class="pipeline__header">
        <div>
          <p class="eyebrow">Kanban</p>
          <h2>Pipeline board</h2>
        </div>
        <small>Drag-style overview of every stage.</small>
      </header>
      <div class="pipeline-board">
        <article class="pipeline-column" *ngFor="let column of pipelineColumns()">
          <header>
            <div>
              <span>{{ column.label }}</span>
              <strong>{{ column.items.length }}</strong>
            </div>
            <small>{{ column.totalValue | currency:'USD' }}</small>
          </header>
          <div class="pipeline-list" *ngIf="column.items.length; else emptyColumn">
            <article class="pipeline-card" *ngFor="let row of column.items">
              <header>
                <div>
                  <strong>{{ row.name }}</strong>
                  <small>{{ row.account }}</small>
                </div>
                <span>{{ row.amount | currency: row.currency }}</span>
              </header>
              <div class="pipeline-card__meta">
                <span><i class="pi pi-user"></i> {{ row.owner || 'Unassigned' }}</span>
                <span><i class="pi pi-calendar"></i> {{ row.closeDate | date: 'MMM d' }}</span>
              </div>
              <div class="pipeline-card__forecast">
                <span>Weighted</span>
                <strong>{{ (row.amount * (row.probability / 100)) | currency: row.currency }}</strong>
              </div>
              <div class="pipeline-card__risk" *ngIf="isStalled(row)">
                <i class="pi pi-exclamation-triangle"></i>
                <span>Stalled {{ stalledAge(row) }}d</span>
              </div>
              <button pButton type="button" class="pipeline-card__history-toggle" (click)="toggleCardHistory(row.id)">
                <i class="pi" [ngClass]="isCardHistoryOpen(row.id) ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
                Stage history
              </button>
              <div class="pipeline-card__history" *ngIf="isCardHistoryOpen(row.id)">
                <ng-container *ngIf="!isCardHistoryLoading(row.id); else historyLoadingInline">
                  <div *ngIf="cardHistoryItems(row.id).length; else historyEmptyInline">
                    <div class="pipeline-card__history-row" *ngFor="let entry of cardHistoryItems(row.id)">
                      <span>{{ entry.stage }}</span>
                      <small>{{ entry.changedAtUtc | date: 'MMM d' }}</small>
                    </div>
                  </div>
                  <ng-template #historyEmptyInline>
                    <span class="pipeline-card__history-empty">No stage changes yet.</span>
                  </ng-template>
                </ng-container>
                <ng-template #historyLoadingInline>
                  <div class="pipeline-card__history-loading">
                    <p-skeleton height="14px" *ngFor="let _ of [0,1]"></p-skeleton>
                  </div>
                </ng-template>
              </div>
              <div class="pipeline-card__reason" *ngIf="row.status !== 'Open' && row.winLossReason">
                <small>Win/Loss notes</small>
                <p>{{ row.winLossReason }}</p>
              </div>
              <p-select appendTo="body"
                [options]="stageOptions"
                optionLabel="label"
                optionValue="value"
                [ngModel]="row.stage"
                (ngModelChange)="onPipelineStageChange(row, $event)"
                placeholder="Move stage"
              ></p-select>
            </article>
          </div>
          <ng-template #emptyColumn>
            <div class="pipeline-column__empty">
              <i class="pi pi-inbox"></i>
              <p>No deals here yet.</p>
            </div>
          </ng-template>
        </article>
      </div>
    </section>
  </ng-template>

  <p-dialog
    header="{{ editingId ? 'Edit opportunity' : 'Add opportunity' }}"
    [(visible)]="dialogVisible"
    [modal]="true"
    [style]="{ width: '520px' }"
    [draggable]="false"
    [resizable]="false"
  >
    <form class="opportunity-form" (ngSubmit)="onSave()">
      <div class="field">
        <label>Name</label>
        <input pInputText name="name" [(ngModel)]="form.name" required placeholder="Opportunity name" />
      </div>
      <div class="field">
        <label>Account</label>
        <p-select appendTo="body"
          [options]="customers()"
          optionLabel="name"
          optionValue="id"
          name="accountId"
          [(ngModel)]="form.accountId"
          placeholder="Select account"
        ></p-select>
      </div>
      <div class="field">
        <label>Stage</label>
        <p-select appendTo="body"
          [options]="stageOptions"
          optionLabel="label"
          optionValue="value"
          name="stage"
          [ngModel]="formStageName"
          (ngModelChange)="onStageSelect($event)"
          placeholder="Select stage"
        ></p-select>
      </div>
      <div class="field">
        <label>Amount</label>
        <p-inputNumber name="amount" [(ngModel)]="form.amount" mode="currency" currency="USD"></p-inputNumber>
      </div>
      <div class="field">
        <label>Expected close</label>
        <p-datepicker name="expectedCloseDate" [(ngModel)]="form.expectedCloseDate"></p-datepicker>
      </div>
      <div class="field">
        <label>Probability (%)</label>
        <input pInputText name="probability" [(ngModel)]="form.probability" type="number" min="0" max="100" />
      </div>
      <div class="field">
        <label>Summary</label>
        <textarea pTextarea name="summary" [(ngModel)]="form.summary" rows="3" placeholder="Notes"></textarea>
      </div>
      <div class="field checkbox">
        <label>
          <p-checkbox [binary]="true" [(ngModel)]="form.isClosed" name="isClosed"></p-checkbox>
          Closed
        </label>
        <label>
          <p-checkbox [binary]="true" [(ngModel)]="form.isWon" name="isWon"></p-checkbox>
          Won
        </label>
      </div>
      <div class="field" *ngIf="form.isClosed">
        <label>Win/Loss reason</label>
        <textarea pTextarea name="winLossReason" [(ngModel)]="form.winLossReason" rows="2" placeholder="Capture the context"></textarea>
        <small class="field-error" *ngIf="winLossError">Win/Loss reason is required when closing.</small>
      </div>

      <section class="stage-history" *ngIf="editingId">
        <div class="stage-history__header">
          <div>
            <p class="eyebrow">Stage history</p>
            <h4>Recent movement</h4>
          </div>
          <span class="stage-history__count">{{ stageHistory().length }} events</span>
        </div>

        <div class="stage-history__body" *ngIf="!historyLoading(); else historyLoadingState">
          <div class="stage-history__list" *ngIf="stageHistory().length; else historyEmptyState">
            <div class="stage-history__item" *ngFor="let entry of stageHistory()">
              <div class="stage-history__dot"></div>
              <div class="stage-history__content">
                <div class="stage-history__title">
                  <span>{{ entry.stage }}</span>
                  <small>{{ entry.changedAtUtc | date: 'MMM d, y • h:mm a' }}</small>
                </div>
                <p *ngIf="entry.changedBy">Updated by {{ entry.changedBy }}</p>
                <p *ngIf="entry.notes">{{ entry.notes }}</p>
              </div>
            </div>
          </div>
          <ng-template #historyEmptyState>
            <p class="stage-history__empty">No stage changes yet.</p>
          </ng-template>
        </div>
        <ng-template #historyLoadingState>
          <div class="stage-history__loading">
            <p-skeleton height="20px" *ngFor="let _ of [0,1,2]"></p-skeleton>
          </div>
        </ng-template>
      </section>

      <div class="dialog-actions">
        <button type="button" pButton label="Cancel" class="crm-button crm-button--ghost" (click)="dialogVisible = false"></button>
        <button type="submit" pButton label="Save" class="crm-button crm-button--primary" [disabled]="!form.name || !canManage()"></button>
      </div>
    </form>
  </p-dialog>

</div>
