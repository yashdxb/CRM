<section class="roles roles-form-page">
  <app-breadcrumbs></app-breadcrumbs>


  <div class="roles__banner">
    <div>
      <p class="roles__eyebrow">Role studio</p>
      <h1>{{ isEditMode() ? 'Edit role' : 'Create role' }}</h1>
      <p>Define what your team can see and do, then lock it down with granular permissions.</p>
    </div>
    <div class="roles__banner-actions">
      <button type="button" pButton label="Back to roles" icon="pi pi-arrow-left" class="p-button-outlined" routerLink="/app/settings/roles"></button>
      <button type="button" pButton label="Invite user" icon="pi pi-user-plus" routerLink="/app/settings/invite"></button>
    </div>
  </div>

  <section class="roles__grid roles__grid--editor">
    <article class="roles__panel roles__panel--editor">
      <header>
        <div>
          <p class="eyebrow">{{ isEditMode() ? 'Editing' : 'New role' }}</p>
          <h2>{{ isEditMode() ? 'Update permissions' : 'Build a new access profile' }}</h2>
        </div>
        <button type="button" pButton label="Cancel" severity="secondary" routerLink="/app/settings/roles"></button>
      </header>

      <form class="roles-form" [formGroup]="roleForm" (ngSubmit)="saveRole()">
        <div class="form-grid">
          <label>
            Role name
            <input pInputText formControlName="name" placeholder="e.g. Channel Partner" [readonly]="isSystemRole()" />
            <small class="field-hint" *ngIf="isSystemRole()">System roles are locked.</small>
          </label>

          <label>
            Description
            <input pInputText formControlName="description" placeholder="Optional context" />
          </label>
        </div>

        <section class="permission-section">
          <div class="permission-header">
            <div>
              <p class="eyebrow">Permissions</p>
              <small class="muted">Toggle the exact CRM capabilities.</small>
            </div>
            <div class="permission-meta">
              <span class="badge">{{ selectedPermissionCount() }} selected</span>
              <small *ngIf="loadingPermissions()" class="muted">Loadingâ€¦</small>
            </div>
          </div>
          <ng-container *ngIf="!loadingPermissions(); else permissionsLoading">
            <div class="permission-columns">
              <span>Screen</span>
              <span>Access</span>
            </div>
            <p-listbox
              formControlName="permissions"
              [options]="permissionCatalog()"
              optionLabel="label"
              optionValue="key"
              [multiple]="true"
              [checkbox]="true"
              [disabled]="roleSaving()"
              [metaKeySelection]="false"
              [listStyle]="{ 'max-height': 'none', 'height': 'auto' }"
              styleClass="permission-listbox"
            >
              <ng-template let-permission pTemplate="item">
                <div class="permission-item">
                  <div class="permission-item__meta">
                    <p class="permission-item__title">{{ permission.label }}</p>
                    <p class="permission-item__desc">{{ permission.description }}</p>
                  </div>
                </div>
              </ng-template>
            </p-listbox>
          </ng-container>
          <ng-template #permissionsLoading>
            <div class="loading-blocks">
              <p-skeleton height="38px" *ngFor="let _ of [0, 1, 2]"></p-skeleton>
            </div>
          </ng-template>
        </section>

        <div class="dialog-actions">
          <button type="button" pButton label="Cancel" severity="secondary" [disabled]="roleSaving()" routerLink="/app/settings/roles"></button>
          <button type="submit" pButton [label]="isEditMode() ? 'Update role' : 'Create role'" [loading]="roleSaving()" [disabled]="!canManageAdmin()"></button>
        </div>
      </form>
    </article>

    <aside class="roles__panel roles__panel--summary">
      <header>
        <div>
          <p class="eyebrow">Overview</p>
          <h2>Role summary</h2>
        </div>
        <span class="status-pill" [ngClass]="isSystemRole() ? 'status-pill--system' : 'status-pill--custom'">
          {{ isSystemRole() ? 'System role' : 'Custom role' }}
        </span>
      </header>
      <div class="summary-body">
        <h3>{{ roleForm.value.name || 'Untitled role' }}</h3>
        <p>{{ roleForm.value.description || 'Define the responsibilities and visibility for this role.' }}</p>
        <div class="summary-metrics">
          <div>
            <span class="metric-value">{{ selectedPermissionCount() }}</span>
            <span class="metric-label">Permissions</span>
          </div>
          <div>
            <span class="metric-value">{{ permissionCatalog().length }}</span>
            <span class="metric-label">Available</span>
          </div>
        </div>
        <div class="summary-note">
          <i class="pi pi-info-circle"></i>
          <span>Keep roles focused. Fewer permissions mean cleaner access control.</span>
        </div>
      </div>
    </aside>
  </section>

</section>
