<section class="assignment-page">
  <div class="page-background">
    <div class="animated-orb orb-1"></div>
    <div class="animated-orb orb-2"></div>
    <div class="animated-orb orb-3"></div>
  </div>

  <div class="page-content">
    <app-breadcrumbs></app-breadcrumbs>

    <header class="page-header">
      <div>
        <span class="eyebrow">Lead routing</span>
        <h1>Lead Assignment Rules</h1>
        <p>Define how new leads are routed across your team.</p>
      </div>
      <button pButton type="button" class="btn-glass" routerLink="/app/settings/users">
        <i class="pi pi-users"></i>
        Team users
      </button>
    </header>

    <div class="layout-grid">
      <div class="glass-card">
        <div class="card-header">
          <div>
            <span class="eyebrow">Rules</span>
            <h2>{{ rules().length }} active configurations</h2>
          </div>
          <button pButton type="button" class="btn-ghost" [disabled]="!canManageLeads()" (click)="resetForm()">New rule</button>
        </div>

        <div class="table-wrapper" *ngIf="!loading(); else loadingState">
          <p-table class="rules-table" *ngIf="rules().length; else emptyState" [value]="rules()">
            <ng-template pTemplate="header">
              <tr>
                <th>Rule</th>
                <th>Type</th>
                <th>Territory</th>
                <th>Assigned user</th>
                <th>Status</th>
                <th></th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-rule>
              <tr (click)="startEdit(rule)">
                <td>
                  <div class="rule-name">{{ rule.name }}</div>
                  <div class="rule-sub" *ngIf="rule.lastAssignedUserName">Last: {{ rule.lastAssignedUserName }}</div>
                </td>
                <td>{{ rule.type }}</td>
                <td>{{ rule.territory || '—' }}</td>
                <td>{{ rule.assignedUserName || '—' }}</td>
                <td>
                  <span class="status-pill" [class.active]="rule.isActive">{{ rule.isActive ? 'Active' : 'Paused' }}</span>
                </td>
                <td class="actions">
                  <button pButton type="button" class="icon-btn" icon="pi pi-pencil" [disabled]="!canManageLeads()" (click)="$event.stopPropagation(); startEdit(rule)"></button>
                  <button pButton type="button" class="icon-btn danger" icon="pi pi-trash" [disabled]="!canManageLeads()" (click)="$event.stopPropagation(); deleteRule(rule)"></button>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>

        <ng-template #emptyState>
          <div class="empty-state">
            <i class="pi pi-sitemap"></i>
            <p>No lead assignment rules yet.</p>
          </div>
        </ng-template>

        <ng-template #loadingState>
          <div class="loading-state">
            <div class="skeleton" *ngFor="let _ of [1,2,3,4]"></div>
          </div>
        </ng-template>
      </div>

      <div class="glass-card">
        <div class="card-header">
          <div>
            <span class="eyebrow">Rule details</span>
            <h2>{{ editingId() ? 'Edit rule' : 'Create rule' }}</h2>
          </div>
        </div>

        <form class="rule-form" (ngSubmit)="saveRule()">
          <div class="field">
            <label>Name</label>
            <input pInputText name="name" [(ngModel)]="form().name" placeholder="e.g. Default round robin" class="w-full" />
          </div>
          <div class="field">
            <label>Type</label>
            <p-select appendTo="body"
              [options]="typeOptions"
              optionLabel="label"
              optionValue="value"
              name="type"
              [(ngModel)]="form().type"
              styleClass="w-full"
            >
              <ng-template pTemplate="item" let-option>
                <div class="option-row" [attr.data-testid]="'lead-rule-type-' + option.value">
                  {{ option.label }}
                </div>
              </ng-template>
            </p-select>
          </div>
          <div class="field" *ngIf="form().type === 'Territory'">
            <label>Territory</label>
            <input pInputText name="territory" [(ngModel)]="form().territory" placeholder="West, EMEA, APAC" class="w-full" />
          </div>
          <div class="field" *ngIf="form().type === 'Territory'">
            <label>Assigned user</label>
            <p-select appendTo="body"
              [options]="ownerOptions()"
              optionLabel="label"
              optionValue="value"
              name="assignedUserId"
              [(ngModel)]="form().assignedUserId"
              placeholder="Select owner"
              styleClass="w-full"
            >
              <ng-template pTemplate="item" let-option>
                <div class="option-row" [attr.data-testid]="'lead-rule-owner-' + option.value">
                  {{ option.label }}
                </div>
              </ng-template>
            </p-select>
          </div>
          <label class="toggle-field">
            <p-checkbox [binary]="true" [(ngModel)]="form().isActive" name="isActive"></p-checkbox>
            <span>Active</span>
          </label>

          <div class="form-actions">
            <button pButton type="button" class="btn-ghost" [disabled]="!canManageLeads()" (click)="resetForm()">Reset</button>
            <button pButton type="submit" class="btn-primary" [disabled]="!canSave() || !canManageLeads()">Save rule</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>
